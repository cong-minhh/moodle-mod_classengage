/**
 * Student quiz interface with real-time updates
 *
 * SSE-only mode: Receives question broadcasts and session state updates
 * exclusively via Server-Sent Events. api.php is used only for
 * answer submissions and session operations.
 *
 * Requirements: 2.4, 4.5, 8.5
 *
 * @module     mod_classengage/quiz
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/quiz",["jquery","core/ajax","core/notification","core/str","mod_classengage/connection_manager","mod_classengage/client_cache"],(function($,Ajax,Notification,Str,ConnectionManager,ClientCache){var STATE_PAUSED="paused",STATE_COMPLETED="completed",Quiz={cmid:null,sessionId:null,currentQuestion:null,currentQuestionId:null,pollingTimer:null,countdownTimer:null,isOnline:!0,pendingSubmission:null,strings:{},answeredQuestions:{},timerState:{serverTimeRemaining:0,serverTimestamp:0,clientStartTime:0,isRunning:!1,isPaused:!1,lastSyncTime:0},init:function(options){var cmid,sessionid,pollinginterval,timelimit,timeremaining,questionid,hasanswered,self=this;return"object"==typeof options&&null!==options?(cmid=options.cmid,sessionid=options.sessionid,pollinginterval=options.pollinginterval,timelimit=options.timelimit||0,timeremaining=options.timeremaining||0,questionid=options.questionid||0,hasanswered=options.hasanswered||!1):(cmid=arguments[0],sessionid=arguments[1],pollinginterval=arguments[2],timelimit=0,timeremaining=0,questionid=0,hasanswered=!1),this.cmid=cmid,this.sessionId=sessionid,this.currentQuestionId=questionid,questionid>0&&hasanswered&&(this.answeredQuestions[questionid]=!0),this.loadStrings().then((function(){return ClientCache.init({maxRetries:3,retryDelay:2e3})})).then((function(){return ClientCache.setConnectionManager(ConnectionManager.getInstance()),ConnectionManager.init(sessionid,{pollInterval:pollinginterval||2e3})})).then((function(){return self.setupEventHandlers(),self.setupConnectionHandlers(),self.setupOfflineIndicator(),$(document).on("click",".submit-answer-btn",(function(){self.submitAnswer()})),$(document).on("touchend",".quiz-option",(function(e){e.preventDefault(),$(this).find('input[type="radio"]').prop("checked",!0),$(this).addClass("selected").siblings().removeClass("selected")})),timeremaining>0&&timelimit>0&&self.startLocalCountdown(timeremaining),$("#quiz-status").removeClass("d-none").text("Connected"),setTimeout((function(){$("#quiz-status").addClass("d-none")}),2e3),null})).catch((function(error){console.error("Quiz initialization error:",error),self.startLegacyPolling(pollinginterval)}))},loadStrings:function(){var self=this;return Str.get_strings([{key:"answersubmitted",component:"mod_classengage"},{key:"correct",component:"mod_classengage"},{key:"incorrect",component:"mod_classengage"},{key:"correctanswer",component:"mod_classengage"},{key:"waitingnextquestion",component:"mod_classengage"},{key:"quizcompleted",component:"mod_classengage"},{key:"alreadyanswered",component:"mod_classengage"},{key:"selectanswer",component:"mod_classengage"},{key:"error",component:"core"},{key:"offline",component:"mod_classengage"},{key:"reconnecting",component:"mod_classengage"},{key:"connectionrestored",component:"mod_classengage"},{key:"submittingoffline",component:"mod_classengage"},{key:"pendingsubmissions",component:"mod_classengage"}]).then((function(strings){return self.strings={answersubmitted:strings[0],correct:strings[1],incorrect:strings[2],correctanswer:strings[3],waitingnextquestion:strings[4],quizcompleted:strings[5],alreadyanswered:strings[6],selectanswer:strings[7],error:strings[8],offline:strings[9]||"Offline - responses will be saved locally",reconnecting:strings[10]||"Reconnecting...",connectionrestored:strings[11]||"Connection restored",submittingoffline:strings[12]||"Saving response offline...",pendingsubmissions:strings[13]||"Pending submissions"},null})).catch((function(){self.strings={answersubmitted:"Answer submitted!",correct:"Correct!",incorrect:"Incorrect",correctanswer:"Correct Answer",waitingnextquestion:"Waiting for next question...",quizcompleted:"Quiz completed!",alreadyanswered:"You have already answered this question",selectanswer:"Please select an answer",error:"Error",offline:"Offline - responses will be saved locally",reconnecting:"Reconnecting...",connectionrestored:"Connection restored",submittingoffline:"Saving response offline...",pendingsubmissions:"Pending submissions"}}))},setupConnectionHandlers:function(){var self=this;ConnectionManager.on("statuschange",(function(data){self.handleConnectionStatusChange(data)})),ConnectionManager.on("state_update",(function(data){self.handleStateUpdate(data)})),ConnectionManager.on("question_broadcast",(function(data){self.handleQuestionBroadcast(data)})),ConnectionManager.on("session_started",(function(data){self.handleSessionStarted(data)})),ConnectionManager.on("session_paused",(function(data){self.handleSessionPaused(data)})),ConnectionManager.on("session_resumed",(function(data){self.handleSessionResumed(data)})),ConnectionManager.on("session_completed",(function(data){self.handleSessionCompleted(data)})),ConnectionManager.on("timer_sync",(function(data){self.syncServerTime(data)})),ConnectionManager.on("reconnected",(function(){self.handleReconnected()})),ConnectionManager.on("disconnected",(function(){self.handleDisconnected()}))},setupEventHandlers:function(){var self=this;ClientCache.on("submitted",(function(data){self.handleCachedResponseSubmitted(data)})),ClientCache.on("retrying",(function(data){self.showNotification("info",self.strings.pendingsubmissions+": "+data.count)})),ClientCache.on("retryComplete",(function(data){var successCount=data.results.filter((function(r){return r.success})).length;successCount>0&&self.showNotification("success",successCount+" cached response(s) submitted")}))},setupOfflineIndicator:function(){if(0===$("#offline-indicator").length){var indicator=$('<div id="offline-indicator" class="offline-indicator" style="display: none;"><span class="offline-icon">&#9888;</span><span class="offline-text"></span><span class="pending-count"></span></div>');$("#quiz-status").after(indicator)}var self=this;window.addEventListener("online",(function(){self.handleOnlineStatusChange(!0)})),window.addEventListener("offline",(function(){self.handleOnlineStatusChange(!1)})),this.isOnline=navigator.onLine,this.updateOfflineIndicator()},handleOnlineStatusChange:function(online){this.isOnline=online,this.updateOfflineIndicator(),online&&ConnectionManager.reconnect().catch((function(){}))},handleConnectionStatusChange:function(data){var status=data.status,transport=data.transport;status===ConnectionManager.STATUS.CONNECTED?(this.isOnline=!0,this.updateOfflineIndicator(),this.updateTransportIndicator(transport)):status===ConnectionManager.STATUS.RECONNECTING?this.showReconnectingIndicator():status===ConnectionManager.STATUS.DISCONNECTED&&(this.isOnline=!1,this.updateOfflineIndicator())},updateOfflineIndicator:function(){var indicator=$("#offline-indicator"),textSpan=indicator.find(".offline-text"),pendingSpan=indicator.find(".pending-count");this.isOnline?indicator.hide():(textSpan.text(this.strings.offline),indicator.removeClass("reconnecting").addClass("offline").show());var stats=ClientCache.getStats();stats.pending>0?(pendingSpan.text(" ("+stats.pending+" pending)").show(),indicator.show()):pendingSpan.hide()},showReconnectingIndicator:function(){var indicator=$("#offline-indicator");indicator.find(".offline-text").text(this.strings.reconnecting),indicator.removeClass("offline").addClass("reconnecting").show()},updateTransportIndicator:function(transport){var transportIndicator=$("#transport-indicator");0===transportIndicator.length&&(transportIndicator=$('<span id="transport-indicator" class="transport-indicator"></span>'),$("#quiz-status").append(transportIndicator)),transport===ConnectionManager.TRANSPORT.SSE?transportIndicator.text("Real-time").addClass("realtime"):transport===ConnectionManager.TRANSPORT.POLLING&&transportIndicator.text("Polling").removeClass("realtime")},handleStateUpdate:function(data){data.timelimit>0&&void 0!==data.timeremaining&&this.syncServerTime({timerremaining:data.timeremaining,timestamp:data.timestamp||Date.now()/1e3}),data.question&&this.updateQuestionDisplay({success:!0,status:data.status,question:data.question}),data.status===STATE_COMPLETED?this.handleSessionCompleted(data):data.status===STATE_PAUSED&&this.handleSessionPaused(data)},handleQuestionBroadcast:function(data){var question=data.question,questionId=question.id||data.questionid;questionId&&this.currentQuestionId!==questionId&&(this.currentQuestionId=questionId),questionId&&this.answeredQuestions[questionId]&&(question.answered=!0),this.currentQuestion=question,this.displayQuestion(question);var timelimit=data.timelimit||question&&question.timelimit||0;timelimit>0&&!question.answered&&this.startLocalCountdown(timelimit)},handleSessionStarted:function(data){$("#quiz-status").removeClass("alert-warning").addClass("alert-info"),data.question&&(this.currentQuestion=data.question,this.displayQuestion(data.question))},handleSessionPaused:function(data){var container=$("#question-container");container.find(".submit-answer-btn").prop("disabled",!0),this.showNotification("warning","Quiz paused by instructor"),0===$(".paused-overlay").length&&container.append('<div class="paused-overlay"><span>Quiz Paused</span></div>'),this.pauseLocalCountdown(),void 0!==data.timerRemaining&&(this.pausedTimerRemaining=data.timerRemaining)},handleSessionResumed:function(data){var container=$("#question-container");container.find(".submit-answer-btn").prop("disabled",!1),container.find(".paused-overlay").remove(),this.showNotification("info","Quiz resumed"),void 0!==data.timerRemaining?this.resumeLocalCountdown(data.timerRemaining):this.resumeLocalCountdown()},handleSessionCompleted:function(data){var container=$("#question-container"),statusDiv=$("#quiz-status");statusDiv.removeClass("alert-info").addClass("alert-success");var scoreText=void 0!==data.score?" Your score: "+data.score:"";statusDiv.html(this.strings.quizcompleted+scoreText),container.html('<div class="alert alert-success"><h4>'+this.strings.quizcompleted+"</h4>"+(void 0!==data.score?"<p>Your score: "+data.score+"</p>":"")+"</div>"),this.stopPolling(),ConnectionManager.disconnect()},handleReconnected:function(){this.isOnline=!0,this.updateOfflineIndicator(),this.showNotification("success",this.strings.connectionrestored),ConnectionManager.send("getstatus",{sessionid:this.sessionId}).then(function(response){return response.success&&response.session&&this.handleStateUpdate(response.session),null}.bind(this)).catch((function(){}))},handleDisconnected:function(){this.isOnline=!1,this.updateOfflineIndicator()},handleCachedResponseSubmitted:function(data){this.showNotification("success","Cached response submitted: "+data.id),this.updateOfflineIndicator()},submitAnswer:function(){var self=this,selectedAnswer=$('input[name="answer"]:checked').val();if(selectedAnswer){if(this.currentQuestion){var questionId=this.currentQuestion.id,clientTimestamp=Date.now();this.showOptimisticSubmission(),$(".submit-answer-btn").prop("disabled",!0),this.isOnline&&ConnectionManager.getStatus().connected?ConnectionManager.send("submitanswer",{sessionid:this.sessionId,questionid:questionId,answer:selectedAnswer,clienttimestamp:clientTimestamp}).then((function(response){return self.handleSubmissionResponse(response),null})).catch((function(error){self.submitOffline(questionId,selectedAnswer,clientTimestamp),console.warn("Submission failed, cached offline:",error)})):this.submitOffline(questionId,selectedAnswer,clientTimestamp)}}else Notification.alert(this.strings.error,this.strings.selectanswer)},showOptimisticSubmission:function(){var container=$("#question-container");container.addClass("submitting");var feedbackDiv=container.find(".optimistic-feedback");0===feedbackDiv.length&&(feedbackDiv=$('<div class="optimistic-feedback"><span class="spinner"></span> Submitting...</div>'),container.find(".submit-answer-btn").after(feedbackDiv)),feedbackDiv.show()},submitOffline:function(questionId,answer,clientTimestamp){var self=this;this.showNotification("info",this.strings.submittingoffline),ClientCache.storeResponse({sessionId:this.sessionId,questionId:questionId,answer:answer,clientTimestamp:clientTimestamp}).then((function(){return self.showOfflineSubmissionConfirmation(),self.updateOfflineIndicator(),null})).catch((function(error){console.error("Failed to cache response:",error),Notification.exception({message:"Failed to save response offline"}),$(".submit-answer-btn").prop("disabled",!1)}))},showOfflineSubmissionConfirmation:function(){var container=$("#question-container");container.removeClass("submitting"),container.find(".optimistic-feedback").remove(),container.html('<div class="alert alert-info"><h4>'+this.strings.answersubmitted+"</h4><p>"+this.strings.offline+"</p><p>"+this.strings.waitingnextquestion+"</p></div>")},handleSubmissionResponse:function(response){var container=$("#question-container");if(container.removeClass("submitting"),container.find(".optimistic-feedback").remove(),response.success){this.currentQuestion&&this.currentQuestion.id&&(this.answeredQuestions[this.currentQuestion.id]=!0);var message=response.iscorrect?this.strings.correct:this.strings.incorrect,html='<div class="alert alert-'+(response.iscorrect?"success":"warning")+'"><h4>'+message+"</h4>";response.correctanswer&&(html+="<p>"+this.strings.correctanswer+": "+response.correctanswer+"</p>"),response.islate&&(html+='<p class="text-muted"><em>Response recorded as late</em></p>'),html+="<p>"+this.strings.waitingnextquestion+"</p></div>",container.html(html),this.showVisualConfirmation(response.iscorrect)}else{var errorMsg=response.error||"";-1!==errorMsg.toLowerCase().indexOf("already")||-1!==errorMsg.toLowerCase().indexOf("duplicate")?container.html('<div class="alert alert-info">'+this.strings.alreadyanswered+"</div>"):-1!==errorMsg.toLowerCase().indexOf("not active")?container.html('<div class="alert alert-warning">Session is not active</div>'):(this.showNotification("error",errorMsg||"Error submitting answer"),$(".submit-answer-btn").prop("disabled",!1))}},showVisualConfirmation:function(isCorrect){var overlay=$('<div class="submission-confirmation '+(isCorrect?"confirmation-correct":"confirmation-incorrect")+'"><span class="confirmation-icon">'+(isCorrect?"✓":"✗")+"</span></div>");$("body").append(overlay),setTimeout((function(){overlay.addClass("fade-out"),setTimeout((function(){overlay.remove()}),300)}),500)},showNotification:function(type,message){var notificationArea=$("#quiz-notifications");0===notificationArea.length&&(notificationArea=$('<div id="quiz-notifications" class="quiz-notifications"></div>'),$("#quiz-status").before(notificationArea));var notification=$('<div class="alert '+("alert-"+("error"===type?"danger":type))+' notification-toast">'+message+"</div>");notificationArea.append(notification),setTimeout((function(){notification.fadeOut((function(){$(this).remove()}))}),3e3)},updateQuestionDisplay:function(response){var container=$("#question-container"),statusDiv=$("#quiz-status");if(!response.success||"active"!==response.status)return container.html(""),void("completed"===response.status?(statusDiv.removeClass("alert-info").addClass("alert-success"),statusDiv.html(this.strings.quizcompleted),this.stopPolling()):"paused"===response.status?statusDiv.html("Quiz is paused"):statusDiv.html(this.strings.waitingnextquestion));var question=response.question;question?(null!==this.currentQuestion&&this.currentQuestion.id===question.id||(this.currentQuestion=question,this.displayQuestion(question)),this.updateTimer(question.timeremaining),statusDiv.html("Question "+question.number+" of "+question.total)):container.html("<p>"+this.strings.waitingnextquestion+"</p>")},displayQuestion:function(question){var html='<div class="question-text mb-4">';if(html+="<h4>"+question.text+"</h4>",html+="</div>",question.answered)html+='<div class="alert alert-info">'+this.strings.alreadyanswered+"</div>";else{html+='<form id="answer-form">',html+='<div class="question-options">';for(var i=0;i<question.options.length;i++){var option=question.options[i];html+='<div class="quiz-option" data-option="'+option.key+'">',html+='<label class="quiz-option-label">',html+='<input type="radio" name="answer" value="'+option.key+'" required> ',html+='<span class="option-key">'+option.key+"</span>",html+='<span class="option-text">'+option.text+"</span>",html+="</label>",html+="</div>"}html+="</div>",html+='<button type="button" class="btn btn-primary btn-lg submit-answer-btn mt-3">',html+=(this.strings.answersubmitted,"Submit Answer"),html+="</button>",html+="</form>"}$("#question-container").html(html)},updateTimerDisplay:function(seconds){var display=$("#timer-display");if(seconds<=0)return display.text("0:00"),void display.removeClass("warning").addClass("danger");var minutes=Math.floor(seconds/60),secs=Math.floor(seconds%60),timeStr=minutes+":"+(secs<10?"0":"")+secs;display.text(timeStr),seconds<=10?display.removeClass("warning").addClass("danger"):seconds<=30?display.removeClass("danger").addClass("warning"):display.removeClass("warning danger")},startLocalCountdown:function(seconds){var self=this;this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null),this.timerState.serverTimeRemaining=seconds,this.timerState.clientStartTime=Date.now(),this.timerState.isRunning=!0,this.timerState.isPaused=!1,this.updateTimerDisplay(seconds),this.countdownTimer=setInterval((function(){if(self.timerState.isRunning&&!self.timerState.isPaused){var clientElapsed=(Date.now()-self.timerState.clientStartTime)/1e3,remaining=Math.max(0,self.timerState.serverTimeRemaining-clientElapsed);self.updateTimerDisplay(remaining),remaining<=0&&self.stopLocalCountdown()}}),100)},stopLocalCountdown:function(){this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null),this.timerState.isRunning=!1},pauseLocalCountdown:function(){this.timerState.isPaused=!0;var clientElapsed=(Date.now()-this.timerState.clientStartTime)/1e3;this.timerState.serverTimeRemaining=Math.max(0,this.timerState.serverTimeRemaining-clientElapsed),this.timerState.clientStartTime=Date.now()},resumeLocalCountdown:function(seconds){void 0!==seconds&&(this.timerState.serverTimeRemaining=seconds),this.timerState.clientStartTime=Date.now(),this.timerState.isPaused=!1},syncServerTime:function(data){var serverRemaining=data.timerremaining,serverTimestamp=data.timestamp,clientElapsed=(Date.now()-this.timerState.clientStartTime)/1e3,clientRemaining=Math.max(0,this.timerState.serverTimeRemaining-clientElapsed),drift=Math.abs(serverRemaining-clientRemaining);(drift>2||!this.timerState.isRunning)&&(console.log("Timer sync: correcting drift of",drift.toFixed(1),"seconds"),this.timerState.serverTimeRemaining=serverRemaining,this.timerState.clientStartTime=Date.now(),this.timerState.serverTimestamp=serverTimestamp),this.timerState.lastSyncTime=Date.now(),!this.timerState.isRunning&&serverRemaining>0&&this.startLocalCountdown(serverRemaining)},updateTimer:function(seconds){null!=seconds&&(this.timerState.isRunning?this.syncServerTime({timerremaining:seconds,timestamp:Date.now()/1e3}):this.startLocalCountdown(seconds))},startLegacyPolling:function(){this.showNotification("error","SSE connection required. Please ensure your browser supports Server-Sent Events.")},getCurrentQuestion:function(){var self=this;ConnectionManager.send("getstatus",{sessionid:this.sessionId}).then((function(response){return response&&response.success&&response.session&&self.handleStateUpdate(response.session),null})).catch((function(){}))},stopPolling:function(){this.pollingTimer&&(clearInterval(this.pollingTimer),this.pollingTimer=null),this.countdownTimer&&(clearInterval(this.countdownTimer),this.countdownTimer=null)}};return{init:function(cmid,sessionid,pollinginterval){return Quiz.init(cmid,sessionid,pollinginterval)}}}));

//# sourceMappingURL=quiz.min.js.map