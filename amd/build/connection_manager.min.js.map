{"version":3,"file":"connection_manager.min.js","sources":["../src/connection_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Connection Manager for real-time quiz communication\r\n *\r\n * Provides dual-transport support with SSE (Server-Sent Events) as primary\r\n * and HTTP polling as fallback. Handles automatic reconnection, heartbeat\r\n * management, and transport switching.\r\n *\r\n * Requirements: 6.1, 6.2, 6.3, 6.4, 6.5\r\n *\r\n * @module     mod_classengage/connection_manager\r\n * @copyright  2025 Danielle\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery'], function($) {\r\n\r\n    /**\r\n     * Connection status constants\r\n     * @type {Object}\r\n     */\r\n    var STATUS = {\r\n        DISCONNECTED: 'disconnected',\r\n        CONNECTING: 'connecting',\r\n        CONNECTED: 'connected',\r\n        RECONNECTING: 'reconnecting'\r\n    };\r\n\r\n    /**\r\n     * Transport type constants\r\n     * @type {Object}\r\n     */\r\n    var TRANSPORT = {\r\n        SSE: 'sse',\r\n        POLLING: 'polling',\r\n        OFFLINE: 'offline'\r\n    };\r\n\r\n    /**\r\n     * Default configuration options\r\n     * @type {Object}\r\n     */\r\n    var DEFAULTS = {\r\n        sseEndpoint: '/mod/classengage/sse_handler.php',\r\n        pollEndpoint: '/mod/classengage/ajax.php',\r\n        pollInterval: 2000, // 2 seconds max (Requirement 6.2)\r\n        sseRetryAttempts: 3, // 3 attempts before fallback (Requirement 6.3)\r\n        heartbeatInterval: 30000, // 30 seconds\r\n        reconnectDelay: 1000, // Initial reconnect delay\r\n        maxReconnectDelay: 30000, // Max reconnect delay\r\n        connectionTimeout: 10000 // Connection timeout\r\n    };\r\n\r\n    /**\r\n     * Connection Manager constructor\r\n     * @constructor\r\n     */\r\n    function ConnectionManager() {\r\n        this.sessionId = null;\r\n        this.connectionId = null;\r\n        this.options = $.extend({}, DEFAULTS);\r\n\r\n        // State tracking\r\n        this.status = STATUS.DISCONNECTED;\r\n        this.transport = TRANSPORT.OFFLINE;\r\n        this.latency = 0;\r\n        this.lastHeartbeat = 0;\r\n\r\n        // SSE connection\r\n        this.eventSource = null;\r\n        this.sseAttempts = 0;\r\n\r\n        // Polling\r\n        this.pollingTimer = null;\r\n        this.lastEventId = 0;\r\n\r\n        // Heartbeat\r\n        this.heartbeatTimer = null;\r\n\r\n        // Reconnection\r\n        this.reconnectTimer = null;\r\n        this.reconnectDelay = DEFAULTS.reconnectDelay;\r\n\r\n        // Event handlers\r\n        this.eventHandlers = {};\r\n\r\n        // Request tracking for latency calculation\r\n        this.pendingRequests = {};\r\n    }\r\n\r\n    /**\r\n     * Initialize connection with session\r\n     *\r\n     * @param {number} sessionId Session ID to connect to\r\n     * @param {Object} options Configuration options\r\n     * @return {Promise} Resolves when connected\r\n     */\r\n    ConnectionManager.prototype.init = function(sessionId, options) {\r\n        var self = this;\r\n\r\n        this.sessionId = sessionId;\r\n        this.options = $.extend({}, DEFAULTS, options || {});\r\n        this.connectionId = this.generateConnectionId();\r\n\r\n        self.status = STATUS.CONNECTING;\r\n        self.emit('statuschange', {status: self.status});\r\n\r\n        // Try SSE first (Requirement 6.3)\r\n        return self.connectSSE()\r\n            .catch(function() {\r\n                // SSE failed, fall back to polling (Requirement 6.1)\r\n                return self.startPolling();\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Generate a unique connection ID\r\n     *\r\n     * @return {string} Connection ID\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.generateConnectionId = function() {\r\n        return 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\r\n    };\r\n\r\n    /**\r\n     * Connect using Server-Sent Events\r\n     *\r\n     * @return {Promise} Resolves when SSE connected\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.connectSSE = function() {\r\n        var self = this;\r\n\r\n        return new Promise(function(resolve, reject) {\r\n            // Check if SSE is supported\r\n            if (typeof EventSource === 'undefined') {\r\n                self.sseAttempts = self.options.sseRetryAttempts;\r\n                reject(new Error('SSE not supported'));\r\n                return;\r\n            }\r\n\r\n            self.sseAttempts++;\r\n\r\n            var url = M.cfg.wwwroot + self.options.sseEndpoint +\r\n                '?sessionid=' + self.sessionId +\r\n                '&connectionid=' + encodeURIComponent(self.connectionId) +\r\n                '&lastEventId=' + self.lastEventId;\r\n\r\n            try {\r\n                self.eventSource = new EventSource(url);\r\n            } catch (e) {\r\n                if (self.sseAttempts < self.options.sseRetryAttempts) {\r\n                    setTimeout(function() {\r\n                        self.connectSSE().then(resolve).catch(reject);\r\n                    }, 1000);\r\n                } else {\r\n                    reject(new Error('SSE connection failed'));\r\n                }\r\n                return;\r\n            }\r\n\r\n            var connectionTimeout = setTimeout(function() {\r\n                if (self.status !== STATUS.CONNECTED) {\r\n                    self.closeSSE();\r\n                    if (self.sseAttempts < self.options.sseRetryAttempts) {\r\n                        self.connectSSE().then(resolve).catch(reject);\r\n                    } else {\r\n                        reject(new Error('SSE connection timeout'));\r\n                    }\r\n                }\r\n            }, self.options.connectionTimeout);\r\n\r\n            self.eventSource.onopen = function() {\r\n                // Connection opened, wait for 'connected' event\r\n            };\r\n\r\n            self.eventSource.onerror = function() {\r\n                clearTimeout(connectionTimeout);\r\n                self.closeSSE();\r\n\r\n                if (self.sseAttempts < self.options.sseRetryAttempts) {\r\n                    setTimeout(function() {\r\n                        self.connectSSE().then(resolve).catch(reject);\r\n                    }, 1000);\r\n                } else {\r\n                    reject(new Error('SSE connection failed after ' + self.sseAttempts + ' attempts'));\r\n                }\r\n            };\r\n\r\n            // Handle connected event\r\n            self.eventSource.addEventListener('connected', function(event) {\r\n                clearTimeout(connectionTimeout);\r\n                var data = JSON.parse(event.data);\r\n                self.connectionId = data.connectionid;\r\n                self.status = STATUS.CONNECTED;\r\n                self.transport = TRANSPORT.SSE;\r\n                self.sseAttempts = 0;\r\n                self.reconnectDelay = DEFAULTS.reconnectDelay;\r\n                self.lastEventId = parseInt(event.lastEventId) || 0;\r\n\r\n                self.startHeartbeat();\r\n                self.emit('statuschange', {status: self.status, transport: self.transport});\r\n                self.emit('connected', data);\r\n                resolve();\r\n            });\r\n\r\n            // Register SSE event handlers\r\n            self.registerSSEHandlers();\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Register handlers for SSE events\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.registerSSEHandlers = function() {\r\n        var self = this;\r\n\r\n        if (!this.eventSource) {\r\n            return;\r\n        }\r\n\r\n        var events = [\r\n            'session_started',\r\n            'session_paused',\r\n            'session_resumed',\r\n            'session_completed',\r\n            'session_ended',\r\n            'question_broadcast',\r\n            'timer_sync',\r\n            'reconnect',\r\n            'error'\r\n        ];\r\n\r\n        events.forEach(function(eventType) {\r\n            self.eventSource.addEventListener(eventType, function(event) {\r\n                self.lastEventId = parseInt(event.lastEventId) || self.lastEventId;\r\n                var data = JSON.parse(event.data);\r\n                self.emit(eventType, data);\r\n\r\n                // Handle reconnect request from server\r\n                if (eventType === 'reconnect') {\r\n                    self.handleReconnectRequest(data);\r\n                }\r\n\r\n                // Handle session end\r\n                if (eventType === 'session_completed' || eventType === 'session_ended') {\r\n                    self.disconnect();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Close SSE connection\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.closeSSE = function() {\r\n        if (this.eventSource) {\r\n            this.eventSource.close();\r\n            this.eventSource = null;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Start HTTP polling fallback\r\n     *\r\n     * @return {Promise} Resolves when polling started\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.startPolling = function() {\r\n        var self = this;\r\n\r\n        return new Promise(function(resolve, reject) {\r\n            // First, do a reconnect call to register connection and get state\r\n            self.pollReconnect()\r\n                .then(function(response) {\r\n                    if (response.success) {\r\n                        self.connectionId = response.connectionid;\r\n                        self.status = STATUS.CONNECTED;\r\n                        self.transport = TRANSPORT.POLLING;\r\n                        self.reconnectDelay = DEFAULTS.reconnectDelay;\r\n\r\n                        self.startHeartbeat();\r\n                        self.startPollingLoop();\r\n\r\n                        self.emit('statuschange', {status: self.status, transport: self.transport});\r\n                        self.emit('connected', response);\r\n                        resolve();\r\n                    } else {\r\n                        reject(new Error(response.error || 'Polling connection failed'));\r\n                    }\r\n                    return null;\r\n                })\r\n                .catch(function(error) {\r\n                    reject(error);\r\n                });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Start the polling loop\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.startPollingLoop = function() {\r\n        var self = this;\r\n\r\n        this.stopPolling();\r\n\r\n        // Ensure polling interval doesn't exceed 2 seconds (Requirement 6.2)\r\n        var interval = Math.min(this.options.pollInterval, 2000);\r\n\r\n        this.pollingTimer = setInterval(function() {\r\n            self.poll();\r\n        }, interval);\r\n\r\n        // Do initial poll\r\n        this.poll();\r\n    };\r\n\r\n    /**\r\n     * Perform a single poll request\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.poll = function() {\r\n        var self = this;\r\n        var startTime = Date.now();\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + this.options.pollEndpoint,\r\n            method: 'POST',\r\n            data: {\r\n                action: 'getstatus',\r\n                sessionid: this.sessionId,\r\n                connectionid: this.connectionId,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            dataType: 'json',\r\n            timeout: this.options.connectionTimeout\r\n        })\r\n        .done(function(response) {\r\n            self.latency = Date.now() - startTime;\r\n\r\n            if (response.success) {\r\n                // Emit session state update\r\n                if (response.session) {\r\n                    self.emit('state_update', response.session);\r\n\r\n                    // Check for status changes\r\n                    if (response.session.status === 'completed') {\r\n                        self.emit('session_completed', response.session);\r\n                        self.disconnect();\r\n                    }\r\n                }\r\n            }\r\n        })\r\n        .fail(function() {\r\n            self.handleConnectionError();\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Poll for reconnection\r\n     *\r\n     * @return {Promise} Resolves with reconnect response\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.pollReconnect = function() {\r\n        var self = this;\r\n\r\n        return new Promise(function(resolve, reject) {\r\n            $.ajax({\r\n                url: M.cfg.wwwroot + self.options.pollEndpoint,\r\n                method: 'POST',\r\n                data: {\r\n                    action: 'reconnect',\r\n                    sessionid: self.sessionId,\r\n                    connectionid: self.connectionId,\r\n                    sesskey: M.cfg.sesskey\r\n                },\r\n                dataType: 'json',\r\n                timeout: self.options.connectionTimeout\r\n            })\r\n            .done(function(response) {\r\n                resolve(response);\r\n            })\r\n            .fail(function(xhr, status, error) {\r\n                reject(new Error(error || 'Reconnect request failed'));\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Stop polling\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.stopPolling = function() {\r\n        if (this.pollingTimer) {\r\n            clearInterval(this.pollingTimer);\r\n            this.pollingTimer = null;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Start heartbeat timer\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.startHeartbeat = function() {\r\n        var self = this;\r\n\r\n        this.stopHeartbeat();\r\n\r\n        this.heartbeatTimer = setInterval(function() {\r\n            self.sendHeartbeat();\r\n        }, this.options.heartbeatInterval);\r\n    };\r\n\r\n    /**\r\n     * Stop heartbeat timer\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.stopHeartbeat = function() {\r\n        if (this.heartbeatTimer) {\r\n            clearInterval(this.heartbeatTimer);\r\n            this.heartbeatTimer = null;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Send heartbeat to server\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.sendHeartbeat = function() {\r\n        var self = this;\r\n        var startTime = Date.now();\r\n\r\n        $.ajax({\r\n            url: M.cfg.wwwroot + this.options.pollEndpoint,\r\n            method: 'POST',\r\n            data: {\r\n                action: 'heartbeat',\r\n                sessionid: this.sessionId,\r\n                connectionid: this.connectionId,\r\n                sesskey: M.cfg.sesskey\r\n            },\r\n            dataType: 'json',\r\n            timeout: 5000\r\n        })\r\n        .done(function(response) {\r\n            self.latency = Date.now() - startTime;\r\n            self.lastHeartbeat = Date.now();\r\n\r\n            if (response.success) {\r\n                self.emit('heartbeat', {\r\n                    latency: self.latency,\r\n                    timestamp: response.servertimestamp\r\n                });\r\n            }\r\n        })\r\n        .fail(function() {\r\n            // Heartbeat failed, but don't trigger reconnect immediately\r\n            // The polling or SSE will handle connection issues\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Handle connection error\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.handleConnectionError = function() {\r\n        if (this.status === STATUS.DISCONNECTED) {\r\n            return;\r\n        }\r\n\r\n        this.status = STATUS.RECONNECTING;\r\n        this.emit('statuschange', {status: this.status});\r\n        this.emit('disconnected', {reason: 'connection_error'});\r\n\r\n        this.scheduleReconnect();\r\n    };\r\n\r\n    /**\r\n     * Handle reconnect request from server\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.handleReconnectRequest = function() {\r\n        this.closeSSE();\r\n        this.stopPolling();\r\n        this.scheduleReconnect();\r\n    };\r\n\r\n    /**\r\n     * Schedule a reconnection attempt\r\n     *\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.scheduleReconnect = function() {\r\n        var self = this;\r\n\r\n        if (this.reconnectTimer) {\r\n            return;\r\n        }\r\n\r\n        this.reconnectTimer = setTimeout(function() {\r\n            self.reconnectTimer = null;\r\n            self.reconnect();\r\n        }, this.reconnectDelay);\r\n\r\n        // Exponential backoff\r\n        this.reconnectDelay = Math.min(\r\n            this.reconnectDelay * 2,\r\n            this.options.maxReconnectDelay\r\n        );\r\n    };\r\n\r\n    /**\r\n     * Force reconnection\r\n     *\r\n     * @return {Promise} Resolves when reconnected\r\n     */\r\n    ConnectionManager.prototype.reconnect = function() {\r\n        var self = this;\r\n\r\n        // Clear any pending reconnect\r\n        if (this.reconnectTimer) {\r\n            clearTimeout(this.reconnectTimer);\r\n            this.reconnectTimer = null;\r\n        }\r\n\r\n        // Close existing connections\r\n        this.closeSSE();\r\n        this.stopPolling();\r\n        this.stopHeartbeat();\r\n\r\n        this.status = STATUS.RECONNECTING;\r\n        this.emit('statuschange', {status: this.status});\r\n\r\n        // Reset SSE attempts for fresh reconnection\r\n        this.sseAttempts = 0;\r\n\r\n        // Try SSE first, then polling\r\n        return self.connectSSE()\r\n            .then(function() {\r\n                self.emit('reconnected', {transport: self.transport});\r\n            })\r\n            .catch(function() {\r\n                return self.startPolling()\r\n                    .then(function() {\r\n                        self.emit('reconnected', {transport: self.transport});\r\n                    })\r\n                    .catch(function(error) {\r\n                        self.status = STATUS.DISCONNECTED;\r\n                        self.transport = TRANSPORT.OFFLINE;\r\n                        self.emit('statuschange', {status: self.status, transport: self.transport});\r\n                        throw error;\r\n                    });\r\n            });\r\n    };\r\n\r\n    /**\r\n     * Send message to server\r\n     *\r\n     * @param {string} type Message type (action)\r\n     * @param {Object} data Message data\r\n     * @return {Promise} Resolves with server response\r\n     */\r\n    ConnectionManager.prototype.send = function(type, data) {\r\n        var self = this;\r\n        var startTime = Date.now();\r\n        var requestId = this.generateConnectionId();\r\n\r\n        this.pendingRequests[requestId] = startTime;\r\n\r\n        var requestData = $.extend({\r\n            action: type,\r\n            sessionid: this.sessionId,\r\n            connectionid: this.connectionId,\r\n            sesskey: M.cfg.sesskey\r\n        }, data || {});\r\n\r\n        return new Promise(function(resolve, reject) {\r\n            $.ajax({\r\n                url: M.cfg.wwwroot + self.options.pollEndpoint,\r\n                method: 'POST',\r\n                data: requestData,\r\n                dataType: 'json',\r\n                timeout: self.options.connectionTimeout\r\n            })\r\n            .done(function(response) {\r\n                delete self.pendingRequests[requestId];\r\n                self.latency = Date.now() - startTime;\r\n                resolve(response);\r\n            })\r\n            .fail(function(xhr, status, error) {\r\n                delete self.pendingRequests[requestId];\r\n                reject(new Error(error || 'Request failed'));\r\n            });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Register event handler\r\n     *\r\n     * @param {string} event Event name\r\n     * @param {Function} callback Callback function\r\n     */\r\n    ConnectionManager.prototype.on = function(event, callback) {\r\n        if (!this.eventHandlers[event]) {\r\n            this.eventHandlers[event] = [];\r\n        }\r\n        this.eventHandlers[event].push(callback);\r\n    };\r\n\r\n    /**\r\n     * Remove event handler\r\n     *\r\n     * @param {string} event Event name\r\n     * @param {Function} callback Callback function to remove\r\n     */\r\n    ConnectionManager.prototype.off = function(event, callback) {\r\n        if (!this.eventHandlers[event]) {\r\n            return;\r\n        }\r\n\r\n        if (callback) {\r\n            this.eventHandlers[event] = this.eventHandlers[event].filter(function(cb) {\r\n                return cb !== callback;\r\n            });\r\n        } else {\r\n            delete this.eventHandlers[event];\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Emit event to handlers\r\n     *\r\n     * @param {string} event Event name\r\n     * @param {Object} data Event data\r\n     * @private\r\n     */\r\n    ConnectionManager.prototype.emit = function(event, data) {\r\n        var handlers = this.eventHandlers[event];\r\n        if (handlers) {\r\n            handlers.forEach(function(callback) {\r\n                try {\r\n                    callback(data);\r\n                } catch (e) {\r\n                    // eslint-disable-next-line no-console\r\n                    console.error('Error in event handler for ' + event + ':', e);\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Get current connection status\r\n     *\r\n     * @return {Object} Connection status\r\n     */\r\n    ConnectionManager.prototype.getStatus = function() {\r\n        return {\r\n            connected: this.status === STATUS.CONNECTED,\r\n            status: this.status,\r\n            transport: this.transport,\r\n            latency: this.latency,\r\n            lastHeartbeat: this.lastHeartbeat,\r\n            connectionId: this.connectionId\r\n        };\r\n    };\r\n\r\n    /**\r\n     * Check if currently connected\r\n     *\r\n     * @return {boolean} True if connected\r\n     */\r\n    ConnectionManager.prototype.isConnected = function() {\r\n        return this.status === STATUS.CONNECTED;\r\n    };\r\n\r\n    /**\r\n     * Get current transport type\r\n     *\r\n     * @return {string} Transport type\r\n     */\r\n    ConnectionManager.prototype.getTransport = function() {\r\n        return this.transport;\r\n    };\r\n\r\n    /**\r\n     * Graceful disconnect\r\n     */\r\n    ConnectionManager.prototype.disconnect = function() {\r\n        this.closeSSE();\r\n        this.stopPolling();\r\n        this.stopHeartbeat();\r\n\r\n        if (this.reconnectTimer) {\r\n            clearTimeout(this.reconnectTimer);\r\n            this.reconnectTimer = null;\r\n        }\r\n\r\n        this.status = STATUS.DISCONNECTED;\r\n        this.transport = TRANSPORT.OFFLINE;\r\n\r\n        this.emit('statuschange', {status: this.status, transport: this.transport});\r\n        this.emit('disconnected', {reason: 'user_disconnect'});\r\n    };\r\n\r\n    // Export constants for external use\r\n    ConnectionManager.STATUS = STATUS;\r\n    ConnectionManager.TRANSPORT = TRANSPORT;\r\n\r\n    // Singleton instance\r\n    var instance = null;\r\n\r\n    return {\r\n        /**\r\n         * Get or create ConnectionManager instance\r\n         *\r\n         * @return {ConnectionManager} Connection manager instance\r\n         */\r\n        getInstance: function() {\r\n            if (!instance) {\r\n                instance = new ConnectionManager();\r\n            }\r\n            return instance;\r\n        },\r\n\r\n        /**\r\n         * Initialize connection manager with session\r\n         *\r\n         * @param {number} sessionId Session ID\r\n         * @param {Object} options Configuration options\r\n         * @return {Promise} Resolves when connected\r\n         */\r\n        init: function(sessionId, options) {\r\n            return this.getInstance().init(sessionId, options);\r\n        },\r\n\r\n        /**\r\n         * Send message to server\r\n         *\r\n         * @param {string} type Message type\r\n         * @param {Object} data Message data\r\n         * @return {Promise} Resolves with response\r\n         */\r\n        send: function(type, data) {\r\n            return this.getInstance().send(type, data);\r\n        },\r\n\r\n        /**\r\n         * Register event handler\r\n         *\r\n         * @param {string} event Event name\r\n         * @param {Function} callback Callback function\r\n         */\r\n        on: function(event, callback) {\r\n            this.getInstance().on(event, callback);\r\n        },\r\n\r\n        /**\r\n         * Remove event handler\r\n         *\r\n         * @param {string} event Event name\r\n         * @param {Function} callback Callback function\r\n         */\r\n        off: function(event, callback) {\r\n            this.getInstance().off(event, callback);\r\n        },\r\n\r\n        /**\r\n         * Get connection status\r\n         *\r\n         * @return {Object} Connection status\r\n         */\r\n        getStatus: function() {\r\n            return this.getInstance().getStatus();\r\n        },\r\n\r\n        /**\r\n         * Force reconnection\r\n         *\r\n         * @return {Promise} Resolves when reconnected\r\n         */\r\n        reconnect: function() {\r\n            return this.getInstance().reconnect();\r\n        },\r\n\r\n        /**\r\n         * Disconnect from server\r\n         */\r\n        disconnect: function() {\r\n            this.getInstance().disconnect();\r\n        },\r\n\r\n        // Export constants\r\n        STATUS: STATUS,\r\n        TRANSPORT: TRANSPORT\r\n    };\r\n});\r\n"],"names":["define","$","STATUS","DISCONNECTED","CONNECTING","CONNECTED","RECONNECTING","TRANSPORT","SSE","POLLING","OFFLINE","DEFAULTS","sseEndpoint","pollEndpoint","pollInterval","sseRetryAttempts","heartbeatInterval","reconnectDelay","maxReconnectDelay","connectionTimeout","ConnectionManager","sessionId","connectionId","options","extend","status","transport","latency","lastHeartbeat","eventSource","sseAttempts","pollingTimer","lastEventId","heartbeatTimer","reconnectTimer","eventHandlers","pendingRequests","prototype","init","self","this","generateConnectionId","emit","connectSSE","catch","startPolling","Date","now","Math","random","toString","substr","Promise","resolve","reject","EventSource","Error","url","M","cfg","wwwroot","encodeURIComponent","e","setTimeout","then","closeSSE","onopen","onerror","clearTimeout","addEventListener","event","data","JSON","parse","connectionid","parseInt","startHeartbeat","registerSSEHandlers","forEach","eventType","handleReconnectRequest","disconnect","close","pollReconnect","response","success","startPollingLoop","error","stopPolling","interval","min","setInterval","poll","startTime","ajax","method","action","sessionid","sesskey","dataType","timeout","done","session","fail","handleConnectionError","xhr","clearInterval","stopHeartbeat","sendHeartbeat","timestamp","servertimestamp","reason","scheduleReconnect","reconnect","send","type","requestId","requestData","on","callback","push","off","filter","cb","handlers","console","getStatus","connected","isConnected","getTransport","instance","getInstance"],"mappings":"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"}