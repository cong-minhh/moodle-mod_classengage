/**
 * JavaScript for real-time instructor control panel
 *
 * @module     mod_classengage/controlpanel
 * @package
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/controlpanel",["jquery","core/notification"],(function($,Notification){var pollingTimer=null,pollingInterval=1e3,sessionId=null,chart=null,consecutiveFailures=0,warningDisplayed=!1,ANSWER_OPTIONS=["A","B","C","D"];return{init:function(sid,interval){console.log("Control panel init called with sessionId:",sid,"interval:",interval),sessionId=sid,pollingInterval=interval||1e3,this.startPolling(),this.initChart(),this.setupUnloadHandler()},setupUnloadHandler:function(){var self=this;$(window).on("beforeunload",(function(){self.stopPolling()}))},startPolling:function(){var self=this;pollingTimer=setInterval((function(){self.updateStats()}),pollingInterval),this.updateStats()},updateStats:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/ajax.php",method:"POST",data:{action:"getstats",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(consecutiveFailures=0,warningDisplayed=!1,self.updateDisplay(response.data)):self.handleError()},error:function(){self.handleError()}})},handleError:function(){++consecutiveFailures>=5&&!warningDisplayed&&(Notification.addNotification({message:M.util.get_string("error:connectionissues","mod_classengage"),type:"warning"}),warningDisplayed=!0)},updateDisplay:function(data){console.log("Updating display with data:",data),void 0!==data.participants&&$("#participant-count").text(data.participants),void 0!==data.currentquestion&&void 0!==data.totalquestions&&$("#question-progress").text(parseInt(data.currentquestion)+1+" / "+data.totalquestions),void 0!==data.responses&&($("#response-count").text(data.responses+" / "+data.participants),void 0!==data.participationrate&&($("#response-rate").text(data.participationrate+"%"),$("#response-progress").css("width",data.participationrate+"%"),$("#response-progress").attr("aria-valuenow",data.participationrate))),data.distribution&&(console.log("Updating distribution:",data.distribution),this.updateDistribution(data.distribution),chart?(console.log("Updating chart"),this.updateChart(data.distribution)):console.log("Chart not initialized")),data.status&&($("#session-status").text(data.status.charAt(0).toUpperCase()+data.status.slice(1)),"completed"===data.status&&this.stopPolling()),this.updateTimeDisplay(data)},updateTimeDisplay:function(data){var timeText="--:--";if(data.timelimit>0){var remaining=void 0!==data.timeremaining?data.timeremaining:0;timeText=this.formatTime(remaining);var timeDisplay=$("#time-display");remaining<10?timeDisplay.addClass("text-danger").addClass("font-weight-bold"):timeDisplay.removeClass("text-danger").removeClass("font-weight-bold")}else{var elapsed=void 0!==data.elapsed?data.elapsed:0;timeText=this.formatTime(elapsed)}$("#time-display").text(timeText)},formatTime:function(seconds){var m=Math.floor(seconds/60),s=Math.floor(seconds%60);return(m<10?"0"+m:m)+":"+(s<10?"0"+s:s)},updateDistribution:function(distribution){var total=distribution.total||0,correctAnswer=distribution.correctanswer||"";console.log("Distribution update - total:",total,"correctAnswer:",correctAnswer),ANSWER_OPTIONS.forEach((function(option){var count=distribution[option]||0,percentage=total>0?Math.round(count/total*100):0,isCorrect=option===correctAnswer.toUpperCase();console.log("Option",option,"- count:",count,"percentage:",percentage);var countElem=$("#count-"+option);countElem.length?countElem.text(count):console.warn("Element #count-"+option+" not found");var percentElem=$("#percent-"+option);percentElem.length&&percentElem.text(percentage+"%");var progressBar=$("#bar-"+option);progressBar.length&&(progressBar.css("width",percentage+"%"),progressBar.attr("aria-valuenow",percentage));var row=$("#row-"+option);row.length&&(isCorrect?(row.addClass("table-success"),progressBar.removeClass("bg-info").addClass("bg-success")):(row.removeClass("table-success"),progressBar.removeClass("bg-success").addClass("bg-info")))}))},initChart:function(){console.log("initChart called");var ctx=document.getElementById("responseChart");ctx?(console.log("responseChart element found, checking for Chart.js"),void 0!==window.Chart?(console.log("Chart.js found, creating chart"),chart=new window.Chart(ctx,{type:"bar",data:{labels:ANSWER_OPTIONS,datasets:[{label:"Responses",data:[0,0,0,0],backgroundColor:["rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)"],borderColor:["rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{display:!1},title:{display:!0,text:"Response Distribution"}}}})):console.error("Chart.js failed to load. Displaying table view only.")):console.log("responseChart element not found")},updateChart:function(distribution){if(chart){var data=ANSWER_OPTIONS.map((function(option){return distribution[option]||0})),correctAnswer=distribution.correctanswer||"",colors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 0.8)":"rgba(54, 162, 235, 0.8)"})),borderColors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 1)":"rgba(54, 162, 235, 1)"}));chart.data.datasets[0].data=data,chart.data.datasets[0].backgroundColor=colors,chart.data.datasets[0].borderColor=borderColors,chart.update("none")}},stopPolling:function(){pollingTimer&&(clearInterval(pollingTimer),pollingTimer=null)}}}));

//# sourceMappingURL=controlpanel.min.js.map