/**
 * JavaScript for real-time instructor control panel
 *
 * SSE-only mode: Provides real-time student status monitoring, session control,
 * and aggregate statistics display exclusively via Server-Sent Events.
 * api.php is used only for write operations (pause/resume).
 *
 * Requirements: 1.3, 1.4, 1.5, 5.1, 5.4, 5.5
 *
 * @module     mod_classengage/controlpanel
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/controlpanel",["jquery","core/notification","mod_classengage/connection_manager"],(function($,Notification,ConnectionManager){var pollingInterval=1e3,sessionId=null,chart=null,lastQuestionNumber=-1,ANSWER_OPTIONS=["A","B","C","D"],isPaused=!1,connectedStudents={},searchTerm="",timerState={timeRemaining:0,timelimit:0,clientStartTime:0,isRunning:!1,countdownTimer:null};return{init:function(sid,interval){console.log("Control panel init called with sessionId:",sid,"interval:",interval),sessionId=sid,pollingInterval=interval||1e3,this.initSSEConnection(),this.initChart(),this.setupSessionControls(),this.setupUnloadHandler()},initSSEConnection:function(){var self=this;this.setupStudentSearch(),ConnectionManager.on("session_paused",(function(data){self.handleSessionPaused(data)})),ConnectionManager.on("session_resumed",(function(data){self.handleSessionResumed(data)})),ConnectionManager.on("question_broadcast",(function(data){self.handleQuestionBroadcast(data)})),ConnectionManager.on("state_update",(function(data){self.handleStateUpdate(data)})),ConnectionManager.on("statuschange",(function(data){self.handleConnectionStatusChange(data)})),ConnectionManager.on("stats_update",(function(data){self.handleStatsUpdate(data)})),ConnectionManager.on("students_update",(function(data){self.handleStudentsUpdate(data)})),ConnectionManager.init(sessionId,{pollInterval:pollingInterval}).then((function(){var status=ConnectionManager.getInstance().getStatus();return console.log("Connection established for control panel:",{transport:status.transport,status:status.status,connectionId:status.connectionId}),"sse"===status.transport?console.log("✓ SSE-ONLY mode active - No polling required!"):console.warn("⚠ SSE failed - Updates may not work correctly"),null})).catch((function(error){console.error("SSE connection failed:",error)}))},handleStatsUpdate:function(data){console.log("SSE stats_update received:",{currentquestion:data.currentquestion,responses:data.responses,distribution:data.distribution,hasChart:!!chart}),data.timelimit>0&&void 0!==data.timeremaining&&this.syncLocalTimer(data.timelimit,data.timeremaining),this.updateDisplay({currentquestion:data.currentquestion,totalquestions:data.totalquestions,responses:data.responses,participants:data.participants,participationrate:data.participationrate,status:data.status,timelimit:data.timelimit,timeremaining:data.timeremaining,distribution:data.distribution,connected:data.connected,answered:data.answered,pending:data.pending})},handleStudentsUpdate:function(data){data.students&&this.updateStudentList(data.students),data.stats&&this.updateAggregateStats(data.stats)},setupUnloadHandler:function(){$(window).on("beforeunload",(function(){ConnectionManager.disconnect()}))},setupSessionControls:function(){var self=this;$(document).on("click","#btn-pause-session",(function(e){e.preventDefault(),self.pauseSession()})),$(document).on("click","#btn-resume-session",(function(e){e.preventDefault(),self.resumeSession()}))},setupStudentSearch:function(){var self=this,searchTimer=null;$("#student-search").on("input",(function(){var value=$(this).val().toLowerCase().trim();searchTimer&&clearTimeout(searchTimer),searchTimer=setTimeout((function(){searchTerm=value,self.filterStudentList()}),150)}))},filterStudentList:function(){if($("#student-list").length){var students=Object.values(connectedStudents);searchTerm&&(students=students.filter((function(student){return-1!==(student.fullname||"").toLowerCase().indexOf(searchTerm)}))),this.renderStudentListHtml(students)}},pauseSession:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/api.php",method:"POST",data:{action:"pause",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(self.handleSessionPaused(response),Notification.addNotification({message:M.util.get_string("sessionpaused","mod_classengage"),type:"info"})):Notification.addNotification({message:response.error||"Failed to pause session",type:"error"})},error:function(){Notification.addNotification({message:"Network error while pausing session",type:"error"})}})},resumeSession:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/api.php",method:"POST",data:{action:"resume",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(self.handleSessionResumed(response),Notification.addNotification({message:M.util.get_string("sessionresumed","mod_classengage"),type:"info"})):Notification.addNotification({message:response.error||"Failed to resume session",type:"error"})},error:function(){Notification.addNotification({message:"Network error while resuming session",type:"error"})}})},handleSessionPaused:function(data){if(isPaused=!0,timerState.isRunning){var clientElapsed=(Date.now()-timerState.clientStartTime)/1e3;timerState.timeRemaining=Math.max(0,timerState.timeRemaining-clientElapsed)}this.stopLocalCountdown(),$("#btn-pause-session").hide(),$("#btn-resume-session").show(),$("#session-status").text("Paused").addClass("text-warning"),$("#session-status-badge").removeClass("badge-success").addClass("badge-warning").text("Paused"),void 0!==data.timerremaining&&(timerState.timeRemaining=data.timerremaining,this.renderTimerDisplay(data.timerremaining)),$("#time-display").addClass("text-warning")},handleSessionResumed:function(data){isPaused=!1,$("#btn-resume-session").hide(),$("#btn-pause-session").show(),$("#session-status").text("Active").removeClass("text-warning"),$("#session-status-badge").removeClass("badge-warning").addClass("badge-success").text("Active"),$("#time-display").removeClass("text-warning");var remaining=data&&void 0!==data.timerremaining?data.timerremaining:timerState.timeRemaining;remaining>0&&this.startLocalCountdown(remaining,timerState.timelimit)},handleQuestionBroadcast:function(data){if(this.resetStudentAnsweredStatus(),void 0!==data.questionnumber){var newQuestion=parseInt(data.questionnumber);lastQuestionNumber=newQuestion;var total=$("#question-progress").data("total")||data.questionnumber+1;$("#question-progress").text(newQuestion+1+" / "+total)}data.timelimit&&data.timelimit>0&&this.startLocalCountdown(data.timelimit,data.timelimit)},handleStateUpdate:function(data){data.status&&((isPaused="paused"===data.status)?($("#btn-pause-session").hide(),$("#btn-resume-session").show()):($("#btn-resume-session").hide(),$("#btn-pause-session").show()))},handleConnectionStatusChange:function(data){var statusIndicator=$("#connection-status-indicator");"connected"===data.status?(statusIndicator.removeClass("text-danger text-warning").addClass("text-success"),statusIndicator.attr("title","Connected via "+(data.transport||"polling"))):"reconnecting"===data.status?(statusIndicator.removeClass("text-success text-danger").addClass("text-warning"),statusIndicator.attr("title","Reconnecting...")):(statusIndicator.removeClass("text-success text-warning").addClass("text-danger"),statusIndicator.attr("title","Disconnected"))},updateStudentList:function(students){if($("#student-list").length){students.forEach((function(student){connectedStudents[student.userid]=student}));var filteredStudents=students;searchTerm&&(filteredStudents=students.filter((function(student){return-1!==(student.fullname||"").toLowerCase().indexOf(searchTerm)}))),this.renderStudentListHtml(filteredStudents)}},renderStudentListHtml:function(students){var self=this,container=$("#student-list");if(container.length){var html="";0===students.length?html='<div class="text-muted p-3 text-center">'+(searchTerm?"No students match your search":"No students enrolled")+"</div>":(html='<ul class="list-group list-group-flush">',students.forEach((function(student){var icon=student.hasanswered?"fa-check-circle text-success":"fa-circle text-muted",name=self.escapeHtml(student.fullname||"User "+student.userid),isConnected="not_connected"!==student.status,nameClass=isConnected?"":"text-muted";html+='<li class="list-group-item d-flex justify-content-between align-items-center py-2 '+(isConnected?"":"bg-light")+'" data-userid="'+student.userid+'">',html+='<span class="'+nameClass+'">'+name+"</span>",html+='<i class="fa '+icon+'"></i>',html+="</li>"})),html+="</ul>"),container.html(html)}},getStatusClass:function(status){switch(status){case"connected":return"text-success";case"disconnected":return"text-danger";case"answering":return"text-info";default:return"text-muted"}},getStatusIcon:function(status,hasAnswered){if(hasAnswered)return"fa-check-circle";switch(status){case"connected":return"fa-circle";case"disconnected":return"fa-times-circle";case"answering":return"fa-spinner fa-spin";default:return"fa-question-circle"}},updateAggregateStats:function(stats){},resetStudentAnsweredStatus:function(){Object.keys(connectedStudents).forEach((function(userid){connectedStudents[userid].hasanswered=!1}))},escapeHtml:function(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML},updateDisplay:function(data){if(void 0!==data.currentquestion&&void 0!==data.totalquestions){var newQuestion=parseInt(data.currentquestion);newQuestion>=lastQuestionNumber&&(lastQuestionNumber=newQuestion,$("#question-progress").text(newQuestion+1+" / "+data.totalquestions),$("#question-progress").data("total",data.totalquestions))}if(void 0!==data.responses&&($("#response-count-current").text(data.responses),$("#response-count").text(data.responses+" / "+data.participants)),void 0!==data.connected&&this.updateAggregateStats({connected:data.connected,answered:data.answered,pending:data.pending}),data.distribution&&(this.updateDistribution(data.distribution),chart&&this.updateChart(data.distribution)),data.status){isPaused="paused"===data.status;var statusText=data.status.charAt(0).toUpperCase()+data.status.slice(1);$("#session-status").text(statusText),isPaused?($("#btn-pause-session").hide(),$("#btn-resume-session").show(),$("#session-status-badge").removeClass("badge-success").addClass("badge-warning")):"active"===data.status&&($("#btn-resume-session").hide(),$("#btn-pause-session").show(),$("#session-status-badge").removeClass("badge-warning").addClass("badge-success")),"completed"===data.status&&(this.stopPolling(),this.stopStudentStatusPolling())}this.updateTimeDisplay(data)},updateTimeDisplay:function(data){if(data.timelimit>0&&!timerState.isRunning&&!isPaused){var remaining=void 0!==data.timeremaining?data.timeremaining:0;remaining>0&&this.startLocalCountdown(remaining,data.timelimit)}},syncLocalTimer:function(timelimit,serverRemaining){if(timerState.isRunning){var clientElapsed=(Date.now()-timerState.clientStartTime)/1e3,clientRemaining=Math.max(0,timerState.timeRemaining-clientElapsed),drift=Math.abs(serverRemaining-clientRemaining);drift>2&&(console.log("Timer drift correction:",drift.toFixed(1),"seconds"),timerState.timeRemaining=serverRemaining,timerState.clientStartTime=Date.now())}else this.startLocalCountdown(serverRemaining,timelimit)},startLocalCountdown:function(seconds,timelimit){var self=this;this.stopLocalCountdown(),timerState.timeRemaining=seconds,timerState.timelimit=timelimit,timerState.clientStartTime=Date.now(),timerState.isRunning=!0,this.renderTimerDisplay(seconds),timerState.countdownTimer=setInterval((function(){if(timerState.isRunning&&!isPaused){var clientElapsed=(Date.now()-timerState.clientStartTime)/1e3,remaining=Math.max(0,timerState.timeRemaining-clientElapsed);self.renderTimerDisplay(remaining),remaining<=0&&self.stopLocalCountdown()}}),1e3)},stopLocalCountdown:function(){timerState.countdownTimer&&(clearInterval(timerState.countdownTimer),timerState.countdownTimer=null),timerState.isRunning=!1},renderTimerDisplay:function(remaining){var timeText=this.formatTime(remaining),timeDisplay=$("#time-display");timeDisplay.text(timeText),remaining<=0||remaining<10?timeDisplay.removeClass("text-warning").addClass("text-danger font-weight-bold"):remaining<30?timeDisplay.removeClass("text-danger font-weight-bold").addClass("text-warning"):timeDisplay.removeClass("text-danger text-warning font-weight-bold")},formatTime:function(seconds){var m=Math.floor(seconds/60),s=Math.floor(seconds%60);return(m<10?"0"+m:m)+":"+(s<10?"0"+s:s)},updateDistribution:function(distribution){var total=distribution.total||0,correctAnswer=distribution.correctanswer||"";ANSWER_OPTIONS.forEach((function(option){var count=distribution[option]||0,percentage=total>0?Math.round(count/total*100):0,isCorrect=option===correctAnswer.toUpperCase(),countElem=$("#count-"+option);countElem.length&&countElem.text(count);var percentElem=$("#percent-"+option);percentElem.length&&percentElem.text(percentage+"%");var progressBar=$("#bar-"+option);progressBar.length&&(progressBar.css("width",percentage+"%"),progressBar.attr("aria-valuenow",percentage));var row=$("#row-"+option);row.length&&(isCorrect?(row.addClass("table-success"),progressBar.removeClass("bg-info").addClass("bg-success")):(row.removeClass("table-success"),progressBar.removeClass("bg-success").addClass("bg-info")))}))},initChart:function(){var ctx=document.getElementById("responseChart");ctx&&(void 0!==window.Chart?chart=new window.Chart(ctx,{type:"bar",data:{labels:ANSWER_OPTIONS,datasets:[{label:"Responses",data:[0,0,0,0],backgroundColor:["rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)"],borderColor:["rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{display:!1},title:{display:!0,text:"Response Distribution"}}}}):console.error("Chart.js failed to load. Displaying table view only."))},updateChart:function(distribution){if(chart){var data=ANSWER_OPTIONS.map((function(option){return distribution[option]||0})),correctAnswer=distribution.correctanswer||"",colors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 0.8)":"rgba(54, 162, 235, 0.8)"})),borderColors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 1)":"rgba(54, 162, 235, 1)"}));chart.data.datasets[0].data=data,chart.data.datasets[0].backgroundColor=colors,chart.data.datasets[0].borderColor=borderColors,chart.update("none")}}}}));

//# sourceMappingURL=controlpanel.min.js.map