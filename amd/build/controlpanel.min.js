/**
 * JavaScript for real-time instructor control panel
 *
 * Provides real-time student status monitoring, session control (pause/resume),
 * and aggregate statistics display via SSE with polling fallback.
 *
 * Requirements: 1.3, 1.4, 1.5, 5.1, 5.4, 5.5
 *
 * @module     mod_classengage/controlpanel
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/controlpanel",["jquery","core/notification","mod_classengage/connection_manager"],(function($,Notification,ConnectionManager){var pollingTimer=null,pollingInterval=1e3,sessionId=null,chart=null,consecutiveFailures=0,warningDisplayed=!1,lastQuestionNumber=-1,ANSWER_OPTIONS=["A","B","C","D"],isPaused=!1,studentStatusTimer=null,connectedStudents={};return{init:function(sid,interval){console.log("Control panel init called with sessionId:",sid,"interval:",interval),sessionId=sid,pollingInterval=interval||1e3,this.initSSEConnection(),this.startPolling(),this.startStudentStatusPolling(),this.initChart(),this.setupSessionControls(),this.setupUnloadHandler()},initSSEConnection:function(){var self=this;ConnectionManager.on("session_paused",(function(data){self.handleSessionPaused(data)})),ConnectionManager.on("session_resumed",(function(data){self.handleSessionResumed(data)})),ConnectionManager.on("question_broadcast",(function(data){self.handleQuestionBroadcast(data)})),ConnectionManager.on("state_update",(function(data){self.handleStateUpdate(data)})),ConnectionManager.on("statuschange",(function(data){self.handleConnectionStatusChange(data)})),ConnectionManager.init(sessionId,{pollInterval:pollingInterval}).then((function(){return console.log("SSE connection established for control panel"),null})).catch((function(){console.log("SSE not available, using polling fallback"),pollingTimer||self.startPolling()}))},stopPolling:function(){pollingTimer&&(clearInterval(pollingTimer),pollingTimer=null)},setupUnloadHandler:function(){var self=this;$(window).on("beforeunload",(function(){self.stopPolling(),self.stopStudentStatusPolling(),ConnectionManager.disconnect()}))},setupSessionControls:function(){var self=this;$(document).on("click","#btn-pause-session",(function(e){e.preventDefault(),self.pauseSession()})),$(document).on("click","#btn-resume-session",(function(e){e.preventDefault(),self.resumeSession()}))},pauseSession:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/ajax.php",method:"POST",data:{action:"pause",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(self.handleSessionPaused(response),Notification.addNotification({message:M.util.get_string("sessionpaused","mod_classengage"),type:"info"})):Notification.addNotification({message:response.error||"Failed to pause session",type:"error"})},error:function(){Notification.addNotification({message:"Network error while pausing session",type:"error"})}})},resumeSession:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/ajax.php",method:"POST",data:{action:"resume",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(self.handleSessionResumed(response),Notification.addNotification({message:M.util.get_string("sessionresumed","mod_classengage"),type:"info"})):Notification.addNotification({message:response.error||"Failed to resume session",type:"error"})},error:function(){Notification.addNotification({message:"Network error while resuming session",type:"error"})}})},handleSessionPaused:function(data){isPaused=!0,$("#btn-pause-session").hide(),$("#btn-resume-session").show(),$("#session-status").text("Paused").addClass("text-warning"),$("#session-status-badge").removeClass("badge-success").addClass("badge-warning").text("Paused"),void 0!==data.timerremaining&&$("#time-display").text(this.formatTime(data.timerremaining))},handleSessionResumed:function(){isPaused=!1,$("#btn-resume-session").hide(),$("#btn-pause-session").show(),$("#session-status").text("Active").removeClass("text-warning"),$("#session-status-badge").removeClass("badge-warning").addClass("badge-success").text("Active")},handleQuestionBroadcast:function(data){if(this.resetStudentAnsweredStatus(),void 0!==data.questionnumber){var newQuestion=parseInt(data.questionnumber);lastQuestionNumber=newQuestion;var total=$("#question-progress").data("total")||data.questionnumber+1;$("#question-progress").text(newQuestion+1+" / "+total)}this.updateStats()},handleStateUpdate:function(data){data.status&&((isPaused="paused"===data.status)?($("#btn-pause-session").hide(),$("#btn-resume-session").show()):($("#btn-resume-session").hide(),$("#btn-pause-session").show()))},handleConnectionStatusChange:function(data){var statusIndicator=$("#connection-status-indicator");"connected"===data.status?(statusIndicator.removeClass("text-danger text-warning").addClass("text-success"),statusIndicator.attr("title","Connected via "+(data.transport||"polling"))):"reconnecting"===data.status?(statusIndicator.removeClass("text-success text-danger").addClass("text-warning"),statusIndicator.attr("title","Reconnecting...")):(statusIndicator.removeClass("text-success text-warning").addClass("text-danger"),statusIndicator.attr("title","Disconnected"))},startStudentStatusPolling:function(){var self=this;studentStatusTimer=setInterval((function(){self.updateStudentStatus()}),2e3),this.updateStudentStatus()},stopStudentStatusPolling:function(){studentStatusTimer&&(clearInterval(studentStatusTimer),studentStatusTimer=null)},updateStudentStatus:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/ajax.php",method:"POST",data:{action:"getstudents",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success&&(self.updateStudentList(response.students||[]),self.updateAggregateStats(response.stats||{}))},error:function(){}})},updateStudentList:function(students){var self=this,container=$("#connected-students-list");if(container.length){students.forEach((function(student){connectedStudents[student.userid]=student}));var html="";0===students.length?html='<div class="text-muted p-2">No students connected</div>':(html='<ul class="list-group list-group-flush student-status-list">',students.forEach((function(student){var statusClass=self.getStatusClass(student.status),statusIcon=self.getStatusIcon(student.status,student.hasanswered),answeredBadge=student.hasanswered?'<span class="badge badge-success ml-2">Answered</span>':"";html+='<li class="list-group-item d-flex justify-content-between align-items-center py-2">',html+='<span class="student-name">'+self.escapeHtml(student.fullname||"User "+student.userid)+"</span>",html+='<span class="student-status">',html+='<i class="fa '+statusIcon+" "+statusClass+'" title="'+student.status+'"></i>',html+=answeredBadge,html+="</span>",html+="</li>"})),html+="</ul>"),container.html(html)}},getStatusClass:function(status){switch(status){case"connected":return"text-success";case"disconnected":return"text-danger";case"answering":return"text-info";default:return"text-muted"}},getStatusIcon:function(status,hasAnswered){if(hasAnswered)return"fa-check-circle";switch(status){case"connected":return"fa-circle";case"disconnected":return"fa-times-circle";case"answering":return"fa-spinner fa-spin";default:return"fa-question-circle"}},updateAggregateStats:function(stats){if(void 0!==stats.connected&&($("#stat-connected").text(stats.connected),$("#connected-count").text(stats.connected)),void 0!==stats.answered&&$("#stat-answered").text(stats.answered),void 0!==stats.pending&&$("#stat-pending").text(stats.pending),stats.connected>0&&void 0!==stats.answered){var percentage=Math.round(stats.answered/stats.connected*100);$("#answered-progress").css("width",percentage+"%"),$("#answered-progress").attr("aria-valuenow",percentage)}},resetStudentAnsweredStatus:function(){$(".student-status-list .badge-success").remove(),Object.keys(connectedStudents).forEach((function(userid){connectedStudents[userid].hasanswered=!1})),$("#stat-answered").text("0"),$("#stat-pending").text($("#stat-connected").text()),$("#answered-progress").css("width","0%")},escapeHtml:function(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML},startPolling:function(){var self=this;pollingTimer=setInterval((function(){self.updateStats()}),pollingInterval),this.updateStats()},updateStats:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/ajax.php",method:"POST",data:{action:"getstats",sessionid:sessionId,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(consecutiveFailures=0,warningDisplayed=!1,self.updateDisplay(response.data)):self.handleError()},error:function(){self.handleError()}})},handleError:function(){++consecutiveFailures>=5&&!warningDisplayed&&(Notification.addNotification({message:M.util.get_string("error:connectionissues","mod_classengage"),type:"warning"}),warningDisplayed=!0)},updateDisplay:function(data){if(void 0!==data.participants&&$("#participant-count").text(data.participants),void 0!==data.currentquestion&&void 0!==data.totalquestions){var newQuestion=parseInt(data.currentquestion);newQuestion>=lastQuestionNumber&&(lastQuestionNumber=newQuestion,$("#question-progress").text(newQuestion+1+" / "+data.totalquestions),$("#question-progress").data("total",data.totalquestions))}if(void 0!==data.responses&&($("#response-count").text(data.responses+" / "+data.participants),void 0!==data.participationrate&&($("#response-rate").text(data.participationrate+"%"),$("#response-progress").css("width",data.participationrate+"%"),$("#response-progress").attr("aria-valuenow",data.participationrate))),void 0!==data.connected&&this.updateAggregateStats({connected:data.connected,answered:data.answered,pending:data.pending}),data.distribution&&(this.updateDistribution(data.distribution),chart&&this.updateChart(data.distribution)),data.status){isPaused="paused"===data.status;var statusText=data.status.charAt(0).toUpperCase()+data.status.slice(1);$("#session-status").text(statusText),isPaused?($("#btn-pause-session").hide(),$("#btn-resume-session").show(),$("#session-status-badge").removeClass("badge-success").addClass("badge-warning")):"active"===data.status&&($("#btn-resume-session").hide(),$("#btn-pause-session").show(),$("#session-status-badge").removeClass("badge-warning").addClass("badge-success")),"completed"===data.status&&(this.stopPolling(),this.stopStudentStatusPolling())}this.updateTimeDisplay(data)},updateTimeDisplay:function(data){var timeText="--:--";if(isPaused&&void 0!==data.timerremaining)timeText=this.formatTime(data.timerremaining),$("#time-display").addClass("text-warning");else if(data.timelimit>0){var remaining=void 0!==data.timeremaining?data.timeremaining:0;timeText=this.formatTime(remaining);var timeDisplay=$("#time-display");remaining<10?timeDisplay.addClass("text-danger").addClass("font-weight-bold"):timeDisplay.removeClass("text-danger").removeClass("font-weight-bold").removeClass("text-warning")}else{var elapsed=void 0!==data.elapsed?data.elapsed:0;timeText=this.formatTime(elapsed)}$("#time-display").text(timeText)},formatTime:function(seconds){var m=Math.floor(seconds/60),s=Math.floor(seconds%60);return(m<10?"0"+m:m)+":"+(s<10?"0"+s:s)},updateDistribution:function(distribution){var total=distribution.total||0,correctAnswer=distribution.correctanswer||"";ANSWER_OPTIONS.forEach((function(option){var count=distribution[option]||0,percentage=total>0?Math.round(count/total*100):0,isCorrect=option===correctAnswer.toUpperCase(),countElem=$("#count-"+option);countElem.length&&countElem.text(count);var percentElem=$("#percent-"+option);percentElem.length&&percentElem.text(percentage+"%");var progressBar=$("#bar-"+option);progressBar.length&&(progressBar.css("width",percentage+"%"),progressBar.attr("aria-valuenow",percentage));var row=$("#row-"+option);row.length&&(isCorrect?(row.addClass("table-success"),progressBar.removeClass("bg-info").addClass("bg-success")):(row.removeClass("table-success"),progressBar.removeClass("bg-success").addClass("bg-info")))}))},initChart:function(){var ctx=document.getElementById("responseChart");ctx&&(void 0!==window.Chart?chart=new window.Chart(ctx,{type:"bar",data:{labels:ANSWER_OPTIONS,datasets:[{label:"Responses",data:[0,0,0,0],backgroundColor:["rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)","rgba(54, 162, 235, 0.8)"],borderColor:["rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)","rgba(54, 162, 235, 1)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{display:!1},title:{display:!0,text:"Response Distribution"}}}}):console.error("Chart.js failed to load. Displaying table view only."))},updateChart:function(distribution){if(chart){var data=ANSWER_OPTIONS.map((function(option){return distribution[option]||0})),correctAnswer=distribution.correctanswer||"",colors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 0.8)":"rgba(54, 162, 235, 0.8)"})),borderColors=ANSWER_OPTIONS.map((function(option){return option===correctAnswer.toUpperCase()?"rgba(75, 192, 192, 1)":"rgba(54, 162, 235, 1)"}));chart.data.datasets[0].data=data,chart.data.datasets[0].backgroundColor=colors,chart.data.datasets[0].borderColor=borderColors,chart.update("none")}}}}));

//# sourceMappingURL=controlpanel.min.js.map