{"version":3,"file":"controlpanel.min.js","sources":["../src/controlpanel.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for real-time instructor control panel\n *\n * @module     mod_classengage/controlpanel\n * @package\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification'],\n    function($, Notification) {\n\n    var pollingTimer = null;\n    var pollingInterval = 1000; // 1 second\n    var sessionId = null;\n    var chart = null;\n    var consecutiveFailures = 0;\n    var warningDisplayed = false;\n\n    // Constants\n    var MAX_CONSECUTIVE_FAILURES = 5;\n    var ANSWER_OPTIONS = ['A', 'B', 'C', 'D'];\n\n    return {\n        /**\n         * Initialize the control panel with real-time polling\n         *\n         * @param {number} sid Session ID\n         * @param {number} interval Polling interval in milliseconds\n         */\n        init: function(sid, interval) {\n            // eslint-disable-next-line no-console\n            console.log('Control panel init called with sessionId:', sid, 'interval:', interval);\n\n            sessionId = sid;\n            pollingInterval = interval || 1000;\n\n            // Start polling for updates\n            this.startPolling();\n\n            // Initialize chart\n            this.initChart();\n\n            // Add cleanup on page unload\n            this.setupUnloadHandler();\n        },\n\n        /**\n         * Setup page unload handler to clean up polling timer\n         *\n         * @private\n         */\n        setupUnloadHandler: function() {\n            var self = this;\n            $(window).on('beforeunload', function() {\n                self.stopPolling();\n            });\n        },\n\n        /**\n         * Start polling for session statistics updates\n         */\n        startPolling: function() {\n            var self = this;\n\n            // Poll for current question stats\n            pollingTimer = setInterval(function() {\n                self.updateStats();\n            }, pollingInterval);\n\n            // Get initial stats\n            this.updateStats();\n        },\n\n        /**\n         * Fetch and update session statistics via AJAX\n         *\n         * @private\n         */\n        updateStats: function() {\n            var self = this;\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/classengage/ajax.php',\n                method: 'POST',\n                data: {\n                    action: 'getstats',\n                    sessionid: sessionId,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                success: function(response) {\n                    if (response.success) {\n                        // Reset failure counter on success\n                        consecutiveFailures = 0;\n                        warningDisplayed = false;\n                        self.updateDisplay(response.data);\n                    } else {\n                        // Server returned error\n                        self.handleError();\n                    }\n                },\n                error: function() {\n                    // Network or server error\n                    self.handleError();\n                }\n            });\n        },\n\n        /**\n         * Handle AJAX errors with consecutive failure tracking\n         *\n         * @private\n         */\n        handleError: function() {\n            consecutiveFailures++;\n\n            // Display warning after threshold consecutive failures\n            if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES && !warningDisplayed) {\n                Notification.addNotification({\n                    message: M.util.get_string('error:connectionissues', 'mod_classengage'),\n                    type: 'warning'\n                });\n                warningDisplayed = true;\n            }\n\n            // Continue polling - don't stop on errors\n        },\n\n        /**\n         * Update the display with new session data\n         *\n         * @param {Object} data Session statistics data\n         * @param {number} data.participants Total participant count\n         * @param {number} data.responses Total response count\n         * @param {Object} data.distribution Answer distribution\n         * @param {string} data.status Session status\n         * @private\n         */\n        updateDisplay: function(data) {\n            // Debug logging\n            // eslint-disable-next-line no-console\n            console.log('Updating display with data:', data);\n\n            // Update participant count\n            if (data.participants !== undefined) {\n                $('#participant-count').text(data.participants);\n            }\n\n            // Update response count\n            if (data.responses !== undefined) {\n                var responseRate = data.participants > 0 ?\n                    Math.round((data.responses / data.participants) * 100) : 0;\n                $('#response-count').text(data.responses + ' / ' + data.participants);\n                $('#response-rate').text(responseRate + '%');\n\n                // Update progress bar\n                $('#response-progress').css('width', responseRate + '%');\n                $('#response-progress').attr('aria-valuenow', responseRate);\n            }\n\n            // Update answer distribution\n            if (data.distribution) {\n                // eslint-disable-next-line no-console\n                console.log('Updating distribution:', data.distribution);\n                this.updateDistribution(data.distribution);\n\n                // Update chart if available\n                if (chart) {\n                    // eslint-disable-next-line no-console\n                    console.log('Updating chart');\n                    this.updateChart(data.distribution);\n                } else {\n                    // eslint-disable-next-line no-console\n                    console.log('Chart not initialized');\n                }\n            }\n\n            // Update session status\n            if (data.status) {\n                $('#session-status').text(data.status.charAt(0).toUpperCase() + data.status.slice(1));\n\n                // Stop polling if session is completed\n                if (data.status === 'completed') {\n                    this.stopPolling();\n                }\n            }\n        },\n\n        /**\n         * Update the answer distribution table\n         *\n         * @param {Object} distribution Distribution data with A, B, C, D counts\n         * @param {string} distribution.correctanswer The correct answer option\n         * @param {number} distribution.total Total response count\n         * @private\n         */\n        updateDistribution: function(distribution) {\n            var total = distribution.total || 0;\n            var correctAnswer = distribution.correctanswer || '';\n\n            // eslint-disable-next-line no-console\n            console.log('Distribution update - total:', total, 'correctAnswer:', correctAnswer);\n\n            ANSWER_OPTIONS.forEach(function(option) {\n                var count = distribution[option] || 0;\n                var percentage = total > 0 ? Math.round((count / total) * 100) : 0;\n                var isCorrect = option === correctAnswer.toUpperCase();\n\n                // eslint-disable-next-line no-console\n                console.log('Option', option, '- count:', count, 'percentage:', percentage);\n\n                // Update count\n                var countElem = $('#count-' + option);\n                if (countElem.length) {\n                    countElem.text(count);\n                } else {\n                    // eslint-disable-next-line no-console\n                    console.warn('Element #count-' + option + ' not found');\n                }\n\n                // Update percentage\n                var percentElem = $('#percent-' + option);\n                if (percentElem.length) {\n                    percentElem.text(percentage + '%');\n                }\n\n                // Update progress bar\n                var progressBar = $('#bar-' + option);\n                if (progressBar.length) {\n                    progressBar.css('width', percentage + '%');\n                    progressBar.attr('aria-valuenow', percentage);\n                }\n\n                // Highlight correct answer\n                var row = $('#row-' + option);\n                if (row.length) {\n                    if (isCorrect) {\n                        row.addClass('table-success');\n                        progressBar.removeClass('bg-info').addClass('bg-success');\n                    } else {\n                        row.removeClass('table-success');\n                        progressBar.removeClass('bg-success').addClass('bg-info');\n                    }\n                }\n            });\n        },\n\n        /**\n         * Initialize Chart.js bar chart for response visualization\n         *\n         * @private\n         */\n        initChart: function() {\n            // eslint-disable-next-line no-console\n            console.log('initChart called');\n\n            var ctx = document.getElementById('responseChart');\n            if (!ctx) {\n                // Chart element not found - gracefully degrade to table-only view\n                // eslint-disable-next-line no-console\n                console.log('responseChart element not found');\n                return;\n            }\n\n            // eslint-disable-next-line no-console\n            console.log('responseChart element found, checking for Chart.js');\n\n            // Check if Chart.js loaded successfully (loaded via script tag in PHP)\n            if (typeof window.Chart === 'undefined') {\n                // Chart.js failed to load - log error and continue with table view\n                // eslint-disable-next-line no-console\n                console.error('Chart.js failed to load. Displaying table view only.');\n                return;\n            }\n\n            // eslint-disable-next-line no-console\n            console.log('Chart.js found, creating chart');\n\n            chart = new window.Chart(ctx, {\n                type: 'bar',\n                data: {\n                    labels: ANSWER_OPTIONS,\n                    datasets: [{\n                        label: 'Responses',\n                        data: [0, 0, 0, 0],\n                        backgroundColor: [\n                            'rgba(54, 162, 235, 0.8)',\n                            'rgba(54, 162, 235, 0.8)',\n                            'rgba(54, 162, 235, 0.8)',\n                            'rgba(54, 162, 235, 0.8)'\n                        ],\n                        borderColor: [\n                            'rgba(54, 162, 235, 1)',\n                            'rgba(54, 162, 235, 1)',\n                            'rgba(54, 162, 235, 1)',\n                            'rgba(54, 162, 235, 1)'\n                        ],\n                        borderWidth: 1\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        y: {\n                            beginAtZero: true,\n                            ticks: {\n                                stepSize: 1\n                            }\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        },\n                        title: {\n                            display: true,\n                            text: 'Response Distribution'\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Update chart with new distribution data\n         *\n         * @param {Object} distribution Distribution data with A, B, C, D counts\n         * @param {string} distribution.correctanswer The correct answer option\n         * @private\n         */\n        updateChart: function(distribution) {\n            if (!chart) {\n                return;\n            }\n\n            var data = ANSWER_OPTIONS.map(function(option) {\n                return distribution[option] || 0;\n            });\n\n            var correctAnswer = distribution.correctanswer || '';\n            var colors = ANSWER_OPTIONS.map(function(option) {\n                return option === correctAnswer.toUpperCase() ?\n                    'rgba(75, 192, 192, 0.8)' : 'rgba(54, 162, 235, 0.8)';\n            });\n\n            var borderColors = ANSWER_OPTIONS.map(function(option) {\n                return option === correctAnswer.toUpperCase() ?\n                    'rgba(75, 192, 192, 1)' : 'rgba(54, 162, 235, 1)';\n            });\n\n            chart.data.datasets[0].data = data;\n            chart.data.datasets[0].backgroundColor = colors;\n            chart.data.datasets[0].borderColor = borderColors;\n            chart.update('none'); // Update without animation for smoother real-time updates\n        },\n\n        /**\n         * Stop the polling timer\n         */\n        stopPolling: function() {\n            if (pollingTimer) {\n                clearInterval(pollingTimer);\n                pollingTimer = null;\n            }\n        }\n    };\n});\n"],"names":["define","$","Notification","pollingTimer","pollingInterval","sessionId","chart","consecutiveFailures","warningDisplayed","ANSWER_OPTIONS","init","sid","interval","console","log","startPolling","initChart","setupUnloadHandler","self","this","window","on","stopPolling","setInterval","updateStats","ajax","url","M","cfg","wwwroot","method","data","action","sessionid","sesskey","dataType","success","response","updateDisplay","handleError","error","addNotification","message","util","get_string","type","undefined","participants","text","responses","responseRate","Math","round","css","attr","distribution","updateDistribution","updateChart","status","charAt","toUpperCase","slice","total","correctAnswer","correctanswer","forEach","option","count","percentage","isCorrect","countElem","length","warn","percentElem","progressBar","row","addClass","removeClass","ctx","document","getElementById","Chart","labels","datasets","label","backgroundColor","borderColor","borderWidth","options","responsive","maintainAspectRatio","scales","y","beginAtZero","ticks","stepSize","plugins","legend","display","title","map","colors","borderColors","update","clearInterval"],"mappings":"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"}