/**
 * JavaScript for Chart.js visualizations in analytics
 *
 * This module handles:
 * - Engagement timeline line chart with peak/dip highlighting
 * - Concept difficulty horizontal bar chart with color coding
 * - Participation distribution doughnut chart
 * - Responsive chart configurations
 * - Tooltips with detailed information
 * - WCAG AA compliant color schemes
 * - Text alternatives for accessibility
 *
 * @module     mod_classengage/analytics_charts
 * @copyright  2025 Your Name
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/analytics_charts",["core/chartjs","core/str"],(function(Chart,Str){const CHART_CONFIG_LABEL_MAX_LENGTH=40,CHART_CONFIG_POINT_RADIUS_HIGHLIGHT=6,CHART_CONFIG_POINT_RADIUS_NORMAL=3,CHART_CONFIG_POINT_RADIUS_HOVER=8,CHART_CONFIG_LINE_TENSION=.3,CHART_CONFIG_TITLE_FONT_SIZE=16,CHART_CONFIG_DIFFICULTY_EASY_THRESHOLD=70,CHART_CONFIG_DIFFICULTY_MODERATE_THRESHOLD=50,COLORS_TIMELINE_LINE="#0f6cbf",COLORS_TIMELINE_PEAK="#28a745",COLORS_TIMELINE_DIP="#fd7e14",COLORS_TIMELINE_BACKGROUND="rgba(15, 108, 191, 0.1)",COLORS_DIFFICULTY_EASY="#28a745",COLORS_DIFFICULTY_MODERATE="#ffc107",COLORS_DIFFICULTY_HARD="#dc3545",COLORS_PARTICIPATION_HIGH="#28a745",COLORS_PARTICIPATION_MODERATE="#17a2b8",COLORS_PARTICIPATION_LOW="#ffc107",COLORS_PARTICIPATION_NONE="#6c757d";let chartInstances={timeline:null,difficulty:null,distribution:null};const getCanvasContext=function(canvasId){const canvas=document.getElementById(canvasId);return canvas?{canvas:canvas,ctx:canvas.getContext("2d")}:(console.warn("Canvas "+canvasId+" not found"),null)},destroyChartIfExists=function(chartKey){chartInstances[chartKey]&&(chartInstances[chartKey].destroy(),chartInstances[chartKey]=null)},getCommonChartOptions=function(title,additionalOptions){const baseOptions={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:title,font:{size:CHART_CONFIG_TITLE_FONT_SIZE,weight:"bold"}}}};return additionalOptions&&(additionalOptions.plugins&&Object.assign(baseOptions.plugins,additionalOptions.plugins),Object.keys(additionalOptions).forEach((function(key){"plugins"!==key&&(baseOptions[key]=additionalOptions[key])}))),baseOptions},initEngagementTimeline=function(timelineData){const canvasData=getCanvasContext("engagement-timeline-chart");if(!canvasData)return;destroyChartIfExists("timeline");const chartData=timelineData.reduce((function(acc,interval){return acc.labels.push(interval.label),acc.counts.push(interval.count),interval.is_peak?(acc.pointBackgroundColors.push(COLORS_TIMELINE_PEAK),acc.pointRadius.push(CHART_CONFIG_POINT_RADIUS_HIGHLIGHT)):interval.is_dip?(acc.pointBackgroundColors.push(COLORS_TIMELINE_DIP),acc.pointRadius.push(CHART_CONFIG_POINT_RADIUS_HIGHLIGHT)):(acc.pointBackgroundColors.push(COLORS_TIMELINE_LINE),acc.pointRadius.push(CHART_CONFIG_POINT_RADIUS_NORMAL)),acc}),{labels:[],counts:[],pointBackgroundColors:[],pointRadius:[]});Str.get_strings([{key:"engagementtimeline",component:"mod_classengage"},{key:"timelinepeak",component:"mod_classengage"},{key:"timelinedip",component:"mod_classengage"}]).then((function(strings){const chartTitle=strings[0],peakLabel=strings[1],dipLabel=strings[2],options=getCommonChartOptions(chartTitle,{plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(context){const interval=timelineData[context.dataIndex];let label=context.dataset.label+": "+context.parsed.y;return interval.is_peak?label+=" ("+peakLabel+")":interval.is_dip&&(label+=" ("+dipLabel+")"),label}}}},scales:{x:{title:{display:!0,text:"Time"},grid:{display:!1}},y:{title:{display:!0,text:"Response Count"},beginAtZero:!0,ticks:{precision:0}}}});return chartInstances.timeline=new Chart(canvasData.ctx,{type:"line",data:{labels:chartData.labels,datasets:[{label:chartTitle,data:chartData.counts,borderColor:COLORS_TIMELINE_LINE,backgroundColor:COLORS_TIMELINE_BACKGROUND,pointBackgroundColor:chartData.pointBackgroundColors,pointBorderColor:chartData.pointBackgroundColors,pointRadius:chartData.pointRadius,pointHoverRadius:CHART_CONFIG_POINT_RADIUS_HOVER,fill:!0,tension:CHART_CONFIG_LINE_TENSION}]},options:options}),canvasData.canvas.setAttribute("aria-label",chartTitle+". "+generateTimelineTextAlternative(timelineData)),!0})).catch((function(error){console.error("Failed to load language strings for timeline chart:",error)}))},initConceptDifficulty=function(difficultyData){const canvasData=getCanvasContext("concept-difficulty-chart");if(!canvasData)return;destroyChartIfExists("difficulty");const labels=difficultyData.map((function(concept){const text=concept.question_text;return text.length>CHART_CONFIG_LABEL_MAX_LENGTH?text.substring(0,CHART_CONFIG_LABEL_MAX_LENGTH)+"...":text})),correctnessRates=difficultyData.map((function(concept){return concept.correctness_rate})),backgroundColors=difficultyData.map((function(concept){return(correctnessRate=concept.correctness_rate)>=CHART_CONFIG_DIFFICULTY_EASY_THRESHOLD?COLORS_DIFFICULTY_EASY:correctnessRate>=CHART_CONFIG_DIFFICULTY_MODERATE_THRESHOLD?COLORS_DIFFICULTY_MODERATE:COLORS_DIFFICULTY_HARD;var correctnessRate}));Str.get_strings([{key:"conceptdifficulty",component:"mod_classengage"}]).then((function(strings){const chartTitle=strings[0],options=getCommonChartOptions(chartTitle,{indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(context){return difficultyData[context[0].dataIndex].question_text},label:function(context){return"Correctness: "+context.parsed.x.toFixed(1)+"%"}}}},scales:{x:{title:{display:!0,text:"Correctness Rate (%)"},beginAtZero:!0,max:100,ticks:{callback:function(value){return value+"%"}}},y:{title:{display:!1}}}});return chartInstances.difficulty=new Chart(canvasData.ctx,{type:"bar",data:{labels:labels,datasets:[{label:"Correctness Rate (%)",data:correctnessRates,backgroundColor:backgroundColors,borderColor:backgroundColors,borderWidth:1}]},options:options}),canvasData.canvas.setAttribute("aria-label",chartTitle+". "+generateDifficultyTextAlternative(difficultyData)),!0})).catch((function(error){console.error("Failed to load language strings for difficulty chart:",error)}))},initParticipationDistribution=function(distributionData){const canvasData=getCanvasContext("participation-distribution-chart");canvasData&&(destroyChartIfExists("distribution"),Str.get_strings([{key:"participationdistribution",component:"mod_classengage"},{key:"participationhigh",component:"mod_classengage"},{key:"participationmoderate",component:"mod_classengage"},{key:"participationlow",component:"mod_classengage"},{key:"participationnone",component:"mod_classengage"}]).then((function(strings){const chartTitle=strings[0],labels=[strings[1],strings[2],strings[3],strings[4]],data=[distributionData.high||0,distributionData.moderate||0,distributionData.low||0,distributionData.none||0],backgroundColors=[COLORS_PARTICIPATION_HIGH,COLORS_PARTICIPATION_MODERATE,COLORS_PARTICIPATION_LOW,COLORS_PARTICIPATION_NONE],totalStudents=data.reduce((function(sum,count){return sum+count}),0),options=getCommonChartOptions(chartTitle,{plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(context){const count=context.parsed,percentage=totalStudents>0?(count/totalStudents*100).toFixed(1):0;return context.label+": "+count+" ("+percentage+"%)"}}}}});return chartInstances.distribution=new Chart(canvasData.ctx,{type:"doughnut",data:{labels:labels,datasets:[{data:data,backgroundColor:backgroundColors,borderColor:"#fff",borderWidth:2}]},options:options}),canvasData.canvas.setAttribute("aria-label",chartTitle+". "+generateDistributionTextAlternative(distributionData)),!0})).catch((function(error){console.error("Failed to load language strings for distribution chart:",error)})))},generateTimelineTextAlternative=function(timelineData){if(!timelineData||0===timelineData.length)return"No timeline data available.";const totalIntervals=timelineData.length,totalResponses=timelineData.reduce(((sum,interval)=>sum+interval.count),0),avgResponses=(totalResponses/totalIntervals).toFixed(1),peaks=timelineData.filter((interval=>interval.is_peak)),dips=timelineData.filter((interval=>interval.is_dip));let description=`Timeline shows ${totalIntervals} intervals with ${totalResponses} total responses, averaging ${avgResponses} responses per interval.`;return peaks.length>0&&(description+=` Peak engagement at ${peaks.map((p=>p.label)).join(", ")}.`),dips.length>0&&(description+=` Attention dips at ${dips.map((d=>d.label)).join(", ")}.`),description},generateDifficultyTextAlternative=function(difficultyData){if(!difficultyData||0===difficultyData.length)return"No concept difficulty data available.";const totalConcepts=difficultyData.length;return`Chart shows ${totalConcepts} concepts with average correctness of ${(difficultyData.reduce(((sum,c)=>sum+c.correctness_rate),0)/totalConcepts).toFixed(1)}%. ${difficultyData.filter((c=>c.correctness_rate<50)).length} difficult, ${difficultyData.filter((c=>c.correctness_rate>=50&&c.correctness_rate<70)).length} moderate, ${difficultyData.filter((c=>c.correctness_rate>=70)).length} well-understood.`},generateDistributionTextAlternative=function(distributionData){const high=distributionData.high||0,moderate=distributionData.moderate||0,low=distributionData.low||0,none=distributionData.none||0,total=high+moderate+low+none;return 0===total?"No participation data available.":`Distribution of ${total} students: ${high} high participation, ${moderate} moderate, ${low} low, ${none} no participation.`};return{init:function(chartData){chartData&&"object"==typeof chartData?(chartData.timeline&&Array.isArray(chartData.timeline)&&initEngagementTimeline(chartData.timeline),chartData.difficulty&&Array.isArray(chartData.difficulty)&&initConceptDifficulty(chartData.difficulty),chartData.distribution&&"object"==typeof chartData.distribution&&initParticipationDistribution(chartData.distribution)):console.error("Invalid chart data provided")},initEngagementTimeline:initEngagementTimeline,initConceptDifficulty:initConceptDifficulty,initParticipationDistribution:initParticipationDistribution,destroyCharts:function(){Object.keys(chartInstances).forEach((function(key){chartInstances[key]&&(chartInstances[key].destroy(),chartInstances[key]=null)}))}}}));

//# sourceMappingURL=analytics_charts.min.js.map