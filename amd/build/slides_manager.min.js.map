{"version":3,"file":"slides_manager.min.js","sources":["../src/slides_manager.js"],"sourcesContent":["/**\n * Slides manager with NLP generation - enterprise edition\n *\n * ARCHITECTURE:\n * - Requests enqueue work (AJAX to slides_api.php?action=generatenlp)\n * - Workers do work (adhoc task via cron)\n * - UI observes state (polling slides_api.php?action=nlpstatus)\n *\n * Key principles:\n * - Poll job status at a fixed interval (no fake progress)\n * - Stop polling immediately when status is completed or failed\n * - Disable generate button while job is pending or running\n * - Resume polling for active jobs on page load\n *\n * @module     mod_classengage/slides_manager\n * @copyright  2025 Danielle\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification', 'core/str'], function($, Notification, Str) {\n\n    // Polling interval in milliseconds.\n    var POLL_INTERVAL = 1500;\n\n    // Status messages for progress display.\n    var STATUS_MESSAGES = {\n        'idle': 'Ready to generate',\n        'pending': 'Queued for processing...',\n        'running': 'Generating questions...',\n        'completed': 'Questions generated!',\n        'failed': 'Generation failed'\n    };\n\n    // Progress messages based on percentage.\n    var PROGRESS_MESSAGES = {\n        10: 'Initializing NLP engine...',\n        20: 'Analyzing slide content...',\n        40: 'Extracting key concepts...',\n        60: 'Processing with NLP engine...',\n        90: 'Finalizing questions...',\n        100: 'Complete!'\n    };\n\n    /**\n     * Get progress message based on percentage.\n     * @param {number} progress - Progress percentage.\n     * @returns {string} Progress message.\n     */\n    function getProgressMessage(progress) {\n        var message = 'Processing...';\n        var thresholds = [10, 20, 40, 60, 90, 100];\n        for (var i = thresholds.length - 1; i >= 0; i--) {\n            if (progress >= thresholds[i]) {\n                message = PROGRESS_MESSAGES[thresholds[i]];\n                break;\n            }\n        }\n        return message;\n    }\n\n    return {\n        /** Active polling intervals by slide ID */\n        activePollers: {},\n\n        /** Configuration object */\n        config: {},\n\n        /**\n         * Initialize the slides manager.\n         * @param {Object} config - Configuration object with cmid.\n         */\n        init: function(config) {\n            this.config = config || {};\n            this.setupGenerateHandlers();\n            this.setupResetHandlers();\n            this.resumeActiveJobs();\n        },\n\n        /**\n         * Resume polling for any slides with active jobs on page load.\n         * This ensures progress continues to display after page refresh.\n         */\n        resumeActiveJobs: function() {\n            var self = this;\n            $('.classengage-slide-card').each(function() {\n                var card = $(this);\n                var status = card.data('nlp-status');\n                var slideid = card.data('slideid');\n\n                if (status === 'pending' || status === 'running') {\n                    var progress = parseInt(card.data('nlp-progress') || 0, 10);\n                    self.showProgressOverlay(card, status, progress);\n                    self.startPolling(slideid, card);\n                }\n            });\n        },\n\n        /**\n         * Set up click handlers for generate buttons.\n         */\n        setupGenerateHandlers: function() {\n            var self = this;\n\n            $(document).on('click', '.btn-generate-nlp', function(e) {\n                e.preventDefault();\n                var btn = $(this);\n                var slideId = parseInt(btn.data('slideid'), 10);\n                var card = btn.closest('.classengage-slide-card');\n\n                // Disable button while job is pending/running (single-flight enforcement).\n                if (btn.prop('disabled') || btn.hasClass('disabled')) {\n                    return;\n                }\n\n                self.enqueueJob(slideId, card, btn);\n            });\n        },\n\n        /**\n         * Set up click handlers for reset/dismiss buttons.\n         */\n        setupResetHandlers: function() {\n            var self = this;\n\n            $(document).on('click', '.nlp-dismiss-btn', function(e) {\n                e.preventDefault();\n                var overlay = $(this).closest('.nlp-progress-overlay');\n                var card = overlay.closest('.classengage-slide-card');\n                var slideid = parseInt(card.data('slideid'), 10);\n\n                // Call reset endpoint to allow retry.\n                self.resetJob(slideid, card, overlay);\n            });\n        },\n\n        /**\n         * Send NLP generation request (synchronous - waits for full response).\n         * @param {number} slideId - Slide ID.\n         * @param {jQuery} card - Card element.\n         * @param {jQuery} btn - Button element.\n         */\n        enqueueJob: function(slideId, card, btn) {\n            var self = this;\n\n            // Disable button immediately.\n            btn.prop('disabled', true).addClass('disabled');\n\n            // Show progress overlay with running state.\n            this.showProgressOverlay(card, 'running', 30);\n\n            // Make synchronous request to NLP service.\n            // Longer timeout since we're waiting for the full NLP response.\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/classengage/slides_api.php',\n                method: 'POST',\n                data: {\n                    action: 'generatenlp',\n                    slideid: slideId,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                timeout: 120000 // 2 minute timeout for NLP processing.\n            }).done(function(response) {\n                if (response.success && response.status === 'completed') {\n                    // Success - show result and reload.\n                    self.showSuccess(card, response.count);\n                } else {\n                    // Failed.\n                    self.showError(card, response.error || 'Generation failed');\n                    btn.prop('disabled', false).removeClass('disabled');\n                }\n            }).fail(function(xhr, status, error) {\n                var errorMsg = 'Network error: ' + (error || status);\n                if (status === 'timeout') {\n                    errorMsg = 'Request timed out. The NLP service may be slow or unavailable.';\n                }\n                self.showError(card, errorMsg);\n                btn.prop('disabled', false).removeClass('disabled');\n            });\n        },\n\n        /**\n         * Start polling job status at fixed interval.\n         * @param {number} slideId - Slide ID.\n         * @param {jQuery} card - Card element.\n         */\n        startPolling: function(slideId, card) {\n            var self = this;\n\n            // Clear any existing poller for this slide.\n            if (this.activePollers[slideId]) {\n                clearInterval(this.activePollers[slideId]);\n            }\n\n            this.activePollers[slideId] = setInterval(function() {\n                self.pollStatus(slideId, card);\n            }, POLL_INTERVAL);\n\n            // Also poll immediately.\n            this.pollStatus(slideId, card);\n        },\n\n        /**\n         * Poll status endpoint for authoritative progress from database.\n         * @param {number} slideId - Slide ID.\n         * @param {jQuery} card - Card element.\n         */\n        pollStatus: function(slideId, card) {\n            var self = this;\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/classengage/slides_api.php',\n                method: 'POST',\n                data: {\n                    action: 'nlpstatus',\n                    slideid: slideId,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json',\n                timeout: 5000\n            }).done(function(response) {\n                if (!response.success) {\n                    // Don't stop polling on transient errors.\n                    return;\n                }\n\n                self.updateProgress(card, response.status, response.progress);\n\n                // Terminal states - stop polling immediately.\n                if (response.status === 'completed') {\n                    self.stopPolling(slideId);\n                    self.showSuccess(card, response.count);\n                } else if (response.status === 'failed') {\n                    self.stopPolling(slideId);\n                    self.showError(card, response.error);\n                }\n            }).fail(function() {\n                // Ignore transient network failures, keep polling.\n            });\n        },\n\n        /**\n         * Stop polling for a slide to avoid unnecessary server load.\n         * @param {number} slideId - Slide ID.\n         */\n        stopPolling: function(slideId) {\n            if (this.activePollers[slideId]) {\n                clearInterval(this.activePollers[slideId]);\n                delete this.activePollers[slideId];\n            }\n        },\n\n        /**\n         * Show progress overlay within the card.\n         * @param {jQuery} card - Card element.\n         * @param {string} status - Current status.\n         * @param {number} progress - Progress percentage.\n         */\n        showProgressOverlay: function(card, status, progress) {\n            // Remove any existing overlay.\n            card.find('.nlp-progress-overlay').remove();\n\n            var message = STATUS_MESSAGES[status] || 'Processing...';\n            if (status === 'running' && progress > 0) {\n                message = getProgressMessage(progress);\n            }\n\n            var overlay = $(\n                '<div class=\"nlp-progress-overlay\">' +\n                    '<div class=\"nlp-progress-container\">' +\n                        '<div class=\"nlp-progress-icon\"><i class=\"fa fa-magic fa-pulse\"></i></div>' +\n                        '<div class=\"nlp-progress-title\">Generating Questions</div>' +\n                        '<div class=\"nlp-progress-bar-wrapper\">' +\n                            '<div class=\"nlp-progress-bar\" style=\"width: ' + progress + '%\">' +\n                                '<div class=\"nlp-progress-glow\"></div>' +\n                            '</div>' +\n                        '</div>' +\n                        '<div class=\"nlp-progress-text\">' + message + '</div>' +\n                    '</div>' +\n                '</div>'\n            );\n\n            card.find('.card-body').append(overlay);\n        },\n\n        /**\n         * Update progress bar and message.\n         * @param {jQuery} card - Card element.\n         * @param {string} status - Current status.\n         * @param {number} progress - Progress percentage.\n         */\n        updateProgress: function(card, status, progress) {\n            var overlay = card.find('.nlp-progress-overlay');\n            if (!overlay.length) {\n                this.showProgressOverlay(card, status, progress);\n                return;\n            }\n\n            overlay.find('.nlp-progress-bar').css('width', progress + '%');\n\n            var message = STATUS_MESSAGES[status] || 'Processing...';\n            if (status === 'running' && progress > 0) {\n                message = getProgressMessage(progress);\n            }\n            overlay.find('.nlp-progress-text').text(message);\n        },\n\n        /**\n         * Show success state.\n         * @param {jQuery} card - Card element.\n         * @param {number} count - Number of questions generated.\n         */\n        showSuccess: function(card, count) {\n            var overlay = card.find('.nlp-progress-overlay');\n            if (!overlay.length) {\n                return;\n            }\n\n            overlay.find('.nlp-progress-bar').css('width', '100%');\n            overlay.find('.nlp-progress-icon').html('<i class=\"fa fa-check-circle\"></i>');\n            overlay.find('.nlp-progress-title').text('Success!');\n            overlay.find('.nlp-progress-text').text(count + ' questions generated');\n            overlay.addClass('nlp-success');\n            overlay.find('.nlp-progress-glow').remove();\n\n            // Reload page after brief delay to show updated state.\n            setTimeout(function() {\n                location.reload();\n            }, 1500);\n        },\n\n        /**\n         * Show error state with dismiss button.\n         * @param {jQuery} card - Card element.\n         * @param {string} error - Error message.\n         */\n        showError: function(card, error) {\n            var overlay = card.find('.nlp-progress-overlay');\n\n            if (!overlay.length) {\n                this.showProgressOverlay(card, 'failed', 0);\n                overlay = card.find('.nlp-progress-overlay');\n            }\n\n            overlay.find('.nlp-progress-icon').html('<i class=\"fa fa-times-circle\"></i>');\n            overlay.find('.nlp-progress-title').text('Error');\n            overlay.find('.nlp-progress-text').text(error || 'Generation failed');\n            overlay.addClass('nlp-error');\n            overlay.find('.nlp-progress-bar-wrapper').hide();\n            overlay.find('.nlp-progress-glow').remove();\n\n            // Add dismiss button if not already present.\n            if (!overlay.find('.nlp-dismiss-btn').length) {\n                overlay.find('.nlp-progress-container').append(\n                    '<button class=\"btn btn-outline-danger btn-sm mt-3 nlp-dismiss-btn\">Dismiss</button>'\n                );\n            }\n        },\n\n        /**\n         * Reset a failed job to allow retry.\n         * @param {number} slideid - Slide ID.\n         * @param {jQuery} card - Card element.\n         * @param {jQuery} overlay - Overlay element.\n         */\n        resetJob: function(slideid, card, overlay) {\n            var self = this;\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/mod/classengage/slides_api.php',\n                method: 'POST',\n                data: {\n                    action: 'resetjob',\n                    slideid: slideid,\n                    sesskey: M.cfg.sesskey\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (response.success) {\n                    overlay.fadeOut(300, function() {\n                        overlay.remove();\n                        card.find('.btn-generate-nlp').prop('disabled', false).removeClass('disabled');\n                    });\n                } else {\n                    Notification.addNotification({\n                        message: response.error || 'Failed to reset job',\n                        type: 'error'\n                    });\n                }\n            }).fail(function() {\n                // Just remove the overlay on network error.\n                overlay.fadeOut(300, function() {\n                    overlay.remove();\n                    card.find('.btn-generate-nlp').prop('disabled', false).removeClass('disabled');\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","Str","STATUS_MESSAGES","PROGRESS_MESSAGES","getProgressMessage","progress","message","thresholds","i","length","activePollers","config","init","setupGenerateHandlers","setupResetHandlers","resumeActiveJobs","self","this","each","card","status","data","slideid","parseInt","showProgressOverlay","startPolling","document","on","e","preventDefault","btn","slideId","closest","prop","hasClass","enqueueJob","overlay","resetJob","addClass","ajax","url","M","cfg","wwwroot","method","action","sesskey","dataType","timeout","done","response","success","showSuccess","count","showError","error","removeClass","fail","xhr","errorMsg","clearInterval","setInterval","pollStatus","updateProgress","stopPolling","find","remove","append","css","text","html","setTimeout","location","reload","hide","fadeOut","addNotification","type"],"mappings":"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"}