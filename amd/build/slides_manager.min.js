/**
 * Slides manager with NLP generation - enterprise edition
 *
 * ARCHITECTURE:
 * - Requests enqueue work (AJAX to slides_api.php?action=generatenlp)
 * - Workers do work (adhoc task via cron)
 * - UI observes state (polling slides_api.php?action=nlpstatus)
 *
 * Key principles:
 * - Poll job status at a fixed interval (no fake progress)
 * - Stop polling immediately when status is completed or failed
 * - Disable generate button while job is pending or running
 * - Resume polling for active jobs on page load
 *
 * @module     mod_classengage/slides_manager
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/slides_manager",["jquery","core/notification","core/str"],(function($,Notification,Str){var STATUS_MESSAGES={idle:"Ready to generate",pending:"Queued for processing...",running:"Generating questions...",completed:"Questions generated!",failed:"Generation failed"},PROGRESS_MESSAGES={10:"Initializing NLP engine...",20:"Analyzing slide content...",40:"Extracting key concepts...",60:"Processing with NLP engine...",90:"Finalizing questions...",100:"Complete!"};function getProgressMessage(progress){for(var message="Processing...",thresholds=[10,20,40,60,90,100],i=thresholds.length-1;i>=0;i--)if(progress>=thresholds[i]){message=PROGRESS_MESSAGES[thresholds[i]];break}return message}return{activePollers:{},config:{},init:function(config){this.config=config||{},this.setupGenerateHandlers(),this.setupResetHandlers(),this.resumeActiveJobs()},resumeActiveJobs:function(){var self=this;$(".classengage-slide-card").each((function(){var card=$(this),status=card.data("nlp-status"),slideid=card.data("slideid");if("pending"===status||"running"===status){var progress=parseInt(card.data("nlp-progress")||0,10);self.showProgressOverlay(card,status,progress),self.startPolling(slideid,card)}}))},setupGenerateHandlers:function(){var self=this;$(document).on("click",".btn-generate-nlp",(function(e){e.preventDefault();var btn=$(this),slideId=parseInt(btn.data("slideid"),10),card=btn.closest(".classengage-slide-card");btn.prop("disabled")||btn.hasClass("disabled")||self.enqueueJob(slideId,card,btn)}))},setupResetHandlers:function(){var self=this;$(document).on("click",".nlp-dismiss-btn",(function(e){e.preventDefault();var overlay=$(this).closest(".nlp-progress-overlay"),card=overlay.closest(".classengage-slide-card"),slideid=parseInt(card.data("slideid"),10);self.resetJob(slideid,card,overlay)}))},enqueueJob:function(slideId,card,btn){var self=this;btn.prop("disabled",!0).addClass("disabled"),this.showProgressOverlay(card,"running",30),$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",method:"POST",data:{action:"generatenlp",slideid:slideId,sesskey:M.cfg.sesskey},dataType:"json",timeout:12e4}).done((function(response){response.success&&"completed"===response.status?self.showSuccess(card,response.count):(self.showError(card,response.error||"Generation failed"),btn.prop("disabled",!1).removeClass("disabled"))})).fail((function(xhr,status,error){var errorMsg="Network error: "+(error||status);"timeout"===status&&(errorMsg="Request timed out. The NLP service may be slow or unavailable."),self.showError(card,errorMsg),btn.prop("disabled",!1).removeClass("disabled")}))},startPolling:function(slideId,card){var self=this;this.activePollers[slideId]&&clearInterval(this.activePollers[slideId]),this.activePollers[slideId]=setInterval((function(){self.pollStatus(slideId,card)}),1500),this.pollStatus(slideId,card)},pollStatus:function(slideId,card){var self=this;$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",method:"POST",data:{action:"nlpstatus",slideid:slideId,sesskey:M.cfg.sesskey},dataType:"json",timeout:5e3}).done((function(response){response.success&&(self.updateProgress(card,response.status,response.progress),"completed"===response.status?(self.stopPolling(slideId),self.showSuccess(card,response.count)):"failed"===response.status&&(self.stopPolling(slideId),self.showError(card,response.error)))})).fail((function(){}))},stopPolling:function(slideId){this.activePollers[slideId]&&(clearInterval(this.activePollers[slideId]),delete this.activePollers[slideId])},showProgressOverlay:function(card,status,progress){card.find(".nlp-progress-overlay").remove();var message=STATUS_MESSAGES[status]||"Processing...";"running"===status&&progress>0&&(message=getProgressMessage(progress));var overlay=$('<div class="nlp-progress-overlay"><div class="nlp-progress-container"><div class="nlp-progress-icon"><i class="fa fa-magic fa-pulse"></i></div><div class="nlp-progress-title">Generating Questions</div><div class="nlp-progress-bar-wrapper"><div class="nlp-progress-bar" style="width: '+progress+'%"><div class="nlp-progress-glow"></div></div></div><div class="nlp-progress-text">'+message+"</div></div></div>");card.find(".card-body").append(overlay)},updateProgress:function(card,status,progress){var overlay=card.find(".nlp-progress-overlay");if(overlay.length){overlay.find(".nlp-progress-bar").css("width",progress+"%");var message=STATUS_MESSAGES[status]||"Processing...";"running"===status&&progress>0&&(message=getProgressMessage(progress)),overlay.find(".nlp-progress-text").text(message)}else this.showProgressOverlay(card,status,progress)},showSuccess:function(card,count){var overlay=card.find(".nlp-progress-overlay");overlay.length&&(overlay.find(".nlp-progress-bar").css("width","100%"),overlay.find(".nlp-progress-icon").html('<i class="fa fa-check-circle"></i>'),overlay.find(".nlp-progress-title").text("Success!"),overlay.find(".nlp-progress-text").text(count+" questions generated"),overlay.addClass("nlp-success"),overlay.find(".nlp-progress-glow").remove(),setTimeout((function(){location.reload()}),1500))},showError:function(card,error){var overlay=card.find(".nlp-progress-overlay");overlay.length||(this.showProgressOverlay(card,"failed",0),overlay=card.find(".nlp-progress-overlay")),overlay.find(".nlp-progress-icon").html('<i class="fa fa-times-circle"></i>'),overlay.find(".nlp-progress-title").text("Error"),overlay.find(".nlp-progress-text").text(error||"Generation failed"),overlay.addClass("nlp-error"),overlay.find(".nlp-progress-bar-wrapper").hide(),overlay.find(".nlp-progress-glow").remove(),overlay.find(".nlp-dismiss-btn").length||overlay.find(".nlp-progress-container").append('<button class="btn btn-outline-danger btn-sm mt-3 nlp-dismiss-btn">Dismiss</button>')},resetJob:function(slideid,card,overlay){$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",method:"POST",data:{action:"resetjob",slideid:slideid,sesskey:M.cfg.sesskey},dataType:"json"}).done((function(response){response.success?overlay.fadeOut(300,(function(){overlay.remove(),card.find(".btn-generate-nlp").prop("disabled",!1).removeClass("disabled")})):Notification.addNotification({message:response.error||"Failed to reset job",type:"error"})})).fail((function(){overlay.fadeOut(300,(function(){overlay.remove(),card.find(".btn-generate-nlp").prop("disabled",!1).removeClass("disabled")}))}))}}}));

//# sourceMappingURL=slides_manager.min.js.map