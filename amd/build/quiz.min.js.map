{"version":3,"file":"quiz.min.js","sources":["../src/quiz.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Student quiz interface with real-time updates\n *\n * SSE-only mode: Receives question broadcasts and session state updates\n * exclusively via Server-Sent Events. api.php is used only for\n * answer submissions and session operations.\n *\n * Requirements: 2.4, 4.5, 8.5\n *\n * @module     mod_classengage/quiz\n * @copyright  2025 Danielle\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'mod_classengage/connection_manager',\n    'mod_classengage/client_cache'\n], function ($, Ajax, Notification, Str, ConnectionManager, ClientCache) {\n\n    /**\n     * Quiz state constants\n     * @type {Object}\n     */\n    var STATE = {\n        WAITING: 'waiting',\n        ACTIVE: 'active',\n        PAUSED: 'paused',\n        COMPLETED: 'completed'\n    };\n\n    /**\n     * Quiz module instance\n     * @type {Object}\n     */\n    var Quiz = {\n        cmid: null,\n        sessionId: null,\n        currentQuestion: null,\n        pollingTimer: null,\n        countdownTimer: null,\n        isOnline: true,\n        pendingSubmission: null,\n        strings: {},\n\n        // Client-side timer state (enterprise timer separation)\n        timerState: {\n            serverTimeRemaining: 0,    // Last known server time remaining\n            serverTimestamp: 0,        // Server timestamp when we received the sync\n            clientStartTime: 0,        // Client timestamp when countdown started\n            isRunning: false,          // Whether countdown is active\n            isPaused: false,           // Whether timer is paused\n            lastSyncTime: 0            // Last time we synced with server\n        },\n\n        /**\n         * Initialize the quiz module\n         *\n         * @param {number} cmid Course module ID\n         * @param {number} sessionid Session ID\n         * @param {number} pollinginterval Polling interval in milliseconds\n         * @return {Promise} Resolves when initialized\n         */\n        init: function (cmid, sessionid, pollinginterval) {\n            var self = this;\n\n            this.cmid = cmid;\n            this.sessionId = sessionid;\n\n            // Load language strings\n            return this.loadStrings().then(function () {\n                // Initialize client cache for offline support\n                return ClientCache.init({\n                    maxRetries: 3,\n                    retryDelay: 2000\n                });\n            }).then(function () {\n                // Set up connection manager for client cache\n                ClientCache.setConnectionManager(ConnectionManager.getInstance());\n\n                // Initialize connection manager\n                return ConnectionManager.init(sessionid, {\n                    pollInterval: pollinginterval || 2000\n                });\n            }).then(function () {\n                // Set up event handlers\n                self.setupEventHandlers();\n                self.setupConnectionHandlers();\n                self.setupOfflineIndicator();\n\n                // Handle answer submission\n                $(document).on('click', '.submit-answer-btn', function () {\n                    self.submitAnswer();\n                });\n\n                // Handle touch events for mobile\n                $(document).on('touchend', '.quiz-option', function (e) {\n                    e.preventDefault();\n                    $(this).find('input[type=\"radio\"]').prop('checked', true);\n                    $(this).addClass('selected').siblings().removeClass('selected');\n                });\n\n                return null;\n            }).catch(function (error) {\n                // eslint-disable-next-line no-console\n                console.error('Quiz initialization error:', error);\n                // Fall back to legacy polling if connection manager fails\n                self.startLegacyPolling(pollinginterval);\n            });\n        },\n\n        /**\n         * Load required language strings\n         *\n         * @return {Promise} Resolves when strings are loaded\n         */\n        loadStrings: function () {\n            var self = this;\n            var stringKeys = [\n                { key: 'answersubmitted', component: 'mod_classengage' },\n                { key: 'correct', component: 'mod_classengage' },\n                { key: 'incorrect', component: 'mod_classengage' },\n                { key: 'correctanswer', component: 'mod_classengage' },\n                { key: 'waitingnextquestion', component: 'mod_classengage' },\n                { key: 'quizcompleted', component: 'mod_classengage' },\n                { key: 'alreadyanswered', component: 'mod_classengage' },\n                { key: 'selectanswer', component: 'mod_classengage' },\n                { key: 'error', component: 'core' },\n                { key: 'offline', component: 'mod_classengage' },\n                { key: 'reconnecting', component: 'mod_classengage' },\n                { key: 'connectionrestored', component: 'mod_classengage' },\n                { key: 'submittingoffline', component: 'mod_classengage' },\n                { key: 'pendingsubmissions', component: 'mod_classengage' }\n            ];\n\n            return Str.get_strings(stringKeys).then(function (strings) {\n                self.strings = {\n                    answersubmitted: strings[0],\n                    correct: strings[1],\n                    incorrect: strings[2],\n                    correctanswer: strings[3],\n                    waitingnextquestion: strings[4],\n                    quizcompleted: strings[5],\n                    alreadyanswered: strings[6],\n                    selectanswer: strings[7],\n                    error: strings[8],\n                    offline: strings[9] || 'Offline - responses will be saved locally',\n                    reconnecting: strings[10] || 'Reconnecting...',\n                    connectionrestored: strings[11] || 'Connection restored',\n                    submittingoffline: strings[12] || 'Saving response offline...',\n                    pendingsubmissions: strings[13] || 'Pending submissions'\n                };\n                return null;\n            }).catch(function () {\n                // Use fallback strings if loading fails\n                self.strings = {\n                    answersubmitted: 'Answer submitted!',\n                    correct: 'Correct!',\n                    incorrect: 'Incorrect',\n                    correctanswer: 'Correct Answer',\n                    waitingnextquestion: 'Waiting for next question...',\n                    quizcompleted: 'Quiz completed!',\n                    alreadyanswered: 'You have already answered this question',\n                    selectanswer: 'Please select an answer',\n                    error: 'Error',\n                    offline: 'Offline - responses will be saved locally',\n                    reconnecting: 'Reconnecting...',\n                    connectionrestored: 'Connection restored',\n                    submittingoffline: 'Saving response offline...',\n                    pendingsubmissions: 'Pending submissions'\n                };\n            });\n        },\n\n        /**\n         * Set up connection manager event handlers\n         */\n        setupConnectionHandlers: function () {\n            var self = this;\n\n            // Handle connection status changes\n            ConnectionManager.on('statuschange', function (data) {\n                self.handleConnectionStatusChange(data);\n            });\n\n            // Handle session state updates from server\n            ConnectionManager.on('state_update', function (data) {\n                self.handleStateUpdate(data);\n            });\n\n            // Handle question broadcasts\n            ConnectionManager.on('question_broadcast', function (data) {\n                self.handleQuestionBroadcast(data);\n            });\n\n            // Handle session events\n            ConnectionManager.on('session_started', function (data) {\n                self.handleSessionStarted(data);\n            });\n\n            ConnectionManager.on('session_paused', function (data) {\n                self.handleSessionPaused(data);\n            });\n\n            ConnectionManager.on('session_resumed', function (data) {\n                self.handleSessionResumed(data);\n            });\n\n            ConnectionManager.on('session_completed', function (data) {\n                self.handleSessionCompleted(data);\n            });\n\n            // Handle timer sync from server (only for drift correction)\n            ConnectionManager.on('timer_sync', function (data) {\n                self.syncServerTime(data);\n            });\n\n            // Handle reconnection\n            ConnectionManager.on('reconnected', function () {\n                self.handleReconnected();\n            });\n\n            // Handle disconnection\n            ConnectionManager.on('disconnected', function () {\n                self.handleDisconnected();\n            });\n        },\n\n        /**\n         * Set up client cache event handlers\n         */\n        setupEventHandlers: function () {\n            var self = this;\n\n            // Handle cached response submission\n            ClientCache.on('submitted', function (data) {\n                self.handleCachedResponseSubmitted(data);\n            });\n\n            // Handle retry events\n            ClientCache.on('retrying', function (data) {\n                self.showNotification('info', self.strings.pendingsubmissions + ': ' + data.count);\n            });\n\n            // Handle retry completion\n            ClientCache.on('retryComplete', function (data) {\n                var successCount = data.results.filter(function (r) {\n                    return r.success;\n                }).length;\n                if (successCount > 0) {\n                    self.showNotification('success', successCount + ' cached response(s) submitted');\n                }\n            });\n        },\n\n        /**\n         * Set up offline indicator UI element\n         */\n        setupOfflineIndicator: function () {\n            // Create offline indicator if it doesn't exist\n            if ($('#offline-indicator').length === 0) {\n                var indicator = $('<div id=\"offline-indicator\" class=\"offline-indicator\" style=\"display: none;\">' +\n                    '<span class=\"offline-icon\">&#9888;</span>' +\n                    '<span class=\"offline-text\"></span>' +\n                    '<span class=\"pending-count\"></span>' +\n                    '</div>');\n                $('#quiz-status').after(indicator);\n            }\n\n            // Listen for online/offline events\n            var self = this;\n            window.addEventListener('online', function () {\n                self.handleOnlineStatusChange(true);\n            });\n            window.addEventListener('offline', function () {\n                self.handleOnlineStatusChange(false);\n            });\n\n            // Check initial status\n            this.isOnline = navigator.onLine;\n            this.updateOfflineIndicator();\n        },\n\n        /**\n         * Handle online/offline status change\n         *\n         * @param {boolean} online Whether we're online\n         */\n        handleOnlineStatusChange: function (online) {\n            this.isOnline = online;\n            this.updateOfflineIndicator();\n\n            if (online) {\n                // Try to reconnect\n                ConnectionManager.reconnect().catch(function () {\n                    // Reconnection will be retried automatically\n                });\n            }\n        },\n\n        /**\n         * Handle connection status change from connection manager\n         *\n         * @param {Object} data Status change data\n         */\n        handleConnectionStatusChange: function (data) {\n            var status = data.status;\n            var transport = data.transport;\n\n            if (status === ConnectionManager.STATUS.CONNECTED) {\n                this.isOnline = true;\n                this.updateOfflineIndicator();\n                // Update transport indicator if needed\n                this.updateTransportIndicator(transport);\n            } else if (status === ConnectionManager.STATUS.RECONNECTING) {\n                this.showReconnectingIndicator();\n            } else if (status === ConnectionManager.STATUS.DISCONNECTED) {\n                this.isOnline = false;\n                this.updateOfflineIndicator();\n            }\n        },\n\n        /**\n         * Update offline indicator display\n         */\n        updateOfflineIndicator: function () {\n            var indicator = $('#offline-indicator');\n            var textSpan = indicator.find('.offline-text');\n            var pendingSpan = indicator.find('.pending-count');\n\n            if (!this.isOnline) {\n                textSpan.text(this.strings.offline);\n                indicator.removeClass('reconnecting').addClass('offline').show();\n            } else {\n                indicator.hide();\n            }\n\n            // Update pending count\n            var stats = ClientCache.getStats();\n            if (stats.pending > 0) {\n                pendingSpan.text(' (' + stats.pending + ' pending)').show();\n                indicator.show();\n            } else {\n                pendingSpan.hide();\n            }\n        },\n\n        /**\n         * Show reconnecting indicator\n         */\n        showReconnectingIndicator: function () {\n            var indicator = $('#offline-indicator');\n            indicator.find('.offline-text').text(this.strings.reconnecting);\n            indicator.removeClass('offline').addClass('reconnecting').show();\n        },\n\n        /**\n         * Update transport indicator (SSE vs polling)\n         *\n         * @param {string} transport Transport type\n         */\n        updateTransportIndicator: function (transport) {\n            var transportIndicator = $('#transport-indicator');\n            if (transportIndicator.length === 0) {\n                transportIndicator = $('<span id=\"transport-indicator\" class=\"transport-indicator\"></span>');\n                $('#quiz-status').append(transportIndicator);\n            }\n\n            if (transport === ConnectionManager.TRANSPORT.SSE) {\n                transportIndicator.text('Real-time').addClass('realtime');\n            } else if (transport === ConnectionManager.TRANSPORT.POLLING) {\n                transportIndicator.text('Polling').removeClass('realtime');\n            }\n        },\n\n        /**\n         * Handle state update from server\n         *\n         * @param {Object} data State update data\n         */\n        handleStateUpdate: function (data) {\n            if (data.question) {\n                this.updateQuestionDisplay({\n                    success: true,\n                    status: data.status,\n                    question: data.question\n                });\n            }\n\n            if (data.status === STATE.COMPLETED) {\n                this.handleSessionCompleted(data);\n            } else if (data.status === STATE.PAUSED) {\n                this.handleSessionPaused(data);\n            }\n        },\n\n        /**\n         * Handle question broadcast from server\n         *\n         * @param {Object} data Question data\n         */\n        handleQuestionBroadcast: function (data) {\n            this.currentQuestion = data.question;\n            this.displayQuestion(data.question);\n\n            // Start local countdown timer with timelimit from server\n            // Timer is fully client-side - server validates on submission\n            var timelimit = data.timelimit || (data.question && data.question.timelimit) || 0;\n            if (timelimit > 0) {\n                this.startLocalCountdown(timelimit);\n            }\n        },\n\n        /**\n         * Handle session started event\n         *\n         * @param {Object} data Session data\n         */\n        handleSessionStarted: function (data) {\n            $('#quiz-status').removeClass('alert-warning').addClass('alert-info');\n            if (data.question) {\n                this.currentQuestion = data.question;\n                this.displayQuestion(data.question);\n            }\n        },\n\n        /**\n         * Handle session paused event\n         *\n         * @param {Object} data Session data\n         */\n        handleSessionPaused: function (data) {\n            var container = $('#question-container');\n            container.find('.submit-answer-btn').prop('disabled', true);\n            this.showNotification('warning', 'Quiz paused by instructor');\n\n            // Show paused overlay\n            if ($('.paused-overlay').length === 0) {\n                container.append('<div class=\"paused-overlay\"><span>Quiz Paused</span></div>');\n            }\n\n            // Pause local countdown\n            this.pauseLocalCountdown();\n\n            // Store remaining time if provided\n            if (data.timerRemaining !== undefined) {\n                this.pausedTimerRemaining = data.timerRemaining;\n            }\n        },\n\n        /**\n         * Handle session resumed event\n         *\n         * @param {Object} data Session data\n         */\n        handleSessionResumed: function (data) {\n            var container = $('#question-container');\n            container.find('.submit-answer-btn').prop('disabled', false);\n            container.find('.paused-overlay').remove();\n            this.showNotification('info', 'Quiz resumed');\n\n            // Resume local countdown\n            if (data.timerRemaining !== undefined) {\n                this.resumeLocalCountdown(data.timerRemaining);\n            } else {\n                this.resumeLocalCountdown();\n            }\n        },\n\n        /**\n         * Handle session completed event\n         *\n         * @param {Object} data Session data\n         */\n        handleSessionCompleted: function (data) {\n            var container = $('#question-container');\n            var statusDiv = $('#quiz-status');\n\n            statusDiv.removeClass('alert-info').addClass('alert-success');\n\n            var scoreText = data.score !== undefined ? ' Your score: ' + data.score : '';\n            statusDiv.html(this.strings.quizcompleted + scoreText);\n\n            container.html('<div class=\"alert alert-success\">' +\n                '<h4>' + this.strings.quizcompleted + '</h4>' +\n                (data.score !== undefined ? '<p>Your score: ' + data.score + '</p>' : '') +\n                '</div>');\n\n            this.stopPolling();\n            ConnectionManager.disconnect();\n        },\n\n        /**\n         * Handle reconnection\n         */\n        handleReconnected: function () {\n            this.isOnline = true;\n            this.updateOfflineIndicator();\n            this.showNotification('success', this.strings.connectionrestored);\n\n            // Request current state\n            ConnectionManager.send('getstatus', {\n                sessionid: this.sessionId\n            }).then(function (response) {\n                if (response.success && response.session) {\n                    this.handleStateUpdate(response.session);\n                }\n                return null;\n            }.bind(this)).catch(function () {\n                // Ignore errors, state will sync on next update\n            });\n        },\n\n        /**\n         * Handle disconnection\n         */\n        handleDisconnected: function () {\n            this.isOnline = false;\n            this.updateOfflineIndicator();\n        },\n\n        /**\n         * Handle cached response submitted\n         *\n         * @param {Object} data Submission data\n         */\n        handleCachedResponseSubmitted: function (data) {\n            this.showNotification('success', 'Cached response submitted: ' + data.id);\n            this.updateOfflineIndicator();\n        },\n\n        /**\n         * Submit answer with optimistic UI update\n         */\n        submitAnswer: function () {\n            var self = this;\n            var selectedAnswer = $('input[name=\"answer\"]:checked').val();\n\n            if (!selectedAnswer) {\n                Notification.alert(this.strings.error, this.strings.selectanswer);\n                return;\n            }\n\n            if (!this.currentQuestion) {\n                return;\n            }\n\n            var questionId = this.currentQuestion.id;\n            var clientTimestamp = Date.now();\n\n            // Optimistic UI update (Requirement 8.5)\n            this.showOptimisticSubmission();\n\n            // Disable submit button to prevent double submission\n            $('.submit-answer-btn').prop('disabled', true);\n\n            // Check if we're online\n            if (!this.isOnline || !ConnectionManager.getStatus().connected) {\n                // Store in cache for later submission (Requirement 4.5)\n                this.submitOffline(questionId, selectedAnswer, clientTimestamp);\n                return;\n            }\n\n            // Submit via connection manager\n            ConnectionManager.send('submitanswer', {\n                sessionid: this.sessionId,\n                questionid: questionId,\n                answer: selectedAnswer,\n                clienttimestamp: clientTimestamp\n            }).then(function (response) {\n                self.handleSubmissionResponse(response);\n                return null;\n            }).catch(function (error) {\n                // Network error - cache the response\n                self.submitOffline(questionId, selectedAnswer, clientTimestamp);\n                // eslint-disable-next-line no-console\n                console.warn('Submission failed, cached offline:', error);\n            });\n        },\n\n        /**\n         * Show optimistic UI update before server confirmation (Requirement 8.5)\n         */\n        showOptimisticSubmission: function () {\n            var container = $('#question-container');\n\n            // Add submitting state\n            container.addClass('submitting');\n\n            // Show optimistic feedback\n            var feedbackDiv = container.find('.optimistic-feedback');\n            if (feedbackDiv.length === 0) {\n                feedbackDiv = $('<div class=\"optimistic-feedback\">' +\n                    '<span class=\"spinner\"></span> Submitting...' +\n                    '</div>');\n                container.find('.submit-answer-btn').after(feedbackDiv);\n            }\n            feedbackDiv.show();\n        },\n\n        /**\n         * Submit response offline\n         *\n         * @param {number} questionId Question ID\n         * @param {string} answer Selected answer\n         * @param {number} clientTimestamp Client timestamp\n         */\n        submitOffline: function (questionId, answer, clientTimestamp) {\n            var self = this;\n\n            // Show offline submission feedback\n            this.showNotification('info', this.strings.submittingoffline);\n\n            ClientCache.storeResponse({\n                sessionId: this.sessionId,\n                questionId: questionId,\n                answer: answer,\n                clientTimestamp: clientTimestamp\n            }).then(function () {\n                self.showOfflineSubmissionConfirmation();\n                self.updateOfflineIndicator();\n                return null;\n            }).catch(function (error) {\n                // eslint-disable-next-line no-console\n                console.error('Failed to cache response:', error);\n                Notification.exception({ message: 'Failed to save response offline' });\n                $('.submit-answer-btn').prop('disabled', false);\n            });\n        },\n\n        /**\n         * Show offline submission confirmation\n         */\n        showOfflineSubmissionConfirmation: function () {\n            var container = $('#question-container');\n            container.removeClass('submitting');\n            container.find('.optimistic-feedback').remove();\n\n            container.html(\n                '<div class=\"alert alert-info\">' +\n                '<h4>' + this.strings.answersubmitted + '</h4>' +\n                '<p>' + this.strings.offline + '</p>' +\n                '<p>' + this.strings.waitingnextquestion + '</p>' +\n                '</div>'\n            );\n        },\n\n        /**\n         * Handle submission response from server\n         *\n         * @param {Object} response Server response\n         */\n        handleSubmissionResponse: function (response) {\n            var container = $('#question-container');\n            container.removeClass('submitting');\n            container.find('.optimistic-feedback').remove();\n\n            if (response.success) {\n                var message = response.iscorrect ? this.strings.correct : this.strings.incorrect;\n                var alertClass = response.iscorrect ? 'success' : 'warning';\n\n                var html = '<div class=\"alert alert-' + alertClass + '\">' +\n                    '<h4>' + message + '</h4>';\n\n                if (response.correctanswer) {\n                    html += '<p>' + this.strings.correctanswer + ': ' + response.correctanswer + '</p>';\n                }\n\n                if (response.islate) {\n                    html += '<p class=\"text-muted\"><em>Response recorded as late</em></p>';\n                }\n\n                html += '<p>' + this.strings.waitingnextquestion + '</p>' +\n                    '</div>';\n\n                container.html(html);\n\n                // Visual confirmation (Requirement 2.4)\n                this.showVisualConfirmation(response.iscorrect);\n            } else {\n                // Handle error\n                if (response.error && response.error.indexOf('Duplicate') !== -1) {\n                    container.html('<div class=\"alert alert-info\">' + this.strings.alreadyanswered + '</div>');\n                } else {\n                    Notification.exception({ message: response.error || 'Error submitting answer' });\n                    $('.submit-answer-btn').prop('disabled', false);\n                }\n            }\n        },\n\n        /**\n         * Show visual confirmation of answer submission (Requirement 2.4)\n         *\n         * @param {boolean} isCorrect Whether the answer was correct\n         */\n        showVisualConfirmation: function (isCorrect) {\n            var confirmationClass = isCorrect ? 'confirmation-correct' : 'confirmation-incorrect';\n\n            // Create confirmation overlay\n            var overlay = $('<div class=\"submission-confirmation ' + confirmationClass + '\">' +\n                '<span class=\"confirmation-icon\">' + (isCorrect ? '✓' : '✗') + '</span>' +\n                '</div>');\n\n            $('body').append(overlay);\n\n            // Animate and remove\n            setTimeout(function () {\n                overlay.addClass('fade-out');\n                setTimeout(function () {\n                    overlay.remove();\n                }, 300);\n            }, 500);\n        },\n\n        /**\n         * Show notification message\n         *\n         * @param {string} type Notification type (success, info, warning, error)\n         * @param {string} message Message to display\n         */\n        showNotification: function (type, message) {\n            var notificationArea = $('#quiz-notifications');\n            if (notificationArea.length === 0) {\n                notificationArea = $('<div id=\"quiz-notifications\" class=\"quiz-notifications\"></div>');\n                $('#quiz-status').before(notificationArea);\n            }\n\n            var alertClass = 'alert-' + (type === 'error' ? 'danger' : type);\n            var notification = $('<div class=\"alert ' + alertClass + ' notification-toast\">' + message + '</div>');\n\n            notificationArea.append(notification);\n\n            // Auto-dismiss after 3 seconds\n            setTimeout(function () {\n                notification.fadeOut(function () {\n                    $(this).remove();\n                });\n            }, 3000);\n        },\n\n        /**\n         * Update question display\n         *\n         * @param {Object} response Server response with question data\n         */\n        updateQuestionDisplay: function (response) {\n            var container = $('#question-container');\n            var statusDiv = $('#quiz-status');\n\n            if (!response.success || response.status !== 'active') {\n                container.html('');\n                if (response.status === 'completed') {\n                    statusDiv.removeClass('alert-info').addClass('alert-success');\n                    statusDiv.html(this.strings.quizcompleted);\n                    this.stopPolling();\n                } else if (response.status === 'paused') {\n                    statusDiv.html('Quiz is paused');\n                } else {\n                    statusDiv.html(this.strings.waitingnextquestion);\n                }\n                return;\n            }\n\n            var question = response.question;\n\n            if (!question) {\n                container.html('<p>' + this.strings.waitingnextquestion + '</p>');\n                return;\n            }\n\n            // Check if this is a new question\n            if (this.currentQuestion === null || this.currentQuestion.id !== question.id) {\n                this.currentQuestion = question;\n                this.displayQuestion(question);\n            }\n\n            // Update timer\n            this.updateTimer(question.timeremaining);\n\n            // Update question number\n            statusDiv.html('Question ' + question.number + ' of ' + question.total);\n        },\n\n        /**\n         * Display a question\n         *\n         * @param {Object} question Question data\n         */\n        displayQuestion: function (question) {\n            var html = '<div class=\"question-text mb-4\">';\n            html += '<h4>' + question.text + '</h4>';\n            html += '</div>';\n\n            if (question.answered) {\n                html += '<div class=\"alert alert-info\">' + this.strings.alreadyanswered + '</div>';\n            } else {\n                html += '<form id=\"answer-form\">';\n                html += '<div class=\"question-options\">';\n\n                for (var i = 0; i < question.options.length; i++) {\n                    var option = question.options[i];\n                    html += '<div class=\"quiz-option\" data-option=\"' + option.key + '\">';\n                    html += '<label class=\"quiz-option-label\">';\n                    html += '<input type=\"radio\" name=\"answer\" value=\"' + option.key + '\" required> ';\n                    html += '<span class=\"option-key\">' + option.key + '</span>';\n                    html += '<span class=\"option-text\">' + option.text + '</span>';\n                    html += '</label>';\n                    html += '</div>';\n                }\n\n                html += '</div>';\n                html += '<button type=\"button\" class=\"btn btn-primary btn-lg submit-answer-btn mt-3\">';\n                html += this.strings.answersubmitted ? 'Submit Answer' : 'Submit Answer';\n                html += '</button>';\n                html += '</form>';\n            }\n\n            $('#question-container').html(html);\n        },\n\n        /**\n         * Update timer display (called by local countdown)\n         *\n         * @param {number} seconds Seconds remaining\n         */\n        updateTimerDisplay: function (seconds) {\n            var display = $('#timer-display');\n\n            if (seconds <= 0) {\n                display.text('0:00');\n                display.removeClass('warning').addClass('danger');\n                return;\n            }\n\n            var minutes = Math.floor(seconds / 60);\n            var secs = Math.floor(seconds % 60);\n            var timeStr = minutes + ':' + (secs < 10 ? '0' : '') + secs;\n\n            display.text(timeStr);\n\n            if (seconds <= 10) {\n                display.removeClass('warning').addClass('danger');\n            } else if (seconds <= 30) {\n                display.removeClass('danger').addClass('warning');\n            } else {\n                display.removeClass('warning danger');\n            }\n        },\n\n        /**\n         * Start local countdown timer (enterprise timer separation)\n         * Client runs its own timer to reduce server SSE traffic.\n         *\n         * @param {number} seconds Initial seconds remaining\n         */\n        startLocalCountdown: function (seconds) {\n            var self = this;\n\n            // Stop any existing countdown\n            if (this.countdownTimer) {\n                clearInterval(this.countdownTimer);\n                this.countdownTimer = null;\n            }\n\n            // Initialize timer state\n            this.timerState.serverTimeRemaining = seconds;\n            this.timerState.clientStartTime = Date.now();\n            this.timerState.isRunning = true;\n            this.timerState.isPaused = false;\n\n            // Update display immediately\n            this.updateTimerDisplay(seconds);\n\n            // Start client-side countdown (runs every 100ms for smooth updates)\n            this.countdownTimer = setInterval(function () {\n                if (!self.timerState.isRunning || self.timerState.isPaused) {\n                    return;\n                }\n\n                // Calculate elapsed time on client\n                var clientElapsed = (Date.now() - self.timerState.clientStartTime) / 1000;\n                var remaining = Math.max(0, self.timerState.serverTimeRemaining - clientElapsed);\n\n                self.updateTimerDisplay(remaining);\n\n                // Stop when timer reaches 0\n                if (remaining <= 0) {\n                    self.stopLocalCountdown();\n                }\n            }, 100); // 100ms for smooth visual updates\n        },\n\n        /**\n         * Stop local countdown timer\n         */\n        stopLocalCountdown: function () {\n            if (this.countdownTimer) {\n                clearInterval(this.countdownTimer);\n                this.countdownTimer = null;\n            }\n            this.timerState.isRunning = false;\n        },\n\n        /**\n         * Pause local countdown timer\n         */\n        pauseLocalCountdown: function () {\n            this.timerState.isPaused = true;\n            // Store remaining time when paused\n            var clientElapsed = (Date.now() - this.timerState.clientStartTime) / 1000;\n            this.timerState.serverTimeRemaining = Math.max(0, this.timerState.serverTimeRemaining - clientElapsed);\n            this.timerState.clientStartTime = Date.now();\n        },\n\n        /**\n         * Resume local countdown timer\n         *\n         * @param {number} seconds Seconds remaining from server (optional)\n         */\n        resumeLocalCountdown: function (seconds) {\n            if (seconds !== undefined) {\n                this.timerState.serverTimeRemaining = seconds;\n            }\n            this.timerState.clientStartTime = Date.now();\n            this.timerState.isPaused = false;\n        },\n\n        /**\n         * Sync server time and correct client drift (enterprise timer separation)\n         * Called on timer_sync events from server (sent every ~30s or on key events)\n         *\n         * @param {Object} data Timer sync data from server\n         */\n        syncServerTime: function (data) {\n            var serverRemaining = data.timerremaining;\n            var serverTimestamp = data.timestamp;\n\n            // Calculate what client thinks the time should be\n            var clientElapsed = (Date.now() - this.timerState.clientStartTime) / 1000;\n            var clientRemaining = Math.max(0, this.timerState.serverTimeRemaining - clientElapsed);\n\n            // Calculate drift (difference between server and client)\n            var drift = Math.abs(serverRemaining - clientRemaining);\n\n            // Only correct if drift > 2 seconds (enterprise threshold)\n            if (drift > 2 || !this.timerState.isRunning) {\n                // eslint-disable-next-line no-console\n                console.log('Timer sync: correcting drift of', drift.toFixed(1), 'seconds');\n                this.timerState.serverTimeRemaining = serverRemaining;\n                this.timerState.clientStartTime = Date.now();\n                this.timerState.serverTimestamp = serverTimestamp;\n            }\n\n            this.timerState.lastSyncTime = Date.now();\n\n            // Start countdown if not running\n            if (!this.timerState.isRunning && serverRemaining > 0) {\n                this.startLocalCountdown(serverRemaining);\n            }\n        },\n\n        /**\n         * Update timer (legacy method - starts local countdown)\n         *\n         * @param {number} seconds Seconds remaining\n         */\n        updateTimer: function (seconds) {\n            if (seconds === undefined || seconds === null) {\n                return;\n            }\n            // Start or sync local countdown\n            if (!this.timerState.isRunning) {\n                this.startLocalCountdown(seconds);\n            } else {\n                // Sync with new value\n                this.syncServerTime({ timerremaining: seconds, timestamp: Date.now() / 1000 });\n            }\n        },\n\n        /**\n         * Get current question via SSE connection\n         * Legacy polling removed - all data now comes via SSE events\n         * This method is kept for initial state fetch on connect failures\n         */\n        startLegacyPolling: function () {\n            // SSE-only mode: No polling fallback\n            // Show connection error notification\n            this.showNotification('error',\n                'SSE connection required. Please ensure your browser supports Server-Sent Events.');\n        },\n\n        /**\n         * Get current question - now SSE-only\n         * This method is kept for backward compatibility but SSE events\n         * are the primary source for question data\n         */\n        getCurrentQuestion: function () {\n            var self = this;\n\n            // Try ConnectionManager send for state refresh\n            ConnectionManager.send('getstatus', {\n                sessionid: this.sessionId\n            }).then(function (response) {\n                if (response && response.success && response.session) {\n                    self.handleStateUpdate(response.session);\n                }\n                return null;\n            }).catch(function () {\n                // SSE events will provide the data, ignore errors\n            });\n        },\n\n        /**\n         * Stop polling\n         */\n        stopPolling: function () {\n            if (this.pollingTimer) {\n                clearInterval(this.pollingTimer);\n                this.pollingTimer = null;\n            }\n            if (this.countdownTimer) {\n                clearInterval(this.countdownTimer);\n                this.countdownTimer = null;\n            }\n        }\n    };\n\n    return {\n        /**\n         * Initialize the quiz module\n         *\n         * @param {number} cmid Course module ID\n         * @param {number} sessionid Session ID\n         * @param {number} pollinginterval Polling interval\n         * @return {Promise} Resolves when initialized\n         */\n        init: function (cmid, sessionid, pollinginterval) {\n            return Quiz.init(cmid, sessionid, pollinginterval);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ConnectionManager","ClientCache","STATE","Quiz","cmid","sessionId","currentQuestion","pollingTimer","countdownTimer","isOnline","pendingSubmission","strings","timerState","serverTimeRemaining","serverTimestamp","clientStartTime","isRunning","isPaused","lastSyncTime","init","sessionid","pollinginterval","self","this","loadStrings","then","maxRetries","retryDelay","setConnectionManager","getInstance","pollInterval","setupEventHandlers","setupConnectionHandlers","setupOfflineIndicator","document","on","submitAnswer","e","preventDefault","find","prop","addClass","siblings","removeClass","catch","error","console","startLegacyPolling","get_strings","key","component","answersubmitted","correct","incorrect","correctanswer","waitingnextquestion","quizcompleted","alreadyanswered","selectanswer","offline","reconnecting","connectionrestored","submittingoffline","pendingsubmissions","data","handleConnectionStatusChange","handleStateUpdate","handleQuestionBroadcast","handleSessionStarted","handleSessionPaused","handleSessionResumed","handleSessionCompleted","syncServerTime","handleReconnected","handleDisconnected","handleCachedResponseSubmitted","showNotification","count","successCount","results","filter","r","success","length","indicator","after","window","addEventListener","handleOnlineStatusChange","navigator","onLine","updateOfflineIndicator","online","reconnect","status","transport","STATUS","CONNECTED","updateTransportIndicator","RECONNECTING","showReconnectingIndicator","DISCONNECTED","textSpan","pendingSpan","hide","text","show","stats","getStats","pending","transportIndicator","append","TRANSPORT","SSE","POLLING","question","updateQuestionDisplay","displayQuestion","timelimit","startLocalCountdown","container","pauseLocalCountdown","undefined","timerRemaining","pausedTimerRemaining","remove","resumeLocalCountdown","statusDiv","scoreText","score","html","stopPolling","disconnect","send","response","session","bind","id","selectedAnswer","val","questionId","clientTimestamp","Date","now","showOptimisticSubmission","getStatus","connected","questionid","answer","clienttimestamp","handleSubmissionResponse","submitOffline","warn","alert","feedbackDiv","storeResponse","showOfflineSubmissionConfirmation","exception","message","iscorrect","islate","showVisualConfirmation","indexOf","isCorrect","overlay","setTimeout","type","notificationArea","before","notification","fadeOut","updateTimer","timeremaining","number","total","answered","i","options","option","updateTimerDisplay","seconds","display","minutes","Math","floor","secs","timeStr","clearInterval","setInterval","clientElapsed","remaining","max","stopLocalCountdown","serverRemaining","timerremaining","timestamp","clientRemaining","drift","abs","log","toFixed","getCurrentQuestion"],"mappings":"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"}