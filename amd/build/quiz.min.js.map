{"version":3,"file":"quiz.min.js","sources":["../src/quiz.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * JavaScript for real-time quiz participation\r\n *\r\n * Enhanced with connection_manager for transport handling, client_cache for\r\n * offline support, offline indicator UI, and optimistic UI updates.\r\n *\r\n * Requirements: 2.4, 4.5, 8.5\r\n *\r\n * @module     mod_classengage/quiz\r\n * @copyright  2025 Danielle\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine([\r\n    'jquery',\r\n    'core/ajax',\r\n    'core/notification',\r\n    'core/str',\r\n    'mod_classengage/connection_manager',\r\n    'mod_classengage/client_cache'\r\n], function($, Ajax, Notification, Str, ConnectionManager, ClientCache) {\r\n\r\n    /**\r\n     * Quiz state constants\r\n     * @type {Object}\r\n     */\r\n    var STATE = {\r\n        WAITING: 'waiting',\r\n        ACTIVE: 'active',\r\n        PAUSED: 'paused',\r\n        COMPLETED: 'completed'\r\n    };\r\n\r\n    /**\r\n     * Quiz module instance\r\n     * @type {Object}\r\n     */\r\n    var Quiz = {\r\n        cmid: null,\r\n        sessionId: null,\r\n        currentQuestion: null,\r\n        pollingTimer: null,\r\n        countdownTimer: null,\r\n        isOnline: true,\r\n        pendingSubmission: null,\r\n        strings: {},\r\n\r\n        /**\r\n         * Initialize the quiz module\r\n         *\r\n         * @param {number} cmid Course module ID\r\n         * @param {number} sessionid Session ID\r\n         * @param {number} pollinginterval Polling interval in milliseconds\r\n         * @return {Promise} Resolves when initialized\r\n         */\r\n        init: function(cmid, sessionid, pollinginterval) {\r\n            var self = this;\r\n\r\n            this.cmid = cmid;\r\n            this.sessionId = sessionid;\r\n\r\n            // Load language strings\r\n            return this.loadStrings().then(function() {\r\n                // Initialize client cache for offline support\r\n                return ClientCache.init({\r\n                    maxRetries: 3,\r\n                    retryDelay: 2000\r\n                });\r\n            }).then(function() {\r\n                // Set up connection manager for client cache\r\n                ClientCache.setConnectionManager(ConnectionManager.getInstance());\r\n\r\n                // Initialize connection manager\r\n                return ConnectionManager.init(sessionid, {\r\n                    pollInterval: pollinginterval || 2000\r\n                });\r\n            }).then(function() {\r\n                // Set up event handlers\r\n                self.setupEventHandlers();\r\n                self.setupConnectionHandlers();\r\n                self.setupOfflineIndicator();\r\n\r\n                // Handle answer submission\r\n                $(document).on('click', '.submit-answer-btn', function() {\r\n                    self.submitAnswer();\r\n                });\r\n\r\n                // Handle touch events for mobile\r\n                $(document).on('touchend', '.quiz-option', function(e) {\r\n                    e.preventDefault();\r\n                    $(this).find('input[type=\"radio\"]').prop('checked', true);\r\n                    $(this).addClass('selected').siblings().removeClass('selected');\r\n                });\r\n\r\n                return null;\r\n            }).catch(function(error) {\r\n                // eslint-disable-next-line no-console\r\n                console.error('Quiz initialization error:', error);\r\n                // Fall back to legacy polling if connection manager fails\r\n                self.startLegacyPolling(pollinginterval);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Load required language strings\r\n         *\r\n         * @return {Promise} Resolves when strings are loaded\r\n         */\r\n        loadStrings: function() {\r\n            var self = this;\r\n            var stringKeys = [\r\n                {key: 'answersubmitted', component: 'mod_classengage'},\r\n                {key: 'correct', component: 'mod_classengage'},\r\n                {key: 'incorrect', component: 'mod_classengage'},\r\n                {key: 'correctanswer', component: 'mod_classengage'},\r\n                {key: 'waitingnextquestion', component: 'mod_classengage'},\r\n                {key: 'quizcompleted', component: 'mod_classengage'},\r\n                {key: 'alreadyanswered', component: 'mod_classengage'},\r\n                {key: 'selectanswer', component: 'mod_classengage'},\r\n                {key: 'error', component: 'core'},\r\n                {key: 'offline', component: 'mod_classengage'},\r\n                {key: 'reconnecting', component: 'mod_classengage'},\r\n                {key: 'connectionrestored', component: 'mod_classengage'},\r\n                {key: 'submittingoffline', component: 'mod_classengage'},\r\n                {key: 'pendingsubmissions', component: 'mod_classengage'}\r\n            ];\r\n\r\n            return Str.get_strings(stringKeys).then(function(strings) {\r\n                self.strings = {\r\n                    answersubmitted: strings[0],\r\n                    correct: strings[1],\r\n                    incorrect: strings[2],\r\n                    correctanswer: strings[3],\r\n                    waitingnextquestion: strings[4],\r\n                    quizcompleted: strings[5],\r\n                    alreadyanswered: strings[6],\r\n                    selectanswer: strings[7],\r\n                    error: strings[8],\r\n                    offline: strings[9] || 'Offline - responses will be saved locally',\r\n                    reconnecting: strings[10] || 'Reconnecting...',\r\n                    connectionrestored: strings[11] || 'Connection restored',\r\n                    submittingoffline: strings[12] || 'Saving response offline...',\r\n                    pendingsubmissions: strings[13] || 'Pending submissions'\r\n                };\r\n                return null;\r\n            }).catch(function() {\r\n                // Use fallback strings if loading fails\r\n                self.strings = {\r\n                    answersubmitted: 'Answer submitted!',\r\n                    correct: 'Correct!',\r\n                    incorrect: 'Incorrect',\r\n                    correctanswer: 'Correct Answer',\r\n                    waitingnextquestion: 'Waiting for next question...',\r\n                    quizcompleted: 'Quiz completed!',\r\n                    alreadyanswered: 'You have already answered this question',\r\n                    selectanswer: 'Please select an answer',\r\n                    error: 'Error',\r\n                    offline: 'Offline - responses will be saved locally',\r\n                    reconnecting: 'Reconnecting...',\r\n                    connectionrestored: 'Connection restored',\r\n                    submittingoffline: 'Saving response offline...',\r\n                    pendingsubmissions: 'Pending submissions'\r\n                };\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Set up connection manager event handlers\r\n         */\r\n        setupConnectionHandlers: function() {\r\n            var self = this;\r\n\r\n            // Handle connection status changes\r\n            ConnectionManager.on('statuschange', function(data) {\r\n                self.handleConnectionStatusChange(data);\r\n            });\r\n\r\n            // Handle session state updates from server\r\n            ConnectionManager.on('state_update', function(data) {\r\n                self.handleStateUpdate(data);\r\n            });\r\n\r\n            // Handle question broadcasts\r\n            ConnectionManager.on('question_broadcast', function(data) {\r\n                self.handleQuestionBroadcast(data);\r\n            });\r\n\r\n            // Handle session events\r\n            ConnectionManager.on('session_started', function(data) {\r\n                self.handleSessionStarted(data);\r\n            });\r\n\r\n            ConnectionManager.on('session_paused', function(data) {\r\n                self.handleSessionPaused(data);\r\n            });\r\n\r\n            ConnectionManager.on('session_resumed', function(data) {\r\n                self.handleSessionResumed(data);\r\n            });\r\n\r\n            ConnectionManager.on('session_completed', function(data) {\r\n                self.handleSessionCompleted(data);\r\n            });\r\n\r\n            // Handle timer sync\r\n            ConnectionManager.on('timer_sync', function(data) {\r\n                self.updateTimer(data.remaining);\r\n            });\r\n\r\n            // Handle reconnection\r\n            ConnectionManager.on('reconnected', function() {\r\n                self.handleReconnected();\r\n            });\r\n\r\n            // Handle disconnection\r\n            ConnectionManager.on('disconnected', function() {\r\n                self.handleDisconnected();\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Set up client cache event handlers\r\n         */\r\n        setupEventHandlers: function() {\r\n            var self = this;\r\n\r\n            // Handle cached response submission\r\n            ClientCache.on('submitted', function(data) {\r\n                self.handleCachedResponseSubmitted(data);\r\n            });\r\n\r\n            // Handle retry events\r\n            ClientCache.on('retrying', function(data) {\r\n                self.showNotification('info', self.strings.pendingsubmissions + ': ' + data.count);\r\n            });\r\n\r\n            // Handle retry completion\r\n            ClientCache.on('retryComplete', function(data) {\r\n                var successCount = data.results.filter(function(r) {\r\n                    return r.success;\r\n                }).length;\r\n                if (successCount > 0) {\r\n                    self.showNotification('success', successCount + ' cached response(s) submitted');\r\n                }\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Set up offline indicator UI element\r\n         */\r\n        setupOfflineIndicator: function() {\r\n            // Create offline indicator if it doesn't exist\r\n            if ($('#offline-indicator').length === 0) {\r\n                var indicator = $('<div id=\"offline-indicator\" class=\"offline-indicator\" style=\"display: none;\">' +\r\n                    '<span class=\"offline-icon\">&#9888;</span>' +\r\n                    '<span class=\"offline-text\"></span>' +\r\n                    '<span class=\"pending-count\"></span>' +\r\n                    '</div>');\r\n                $('#quiz-status').after(indicator);\r\n            }\r\n\r\n            // Listen for online/offline events\r\n            var self = this;\r\n            window.addEventListener('online', function() {\r\n                self.handleOnlineStatusChange(true);\r\n            });\r\n            window.addEventListener('offline', function() {\r\n                self.handleOnlineStatusChange(false);\r\n            });\r\n\r\n            // Check initial status\r\n            this.isOnline = navigator.onLine;\r\n            this.updateOfflineIndicator();\r\n        },\r\n\r\n        /**\r\n         * Handle online/offline status change\r\n         *\r\n         * @param {boolean} online Whether we're online\r\n         */\r\n        handleOnlineStatusChange: function(online) {\r\n            this.isOnline = online;\r\n            this.updateOfflineIndicator();\r\n\r\n            if (online) {\r\n                // Try to reconnect\r\n                ConnectionManager.reconnect().catch(function() {\r\n                    // Reconnection will be retried automatically\r\n                });\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle connection status change from connection manager\r\n         *\r\n         * @param {Object} data Status change data\r\n         */\r\n        handleConnectionStatusChange: function(data) {\r\n            var status = data.status;\r\n            var transport = data.transport;\r\n\r\n            if (status === ConnectionManager.STATUS.CONNECTED) {\r\n                this.isOnline = true;\r\n                this.updateOfflineIndicator();\r\n                // Update transport indicator if needed\r\n                this.updateTransportIndicator(transport);\r\n            } else if (status === ConnectionManager.STATUS.RECONNECTING) {\r\n                this.showReconnectingIndicator();\r\n            } else if (status === ConnectionManager.STATUS.DISCONNECTED) {\r\n                this.isOnline = false;\r\n                this.updateOfflineIndicator();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Update offline indicator display\r\n         */\r\n        updateOfflineIndicator: function() {\r\n            var indicator = $('#offline-indicator');\r\n            var textSpan = indicator.find('.offline-text');\r\n            var pendingSpan = indicator.find('.pending-count');\r\n\r\n            if (!this.isOnline) {\r\n                textSpan.text(this.strings.offline);\r\n                indicator.removeClass('reconnecting').addClass('offline').show();\r\n            } else {\r\n                indicator.hide();\r\n            }\r\n\r\n            // Update pending count\r\n            var stats = ClientCache.getStats();\r\n            if (stats.pending > 0) {\r\n                pendingSpan.text(' (' + stats.pending + ' pending)').show();\r\n                indicator.show();\r\n            } else {\r\n                pendingSpan.hide();\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Show reconnecting indicator\r\n         */\r\n        showReconnectingIndicator: function() {\r\n            var indicator = $('#offline-indicator');\r\n            indicator.find('.offline-text').text(this.strings.reconnecting);\r\n            indicator.removeClass('offline').addClass('reconnecting').show();\r\n        },\r\n\r\n        /**\r\n         * Update transport indicator (SSE vs polling)\r\n         *\r\n         * @param {string} transport Transport type\r\n         */\r\n        updateTransportIndicator: function(transport) {\r\n            var transportIndicator = $('#transport-indicator');\r\n            if (transportIndicator.length === 0) {\r\n                transportIndicator = $('<span id=\"transport-indicator\" class=\"transport-indicator\"></span>');\r\n                $('#quiz-status').append(transportIndicator);\r\n            }\r\n\r\n            if (transport === ConnectionManager.TRANSPORT.SSE) {\r\n                transportIndicator.text('Real-time').addClass('realtime');\r\n            } else if (transport === ConnectionManager.TRANSPORT.POLLING) {\r\n                transportIndicator.text('Polling').removeClass('realtime');\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle state update from server\r\n         *\r\n         * @param {Object} data State update data\r\n         */\r\n        handleStateUpdate: function(data) {\r\n            if (data.question) {\r\n                this.updateQuestionDisplay({\r\n                    success: true,\r\n                    status: data.status,\r\n                    question: data.question\r\n                });\r\n            }\r\n\r\n            if (data.status === STATE.COMPLETED) {\r\n                this.handleSessionCompleted(data);\r\n            } else if (data.status === STATE.PAUSED) {\r\n                this.handleSessionPaused(data);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle question broadcast from server\r\n         *\r\n         * @param {Object} data Question data\r\n         */\r\n        handleQuestionBroadcast: function(data) {\r\n            this.currentQuestion = data.question;\r\n            this.displayQuestion(data.question);\r\n            this.updateTimer(data.question.timeremaining);\r\n        },\r\n\r\n        /**\r\n         * Handle session started event\r\n         *\r\n         * @param {Object} data Session data\r\n         */\r\n        handleSessionStarted: function(data) {\r\n            $('#quiz-status').removeClass('alert-warning').addClass('alert-info');\r\n            if (data.question) {\r\n                this.currentQuestion = data.question;\r\n                this.displayQuestion(data.question);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle session paused event\r\n         *\r\n         * @param {Object} data Session data\r\n         */\r\n        handleSessionPaused: function(data) {\r\n            var container = $('#question-container');\r\n            container.find('.submit-answer-btn').prop('disabled', true);\r\n            this.showNotification('warning', 'Quiz paused by instructor');\r\n\r\n            // Show paused overlay\r\n            if ($('.paused-overlay').length === 0) {\r\n                container.append('<div class=\"paused-overlay\"><span>Quiz Paused</span></div>');\r\n            }\r\n\r\n            // Store remaining time if provided\r\n            if (data.timerRemaining !== undefined) {\r\n                this.pausedTimerRemaining = data.timerRemaining;\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle session resumed event\r\n         *\r\n         * @param {Object} data Session data\r\n         */\r\n        handleSessionResumed: function(data) {\r\n            var container = $('#question-container');\r\n            container.find('.submit-answer-btn').prop('disabled', false);\r\n            container.find('.paused-overlay').remove();\r\n            this.showNotification('info', 'Quiz resumed');\r\n\r\n            // Restore timer\r\n            if (data.timerRemaining !== undefined) {\r\n                this.updateTimer(data.timerRemaining);\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Handle session completed event\r\n         *\r\n         * @param {Object} data Session data\r\n         */\r\n        handleSessionCompleted: function(data) {\r\n            var container = $('#question-container');\r\n            var statusDiv = $('#quiz-status');\r\n\r\n            statusDiv.removeClass('alert-info').addClass('alert-success');\r\n\r\n            var scoreText = data.score !== undefined ? ' Your score: ' + data.score : '';\r\n            statusDiv.html(this.strings.quizcompleted + scoreText);\r\n\r\n            container.html('<div class=\"alert alert-success\">' +\r\n                '<h4>' + this.strings.quizcompleted + '</h4>' +\r\n                (data.score !== undefined ? '<p>Your score: ' + data.score + '</p>' : '') +\r\n                '</div>');\r\n\r\n            this.stopPolling();\r\n            ConnectionManager.disconnect();\r\n        },\r\n\r\n        /**\r\n         * Handle reconnection\r\n         */\r\n        handleReconnected: function() {\r\n            this.isOnline = true;\r\n            this.updateOfflineIndicator();\r\n            this.showNotification('success', this.strings.connectionrestored);\r\n\r\n            // Request current state\r\n            ConnectionManager.send('getstatus', {\r\n                sessionid: this.sessionId\r\n            }).then(function(response) {\r\n                if (response.success && response.session) {\r\n                    this.handleStateUpdate(response.session);\r\n                }\r\n                return null;\r\n            }.bind(this)).catch(function() {\r\n                // Ignore errors, state will sync on next update\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Handle disconnection\r\n         */\r\n        handleDisconnected: function() {\r\n            this.isOnline = false;\r\n            this.updateOfflineIndicator();\r\n        },\r\n\r\n        /**\r\n         * Handle cached response submitted\r\n         *\r\n         * @param {Object} data Submission data\r\n         */\r\n        handleCachedResponseSubmitted: function(data) {\r\n            this.showNotification('success', 'Cached response submitted: ' + data.id);\r\n            this.updateOfflineIndicator();\r\n        },\r\n\r\n        /**\r\n         * Submit answer with optimistic UI update\r\n         */\r\n        submitAnswer: function() {\r\n            var self = this;\r\n            var selectedAnswer = $('input[name=\"answer\"]:checked').val();\r\n\r\n            if (!selectedAnswer) {\r\n                Notification.alert(this.strings.error, this.strings.selectanswer);\r\n                return;\r\n            }\r\n\r\n            if (!this.currentQuestion) {\r\n                return;\r\n            }\r\n\r\n            var questionId = this.currentQuestion.id;\r\n            var clientTimestamp = Date.now();\r\n\r\n            // Optimistic UI update (Requirement 8.5)\r\n            this.showOptimisticSubmission();\r\n\r\n            // Disable submit button to prevent double submission\r\n            $('.submit-answer-btn').prop('disabled', true);\r\n\r\n            // Check if we're online\r\n            if (!this.isOnline || !ConnectionManager.getStatus().connected) {\r\n                // Store in cache for later submission (Requirement 4.5)\r\n                this.submitOffline(questionId, selectedAnswer, clientTimestamp);\r\n                return;\r\n            }\r\n\r\n            // Submit via connection manager\r\n            ConnectionManager.send('submitanswer', {\r\n                sessionid: this.sessionId,\r\n                questionid: questionId,\r\n                answer: selectedAnswer,\r\n                clienttimestamp: clientTimestamp\r\n            }).then(function(response) {\r\n                self.handleSubmissionResponse(response);\r\n                return null;\r\n            }).catch(function(error) {\r\n                // Network error - cache the response\r\n                self.submitOffline(questionId, selectedAnswer, clientTimestamp);\r\n                // eslint-disable-next-line no-console\r\n                console.warn('Submission failed, cached offline:', error);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Show optimistic UI update before server confirmation (Requirement 8.5)\r\n         */\r\n        showOptimisticSubmission: function() {\r\n            var container = $('#question-container');\r\n\r\n            // Add submitting state\r\n            container.addClass('submitting');\r\n\r\n            // Show optimistic feedback\r\n            var feedbackDiv = container.find('.optimistic-feedback');\r\n            if (feedbackDiv.length === 0) {\r\n                feedbackDiv = $('<div class=\"optimistic-feedback\">' +\r\n                    '<span class=\"spinner\"></span> Submitting...' +\r\n                    '</div>');\r\n                container.find('.submit-answer-btn').after(feedbackDiv);\r\n            }\r\n            feedbackDiv.show();\r\n        },\r\n\r\n        /**\r\n         * Submit response offline\r\n         *\r\n         * @param {number} questionId Question ID\r\n         * @param {string} answer Selected answer\r\n         * @param {number} clientTimestamp Client timestamp\r\n         */\r\n        submitOffline: function(questionId, answer, clientTimestamp) {\r\n            var self = this;\r\n\r\n            // Show offline submission feedback\r\n            this.showNotification('info', this.strings.submittingoffline);\r\n\r\n            ClientCache.storeResponse({\r\n                sessionId: this.sessionId,\r\n                questionId: questionId,\r\n                answer: answer,\r\n                clientTimestamp: clientTimestamp\r\n            }).then(function() {\r\n                self.showOfflineSubmissionConfirmation();\r\n                self.updateOfflineIndicator();\r\n                return null;\r\n            }).catch(function(error) {\r\n                // eslint-disable-next-line no-console\r\n                console.error('Failed to cache response:', error);\r\n                Notification.exception({message: 'Failed to save response offline'});\r\n                $('.submit-answer-btn').prop('disabled', false);\r\n            });\r\n        },\r\n\r\n        /**\r\n         * Show offline submission confirmation\r\n         */\r\n        showOfflineSubmissionConfirmation: function() {\r\n            var container = $('#question-container');\r\n            container.removeClass('submitting');\r\n            container.find('.optimistic-feedback').remove();\r\n\r\n            container.html(\r\n                '<div class=\"alert alert-info\">' +\r\n                '<h4>' + this.strings.answersubmitted + '</h4>' +\r\n                '<p>' + this.strings.offline + '</p>' +\r\n                '<p>' + this.strings.waitingnextquestion + '</p>' +\r\n                '</div>'\r\n            );\r\n        },\r\n\r\n        /**\r\n         * Handle submission response from server\r\n         *\r\n         * @param {Object} response Server response\r\n         */\r\n        handleSubmissionResponse: function(response) {\r\n            var container = $('#question-container');\r\n            container.removeClass('submitting');\r\n            container.find('.optimistic-feedback').remove();\r\n\r\n            if (response.success) {\r\n                var message = response.iscorrect ? this.strings.correct : this.strings.incorrect;\r\n                var alertClass = response.iscorrect ? 'success' : 'warning';\r\n\r\n                var html = '<div class=\"alert alert-' + alertClass + '\">' +\r\n                    '<h4>' + message + '</h4>';\r\n\r\n                if (response.correctanswer) {\r\n                    html += '<p>' + this.strings.correctanswer + ': ' + response.correctanswer + '</p>';\r\n                }\r\n\r\n                if (response.islate) {\r\n                    html += '<p class=\"text-muted\"><em>Response recorded as late</em></p>';\r\n                }\r\n\r\n                html += '<p>' + this.strings.waitingnextquestion + '</p>' +\r\n                    '</div>';\r\n\r\n                container.html(html);\r\n\r\n                // Visual confirmation (Requirement 2.4)\r\n                this.showVisualConfirmation(response.iscorrect);\r\n            } else {\r\n                // Handle error\r\n                if (response.error && response.error.indexOf('Duplicate') !== -1) {\r\n                    container.html('<div class=\"alert alert-info\">' + this.strings.alreadyanswered + '</div>');\r\n                } else {\r\n                    Notification.exception({message: response.error || 'Error submitting answer'});\r\n                    $('.submit-answer-btn').prop('disabled', false);\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Show visual confirmation of answer submission (Requirement 2.4)\r\n         *\r\n         * @param {boolean} isCorrect Whether the answer was correct\r\n         */\r\n        showVisualConfirmation: function(isCorrect) {\r\n            var confirmationClass = isCorrect ? 'confirmation-correct' : 'confirmation-incorrect';\r\n\r\n            // Create confirmation overlay\r\n            var overlay = $('<div class=\"submission-confirmation ' + confirmationClass + '\">' +\r\n                '<span class=\"confirmation-icon\">' + (isCorrect ? '✓' : '✗') + '</span>' +\r\n                '</div>');\r\n\r\n            $('body').append(overlay);\r\n\r\n            // Animate and remove\r\n            setTimeout(function() {\r\n                overlay.addClass('fade-out');\r\n                setTimeout(function() {\r\n                    overlay.remove();\r\n                }, 300);\r\n            }, 500);\r\n        },\r\n\r\n        /**\r\n         * Show notification message\r\n         *\r\n         * @param {string} type Notification type (success, info, warning, error)\r\n         * @param {string} message Message to display\r\n         */\r\n        showNotification: function(type, message) {\r\n            var notificationArea = $('#quiz-notifications');\r\n            if (notificationArea.length === 0) {\r\n                notificationArea = $('<div id=\"quiz-notifications\" class=\"quiz-notifications\"></div>');\r\n                $('#quiz-status').before(notificationArea);\r\n            }\r\n\r\n            var alertClass = 'alert-' + (type === 'error' ? 'danger' : type);\r\n            var notification = $('<div class=\"alert ' + alertClass + ' notification-toast\">' + message + '</div>');\r\n\r\n            notificationArea.append(notification);\r\n\r\n            // Auto-dismiss after 3 seconds\r\n            setTimeout(function() {\r\n                notification.fadeOut(function() {\r\n                    $(this).remove();\r\n                });\r\n            }, 3000);\r\n        },\r\n\r\n        /**\r\n         * Update question display\r\n         *\r\n         * @param {Object} response Server response with question data\r\n         */\r\n        updateQuestionDisplay: function(response) {\r\n            var container = $('#question-container');\r\n            var statusDiv = $('#quiz-status');\r\n\r\n            if (!response.success || response.status !== 'active') {\r\n                container.html('');\r\n                if (response.status === 'completed') {\r\n                    statusDiv.removeClass('alert-info').addClass('alert-success');\r\n                    statusDiv.html(this.strings.quizcompleted);\r\n                    this.stopPolling();\r\n                } else if (response.status === 'paused') {\r\n                    statusDiv.html('Quiz is paused');\r\n                } else {\r\n                    statusDiv.html(this.strings.waitingnextquestion);\r\n                }\r\n                return;\r\n            }\r\n\r\n            var question = response.question;\r\n\r\n            if (!question) {\r\n                container.html('<p>' + this.strings.waitingnextquestion + '</p>');\r\n                return;\r\n            }\r\n\r\n            // Check if this is a new question\r\n            if (this.currentQuestion === null || this.currentQuestion.id !== question.id) {\r\n                this.currentQuestion = question;\r\n                this.displayQuestion(question);\r\n            }\r\n\r\n            // Update timer\r\n            this.updateTimer(question.timeremaining);\r\n\r\n            // Update question number\r\n            statusDiv.html('Question ' + question.number + ' of ' + question.total);\r\n        },\r\n\r\n        /**\r\n         * Display a question\r\n         *\r\n         * @param {Object} question Question data\r\n         */\r\n        displayQuestion: function(question) {\r\n            var html = '<div class=\"question-text mb-4\">';\r\n            html += '<h4>' + question.text + '</h4>';\r\n            html += '</div>';\r\n\r\n            if (question.answered) {\r\n                html += '<div class=\"alert alert-info\">' + this.strings.alreadyanswered + '</div>';\r\n            } else {\r\n                html += '<form id=\"answer-form\">';\r\n                html += '<div class=\"question-options\">';\r\n\r\n                for (var i = 0; i < question.options.length; i++) {\r\n                    var option = question.options[i];\r\n                    html += '<div class=\"quiz-option\" data-option=\"' + option.key + '\">';\r\n                    html += '<label class=\"quiz-option-label\">';\r\n                    html += '<input type=\"radio\" name=\"answer\" value=\"' + option.key + '\" required> ';\r\n                    html += '<span class=\"option-key\">' + option.key + '</span>';\r\n                    html += '<span class=\"option-text\">' + option.text + '</span>';\r\n                    html += '</label>';\r\n                    html += '</div>';\r\n                }\r\n\r\n                html += '</div>';\r\n                html += '<button type=\"button\" class=\"btn btn-primary btn-lg submit-answer-btn mt-3\">';\r\n                html += this.strings.answersubmitted ? 'Submit Answer' : 'Submit Answer';\r\n                html += '</button>';\r\n                html += '</form>';\r\n            }\r\n\r\n            $('#question-container').html(html);\r\n        },\r\n\r\n        /**\r\n         * Update timer display\r\n         *\r\n         * @param {number} seconds Seconds remaining\r\n         */\r\n        updateTimer: function(seconds) {\r\n            var display = $('#timer-display');\r\n\r\n            if (seconds <= 0) {\r\n                display.text('0:00');\r\n                display.removeClass('warning').addClass('danger');\r\n                return;\r\n            }\r\n\r\n            var minutes = Math.floor(seconds / 60);\r\n            var secs = seconds % 60;\r\n            var timeStr = minutes + ':' + (secs < 10 ? '0' : '') + secs;\r\n\r\n            display.text(timeStr);\r\n\r\n            if (seconds <= 10) {\r\n                display.removeClass('warning').addClass('danger');\r\n            } else if (seconds <= 30) {\r\n                display.removeClass('danger').addClass('warning');\r\n            } else {\r\n                display.removeClass('warning danger');\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Start legacy polling (fallback when connection manager fails)\r\n         *\r\n         * @param {number} interval Polling interval\r\n         */\r\n        startLegacyPolling: function(interval) {\r\n            var self = this;\r\n\r\n            this.pollingTimer = setInterval(function() {\r\n                self.getCurrentQuestion();\r\n            }, interval || 2000);\r\n\r\n            this.getCurrentQuestion();\r\n        },\r\n\r\n        /**\r\n         * Get current question via legacy AJAX\r\n         */\r\n        getCurrentQuestion: function() {\r\n            var self = this;\r\n\r\n            Ajax.call([{\r\n                methodname: 'mod_classengage_get_current_question',\r\n                args: {sessionid: this.sessionId},\r\n                done: function(response) {\r\n                    self.updateQuestionDisplay(response);\r\n                },\r\n                fail: function() {\r\n                    // Fallback to direct AJAX call\r\n                    $.ajax({\r\n                        url: M.cfg.wwwroot + '/mod/classengage/ajax.php',\r\n                        method: 'POST',\r\n                        data: {\r\n                            action: 'getcurrent',\r\n                            sessionid: self.sessionId,\r\n                            sesskey: M.cfg.sesskey\r\n                        },\r\n                        dataType: 'json',\r\n                        success: function(response) {\r\n                            self.updateQuestionDisplay(response);\r\n                        }\r\n                    });\r\n                }\r\n            }]);\r\n        },\r\n\r\n        /**\r\n         * Stop polling\r\n         */\r\n        stopPolling: function() {\r\n            if (this.pollingTimer) {\r\n                clearInterval(this.pollingTimer);\r\n                this.pollingTimer = null;\r\n            }\r\n            if (this.countdownTimer) {\r\n                clearInterval(this.countdownTimer);\r\n                this.countdownTimer = null;\r\n            }\r\n        }\r\n    };\r\n\r\n    return {\r\n        /**\r\n         * Initialize the quiz module\r\n         *\r\n         * @param {number} cmid Course module ID\r\n         * @param {number} sessionid Session ID\r\n         * @param {number} pollinginterval Polling interval\r\n         * @return {Promise} Resolves when initialized\r\n         */\r\n        init: function(cmid, sessionid, pollinginterval) {\r\n            return Quiz.init(cmid, sessionid, pollinginterval);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Ajax","Notification","Str","ConnectionManager","ClientCache","STATE","Quiz","cmid","sessionId","currentQuestion","pollingTimer","countdownTimer","isOnline","pendingSubmission","strings","init","sessionid","pollinginterval","self","this","loadStrings","then","maxRetries","retryDelay","setConnectionManager","getInstance","pollInterval","setupEventHandlers","setupConnectionHandlers","setupOfflineIndicator","document","on","submitAnswer","e","preventDefault","find","prop","addClass","siblings","removeClass","catch","error","console","startLegacyPolling","get_strings","key","component","answersubmitted","correct","incorrect","correctanswer","waitingnextquestion","quizcompleted","alreadyanswered","selectanswer","offline","reconnecting","connectionrestored","submittingoffline","pendingsubmissions","data","handleConnectionStatusChange","handleStateUpdate","handleQuestionBroadcast","handleSessionStarted","handleSessionPaused","handleSessionResumed","handleSessionCompleted","updateTimer","remaining","handleReconnected","handleDisconnected","handleCachedResponseSubmitted","showNotification","count","successCount","results","filter","r","success","length","indicator","after","window","addEventListener","handleOnlineStatusChange","navigator","onLine","updateOfflineIndicator","online","reconnect","status","transport","STATUS","CONNECTED","updateTransportIndicator","RECONNECTING","showReconnectingIndicator","DISCONNECTED","textSpan","pendingSpan","hide","text","show","stats","getStats","pending","transportIndicator","append","TRANSPORT","SSE","POLLING","question","updateQuestionDisplay","displayQuestion","timeremaining","container","undefined","timerRemaining","pausedTimerRemaining","remove","statusDiv","scoreText","score","html","stopPolling","disconnect","send","response","session","bind","id","selectedAnswer","val","questionId","clientTimestamp","Date","now","showOptimisticSubmission","getStatus","connected","questionid","answer","clienttimestamp","handleSubmissionResponse","submitOffline","warn","alert","feedbackDiv","storeResponse","showOfflineSubmissionConfirmation","exception","message","iscorrect","islate","showVisualConfirmation","indexOf","isCorrect","overlay","setTimeout","type","notificationArea","before","notification","fadeOut","number","total","answered","i","options","option","seconds","display","secs","timeStr","Math","floor","interval","setInterval","getCurrentQuestion","call","methodname","args","done","fail","ajax","url","M","cfg","wwwroot","method","action","sesskey","dataType","clearInterval"],"mappings":"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"}