define("mod_classengage/generator_wizard",["jquery","core/modal_factory","core/modal_events","core/templates","core/ajax","core/notification","core/str"],(function($,ModalFactory,ModalEvents,Templates,Ajax,Notification,Str){var GeneratorWizard={modal:null,cmid:null,slideid:null,docid:null,pages:[],init:function(cmid){this.cmid=cmid,$(document).on("click",'[data-action="open-generator"]',function(e){e.preventDefault();var btn=$(e.currentTarget);this.slideid=btn.data("slideid"),this.openWizard()}.bind(this))},openWizard:function(){var self=this;ModalFactory.create({type:ModalFactory.types.DEFAULT,large:!0}).then((function(modal){self.modal=modal,Str.get_string("generatefromdocument","mod_classengage").then((function(title){modal.setTitle(title)})),Templates.render("mod_classengage/generator_wizard",{numquestions_options:[1,2,3,4,5,6,7,8,9,10,15,20]}).then((function(html,js){modal.setBody(html),Templates.runTemplateJS(js)})),Templates.render("mod_classengage/generator_wizard_footer",{}).then((function(html,js){modal.setFooter(html),Templates.runTemplateJS(js)})),modal.show(),self.inspectDocument();var root=modal.getRoot();root.on("change","#id_pagerange",(function(){self.updateSelectionFromRange($(this).val())})),root.on("change","#select-all-slides",(function(){var checked=$(this).is(":checked");root.find(".slide-toggle").prop("checked",checked)})),root.on("change","#select-all-images",(function(){var checked=$(this).is(":checked");root.find(".image-toggle").prop("checked",checked)})),root.on("click","#btn-generate-confirm",(function(){self.triggerGeneration()})),root.on("click",'[data-action="cancel"]',(function(){self.modal.hide(),$("#generator-floater").remove()})),root.on("click",".show-more-text",(function(e){e.preventDefault();var link=$(this);alert(link.data("fulltext"))})),root.on("change","#id_difficulty, #id_cognitive, #id_numquestions",(function(){self.checkDistributionVisibility()})),root.on("input",".dist-input",(function(){self.validateDistribution()}))})).fail(Notification.exception)},inspectDocument:function(){var self=this;Ajax.call([{methodname:"mod_classengage_inspect_document",args:{}}]),$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",data:{action:"inspect",slideid:self.slideid,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success?(self.docid=response.docid,self.pages=response.pages,self.renderPages()):self.modal.setBody('<div class="alert alert-danger">'+response.error+"</div>")},error:function(){self.modal.setBody('<div class="alert alert-danger">Network error during inspection.</div>')}})},renderPages:function(){var self=this,container=self.modal.getRoot().find("#slides-container");container.empty();this.pages.forEach((function(page){var shorttext=page.text.replace(/<[^>]+>/g,"").substring(0,100),images=[];page.images&&page.images.forEach((function(img){images.push({source:img.source,safe_source:img.source,mediaType:img.mediaType,data:img.data})})),self.modal.getRoot().find("#slides-container").append(Templates.render("mod_classengage/generator_slide_row",{pagenum:page.page,shorttext:shorttext,fulltext:page.text,hasmore:page.text.length>100,images:images}))}));var promises=[];this.pages.forEach((function(page){var shorttext=page.text.replace(/<[^>]+>/g,"").substring(0,100),images=[];page.images&&page.images.forEach((function(img){images.push({imageId:img.imageId||img.source,source:img.source,url:img.url,label:img.label,mediaType:img.mediaType,data:img.data})})),promises.push(Templates.render("mod_classengage/generator_slide_row",{pagenum:page.page,shorttext:shorttext,fulltext:page.text,hasmore:page.text.length>100,images:images}))})),$.when.apply($,promises).done((function(){container.empty(),self.modal.getRoot().find("#generator-loading").addClass("d-none"),self.modal.getRoot().find("#generator-content").removeClass("d-none"),self.modal.getRoot().find("#btn-generate-confirm").prop("disabled",!1);for(var i=0;i<promises.length;i++){var result=promises.length>1?arguments[i]:arguments;container.append(result[0]),Templates.runTemplateJS(result[1])}}))},checkDistributionVisibility:function(){var root=this.modal.getRoot(),diff=root.find("#id_difficulty").val(),bloom=root.find("#id_cognitive").val(),num=parseInt(root.find("#id_numquestions").val()),showPanel=!1;"mixed"===diff?(root.find("#difficulty-dist").removeClass("d-none").addClass("d-block"),showPanel=!0,this.getSum("difficulty")!==num&&this.distributeEvenly("difficulty",num)):root.find("#difficulty-dist").removeClass("d-block").addClass("d-none"),"mixed"===bloom?(root.find("#cognitive-dist").removeClass("d-none").addClass("d-block"),showPanel=!0,this.getSum("bloom")!==num&&this.distributeEvenly("bloom",num)):root.find("#cognitive-dist").removeClass("d-block").addClass("d-none"),showPanel?root.find("#advanced-distribution-panel").removeClass("d-none"):root.find("#advanced-distribution-panel").addClass("d-none"),this.validateDistribution()},getSum:function(type){var sum=0;return this.modal.getRoot().find('.dist-input[data-type="'+type+'"]').each((function(){sum+=parseInt($(this).val())||0})),sum},distributeEvenly:function(type,total){var inputs=this.modal.getRoot().find('.dist-input[data-type="'+type+'"]'),count=inputs.length,base=Math.floor(total/count),remainder=total%count;inputs.each((function(index){var val=base+(index<remainder?1:0);$(this).val(val)}))},validateDistribution:function(){var root=this.modal.getRoot(),totalTarget=parseInt(root.find("#id_numquestions").val()),valid=!0;if(root.find("#advanced-distribution-panel").hasClass("d-none"))return root.find("#btn-generate-confirm").prop("disabled",!1),!0;if(!root.find("#difficulty-dist").hasClass("d-none")){var diffSum=this.getSum("difficulty");diffSum!==totalTarget?(root.find("#diff-validation-msg").removeClass("d-none").text("Sum: "+diffSum+" / "+totalTarget),valid=!1):root.find("#diff-validation-msg").addClass("d-none")}if(!root.find("#cognitive-dist").hasClass("d-none")){var bloomSum=this.getSum("bloom");bloomSum!==totalTarget?(root.find("#bloom-validation-msg").removeClass("d-none").text("Sum: "+bloomSum+" / "+totalTarget),valid=!1):root.find("#bloom-validation-msg").addClass("d-none")}return root.find("#btn-generate-confirm").prop("disabled",!valid),valid},updateSelectionFromRange:function(rangeStr){if(rangeStr){var root=this.modal.getRoot();root.find(".slide-toggle").prop("checked",!1),rangeStr.split(",").forEach((function(part){var bounds=part.trim().split("-");if(2===bounds.length)for(var start=parseInt(bounds[0]),end=parseInt(bounds[1]),i=start;i<=end;i++)root.find('.slide-row[data-page="'+i+'"] .slide-toggle').prop("checked",!0);else if(1===bounds.length&&""!==bounds[0]){var p=parseInt(bounds[0]);root.find('.slide-row[data-page="'+p+'"] .slide-toggle').prop("checked",!0)}}))}},triggerGeneration:function(){var self=this,root=self.modal.getRoot(),numQuestions=parseInt(root.find("#id_numquestions").val()),difficulty=root.find("#id_difficulty").val(),bloomLevel=root.find("#id_cognitive").val(),difficultyDistribution=null,bloomDistribution=null;"mixed"===difficulty&&(difficultyDistribution={},root.find('.dist-input[data-type="difficulty"]').each((function(){difficultyDistribution[$(this).data("key")]=parseInt($(this).val())||0}))),"mixed"===bloomLevel&&(bloomDistribution={},root.find('.dist-input[data-type="bloom"]').each((function(){bloomDistribution[$(this).data("key")]=parseInt($(this).val())||0})));var includeSlides=[];root.find(".slide-toggle:checked").each((function(){var row=$(this).closest(".slide-row");includeSlides.push(row.data("page"))}));var includeImages=[];root.find(".image-toggle:checked").each((function(){var imageId=$(this).data("imageid");if(imageId)includeImages.push(imageId);else{var source=$(this).data("source");source&&includeImages.push(source)}}));var options={numQuestions:numQuestions,difficulty:difficulty,bloomLevel:bloomLevel,includeSlides:includeSlides,includeImages:includeImages};difficultyDistribution&&(options.difficultyDistribution=difficultyDistribution),bloomDistribution&&(options.bloomDistribution=bloomDistribution),root.find("#btn-generate-confirm").prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Initializing...'),root.find("#generator-content").addClass("d-none"),root.find("#generator-progress").removeClass("d-none"),self.modal.getFooter().find("#btn-generate-confirm").hide(),self.updateProgress&&self.updateProgress(0,"Sending request..."),root.off("click","#btn-minimize-progress").on("click","#btn-minimize-progress",(function(){self.minimizeModal()})),$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",type:"POST",data:{action:"generate_from_options",slideid:self.slideid,docid:self.docid,options:JSON.stringify(options),sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response.success&&"running"===response.status?(self.updateProgress(5,"Job queued..."),self.pollStatus(0)):response.success&&"completed"===response.status?(self.updateProgress(100,"Done!"),self.showSuccess(response)):self.showError(response.error||"Unknown error starting generation")},error:function(){self.showError("Network error starting generation.")}})},updateProgress:function(percent,statusText){var root=this.modal.getRoot(),bar=root.find("#progress-bar");bar.css("width",percent+"%"),bar.text(percent+"%"),bar.attr("aria-valuenow",percent),statusText&&(root.find("#progress-status-text").text(statusText),percent<20?root.find("#progress-detail").text("Initializing NLP Engine..."):percent<50?root.find("#progress-detail").text("Analyzing content..."):percent<80?root.find("#progress-detail").text("Generating questions..."):percent<100&&root.find("#progress-detail").text("Finalizing..."))},minimizeModal:function(){var self=this;this.modal.hide(),0===$("#generator-floater").length&&($("body").append('<div id="generator-floater" style="position: fixed; bottom: 20px; right: 20px; z-index: 1050; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;">  <button class="btn btn-primary rounded-pill px-4 py-2 font-weight-bold">    <i class="fa fa-spinner fa-spin mr-2"></i> Generating <span id="floater-percent">0%</span>  </button></div>'),$("#generator-floater").on("click",(function(){self.modal.show(),$(this).hide()})));var percent=this.modal.getRoot().find("#progress-bar").attr("aria-valuenow")||0;$("#floater-percent").text(percent+"%"),$("#generator-floater").show()},pollStatus:function(retryCount){var self=this;self.modal.getRoot();$.ajax({url:M.cfg.wwwroot+"/mod/classengage/slides_api.php",type:"GET",data:{action:"nlpstatus",slideid:self.slideid,sesskey:M.cfg.sesskey,wait:!0},dataType:"json",timeout:4e4,success:function(response){if(response.success)if("completed"===response.status)self.updateProgress(100,"Generation Complete!"),self.showSuccess(response),$("#generator-floater").is(":visible")&&$("#generator-floater").html('<button class="btn btn-success rounded-pill px-4 py-2 font-weight-bold"><i class="fa fa-check"></i> Complete!</button>');else if("failed"===response.status)self.showError(response.error);else{var progress=response.progress||0;progress<10&&(progress=10),self.updateProgress(progress,"Generating..."),$("#floater-percent").text(progress+"%"),self.pollStatus(0)}else setTimeout((function(){self.pollStatus(retryCount)}),2e3)},error:function(xhr,status,error){retryCount>10?self.showError("Connection lost. Please refresh the page."):(console.warn("Poll failed, retrying...",status,error),setTimeout((function(){self.pollStatus(retryCount+1)}),2e3+1e3*retryCount))}})},showError:function(msg){var root=this.modal.getRoot();root.find("#progress-status-text").text("Error Failed"),root.find("#progress-bar").addClass("bg-danger").removeClass("progress-bar-animated"),root.find("#progress-detail").text(msg).addClass("text-danger"),alert("Error: "+msg)},showSuccess:function(response){var root=this.modal.getRoot(),summaryHtml='<div class="text-center p-4"><div class="text-success mb-3"><i class="fa fa-check-circle fa-4x"></i></div><h4>Questions Ready!</h4><p class="lead mb-3"><strong>'+response.count+"</strong> questions have been generated.</p>";if(summaryHtml+='<div class="mb-4">',response.provider){var providerText=response.provider;response.model&&(providerText+=" ("+response.model+")"),summaryHtml+='<span class="badge badge-dark mr-2"><i class="fa fa-robot mr-1"></i>'+providerText+"</span>"}if(response.duration){var mins=Math.floor(response.duration/60),secs=response.duration%60;summaryHtml+='<span class="text-muted small"><i class="fa fa-clock-o mr-1"></i>Generated in '+(mins>0?mins+"m "+secs+"s":secs+"s")+"</span>"}summaryHtml+="</div>",summaryHtml+='<div class="mt-3"><a href="'+(M.cfg.wwwroot+"/mod/classengage/questions.php?id="+this.cmid+"&highlight=slide_"+this.slideid)+'" class="btn btn-primary btn-lg"><i class="fa fa-eye mr-2"></i>View Questions</a></div></div>',root.find("#generator-progress").html(summaryHtml),root.find("#btn-minimize-progress").remove(),$("#generator-floater").remove()}};return GeneratorWizard}));

//# sourceMappingURL=generator_wizard.min.js.map