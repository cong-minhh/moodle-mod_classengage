/**
 * Connection Manager for real-time quiz communication
 *
 * SSE-only mode: Uses Server-Sent Events exclusively for real-time data.
 * api.php is used only for write operations (submit, pause, resume).
 * Polling fallback has been removed to reduce server resource consumption.
 *
 * Requirements: 6.1, 6.2, 6.3, 6.4, 6.5
 *
 * @module     mod_classengage/connection_manager
 * @copyright  2025 Danielle
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_classengage/connection_manager",["jquery"],(function($){var STATUS={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",RECONNECTING:"reconnecting"},TRANSPORT={SSE:"sse",POLLING:"polling",OFFLINE:"offline"},DEFAULTS={sseEndpoint:"/mod/classengage/sse_handler.php",apiEndpoint:"/mod/classengage/api.php",sseRetryAttempts:3,reconnectDelay:1e3,maxReconnectDelay:3e4,connectionTimeout:1e4};function ConnectionManager(){this.sessionId=null,this.connectionId=null,this.options=$.extend({},DEFAULTS),this.status=STATUS.DISCONNECTED,this.transport=TRANSPORT.OFFLINE,this.latency=0,this.eventSource=null,this.sseAttempts=0,this.pollingTimer=null,this.lastEventId=0,this.reconnectTimer=null,this.reconnectDelay=DEFAULTS.reconnectDelay,this.eventHandlers={},this.pendingRequests={}}ConnectionManager.prototype.init=function(sessionId,options){var self=this;return this.sessionId=sessionId,this.options=$.extend({},DEFAULTS,options||{}),this.connectionId=this.generateConnectionId(),self.status=STATUS.CONNECTING,self.emit("statuschange",{status:self.status}),self.connectSSE().catch((function(){return self.startPolling()}))},ConnectionManager.prototype.generateConnectionId=function(){return"conn_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},ConnectionManager.prototype.connectSSE=function(){var self=this;return new Promise((function(resolve,reject){if("undefined"==typeof EventSource)return self.sseAttempts=self.options.sseRetryAttempts,void reject(new Error("SSE not supported"));self.sseAttempts++;var url=M.cfg.wwwroot+self.options.sseEndpoint+"?sessionid="+self.sessionId+"&connectionid="+encodeURIComponent(self.connectionId)+"&lastEventId="+self.lastEventId;try{self.eventSource=new EventSource(url)}catch(e){return void(self.sseAttempts<self.options.sseRetryAttempts?setTimeout((function(){self.connectSSE().then(resolve).catch(reject)}),1e3):reject(new Error("SSE connection failed")))}var connectionTimeout=setTimeout((function(){self.status!==STATUS.CONNECTED&&(self.closeSSE(),self.sseAttempts<self.options.sseRetryAttempts?self.connectSSE().then(resolve).catch(reject):reject(new Error("SSE connection timeout")))}),self.options.connectionTimeout);self.eventSource.onopen=function(){},self.eventSource.onerror=function(){clearTimeout(connectionTimeout),self.closeSSE(),self.sseAttempts<self.options.sseRetryAttempts?setTimeout((function(){self.connectSSE().then(resolve).catch(reject)}),1e3):reject(new Error("SSE connection failed after "+self.sseAttempts+" attempts"))},self.eventSource.addEventListener("connected",(function(event){clearTimeout(connectionTimeout);var data=JSON.parse(event.data);self.connectionId=data.connectionid,self.status=STATUS.CONNECTED,self.transport=TRANSPORT.SSE,self.sseAttempts=0,self.reconnectDelay=DEFAULTS.reconnectDelay,self.lastEventId=parseInt(event.lastEventId)||0,self.emit("statuschange",{status:self.status,transport:self.transport}),self.emit("connected",data),resolve()})),self.registerSSEHandlers()}))},ConnectionManager.prototype.registerSSEHandlers=function(){var self=this;if(this.eventSource){["session_started","session_paused","session_resumed","session_completed","session_ended","question_broadcast","timer_sync","reconnect","stats_update","students_update"].forEach((function(eventType){self.eventSource.addEventListener(eventType,(function(event){if(self.lastEventId=parseInt(event.lastEventId)||self.lastEventId,event.data&&"undefined"!==event.data){var data;try{data=JSON.parse(event.data)}catch(e){return void console.error("SSE JSON parse error for event:",eventType,"data:",event.data,e)}self.emit(eventType,data),"reconnect"===eventType&&self.handleReconnectRequest(data),"session_completed"!==eventType&&"session_ended"!==eventType||self.disconnect()}else console.warn("SSE event received without valid data:",eventType,event)}))}))}},ConnectionManager.prototype.closeSSE=function(){this.eventSource&&(this.eventSource.close(),this.eventSource=null)},ConnectionManager.prototype.startPolling=function(){var self=this;return new Promise((function(resolve,reject){self.status=STATUS.DISCONNECTED,self.transport=TRANSPORT.OFFLINE,self.emit("statuschange",{status:self.status,transport:self.transport}),self.emit("connection_error",{message:"SSE connection required. Polling fallback has been removed.",reason:"sse_required"}),reject(new Error("SSE connection required. Please ensure your browser supports Server-Sent Events."))}))},ConnectionManager.prototype.stopPolling=function(){this.pollingTimer&&(clearInterval(this.pollingTimer),this.pollingTimer=null)},ConnectionManager.prototype.handleConnectionError=function(){this.status!==STATUS.DISCONNECTED&&(this.status=STATUS.RECONNECTING,this.emit("statuschange",{status:this.status}),this.emit("disconnected",{reason:"connection_error"}),this.scheduleReconnect())},ConnectionManager.prototype.handleReconnectRequest=function(){this.closeSSE(),this.stopPolling(),this.scheduleReconnect()},ConnectionManager.prototype.scheduleReconnect=function(){var self=this;this.reconnectTimer||(this.reconnectTimer=setTimeout((function(){self.reconnectTimer=null,self.reconnect()}),this.reconnectDelay),this.reconnectDelay=Math.min(2*this.reconnectDelay,this.options.maxReconnectDelay))},ConnectionManager.prototype.reconnect=function(){var self=this;return this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.closeSSE(),this.stopPolling(),this.status=STATUS.RECONNECTING,this.emit("statuschange",{status:this.status}),this.sseAttempts=0,self.connectSSE().then((function(){self.emit("reconnected",{transport:self.transport})})).catch((function(){return self.startPolling().then((function(){self.emit("reconnected",{transport:self.transport})})).catch((function(error){throw self.status=STATUS.DISCONNECTED,self.transport=TRANSPORT.OFFLINE,self.emit("statuschange",{status:self.status,transport:self.transport}),error}))}))},ConnectionManager.prototype.send=function(type,data){var self=this,startTime=Date.now(),requestId=this.generateConnectionId();this.pendingRequests[requestId]=startTime;var requestData=$.extend({action:type,sessionid:this.sessionId,connectionid:this.connectionId,sesskey:M.cfg.sesskey},data||{});return new Promise((function(resolve,reject){$.ajax({url:M.cfg.wwwroot+self.options.apiEndpoint,method:"POST",data:requestData,dataType:"json",timeout:self.options.connectionTimeout}).done((function(response){delete self.pendingRequests[requestId],self.latency=Date.now()-startTime,resolve(response)})).fail((function(xhr,status,error){delete self.pendingRequests[requestId],reject(new Error(error||"Request failed"))}))}))},ConnectionManager.prototype.on=function(event,callback){this.eventHandlers[event]||(this.eventHandlers[event]=[]),this.eventHandlers[event].push(callback)},ConnectionManager.prototype.off=function(event,callback){this.eventHandlers[event]&&(callback?this.eventHandlers[event]=this.eventHandlers[event].filter((function(cb){return cb!==callback})):delete this.eventHandlers[event])},ConnectionManager.prototype.emit=function(event,data){var handlers=this.eventHandlers[event];handlers&&handlers.forEach((function(callback){try{callback(data)}catch(e){console.error("Error in event handler for "+event+":",e)}}))},ConnectionManager.prototype.getStatus=function(){return{connected:this.status===STATUS.CONNECTED,status:this.status,transport:this.transport,latency:this.latency,connectionId:this.connectionId}},ConnectionManager.prototype.isConnected=function(){return this.status===STATUS.CONNECTED},ConnectionManager.prototype.getTransport=function(){return this.transport},ConnectionManager.prototype.disconnect=function(){this.closeSSE(),this.stopPolling(),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.status=STATUS.DISCONNECTED,this.transport=TRANSPORT.OFFLINE,this.emit("statuschange",{status:this.status,transport:this.transport}),this.emit("disconnected",{reason:"user_disconnect"})},ConnectionManager.STATUS=STATUS,ConnectionManager.TRANSPORT=TRANSPORT;var instance=null;return{getInstance:function(){return instance||(instance=new ConnectionManager),instance},init:function(sessionId,options){return this.getInstance().init(sessionId,options)},send:function(type,data){return this.getInstance().send(type,data)},on:function(event,callback){this.getInstance().on(event,callback)},off:function(event,callback){this.getInstance().off(event,callback)},getStatus:function(){return this.getInstance().getStatus()},reconnect:function(){return this.getInstance().reconnect()},disconnect:function(){this.getInstance().disconnect()},STATUS:STATUS,TRANSPORT:TRANSPORT}}));

//# sourceMappingURL=connection_manager.min.js.map